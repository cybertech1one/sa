<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Security Assessment Scheduler Pro - Enterprise Edition</title>
  
  <!-- Core Libraries - Updated Order -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary-color: #3b82f6;
      --primary-dark: #2563eb;
      --secondary-color: #8b5cf6;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --dark-color: #1e293b;
      --light-color: #f8fafc;
      --border-color: #e2e8f0;
      --text-muted: #64748b;
      --weekend-color: #fef3c7;
      --weekend-border: #fbbf24;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      background: #f0f4f8;
      color: var(--dark-color);
      min-height: 100vh;
      line-height: 1.6;
    }
    
    /* Enhanced Calendar Styles with Weekend Support */
    .calendar-container {
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.08);
      overflow: hidden;
      border: 1px solid var(--border-color);
    }
    
    .calendar-header {
      background: linear-gradient(135deg, var(--dark-color) 0%, #334155 100%);
      color: white;
      padding: 32px;
      text-align: center;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--border-color);
    }
    
    .calendar-day-header {
      background: #475569;
      color: white;
      padding: 18px 12px;
      text-align: center;
      font-weight: 700;
      font-size: 13px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    
    .calendar-day-header.weekend {
      background: #64748b;
      color: #fbbf24;
    }
    
    .calendar-day {
      background: white;
      min-height: 180px;
      padding: 14px;
      position: relative;
      border: 1px solid transparent;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      overflow: hidden;
    }
    
    .calendar-day.weekend {
      background: var(--weekend-color);
      border-color: var(--weekend-border);
    }
    
    .calendar-day.weekend::after {
      content: 'Weekend';
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 10px;
      color: #f59e0b;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.8);
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .calendar-day:hover {
      background: linear-gradient(to bottom, #ffffff, #f8fafc);
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      z-index: 10;
    }
    
    .calendar-day.other-month {
      background: #fafbfc;
      color: #a0aec0;
    }
    
    .calendar-day.today {
      background: linear-gradient(135deg, #ebf4ff, #dbeafe);
      border: 2px solid var(--primary-color);
      box-shadow: inset 0 0 0 1px var(--primary-color), 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    .day-number {
      font-weight: 800;
      margin-bottom: 10px;
      font-size: 18px;
      color: #2d3748;
    }
    
    .calendar-day.today .day-number {
      color: var(--primary-color);
    }
    
    /* Enhanced Yearly View */
    .yearly-container {
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.08);
      overflow: hidden;
      border: 1px solid var(--border-color);
      padding: 32px;
    }
    
    .yearly-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 24px;
      margin-top: 32px;
    }
    
    .month-card {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }
    
    .month-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.08);
      border-color: var(--primary-color);
    }
    
    .month-card-header {
      background: linear-gradient(135deg, #475569, #64748b);
      color: white;
      padding: 16px;
      text-align: center;
      font-weight: 700;
      font-size: 16px;
      letter-spacing: 0.5px;
    }
    
    .mini-calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #f1f5f9;
      padding: 1px;
    }
    
    .mini-day-header {
      background: #e2e8f0;
      color: #64748b;
      padding: 8px 4px;
      text-align: center;
      font-size: 10px;
      font-weight: 600;
    }
    
    .mini-day-header.weekend {
      background: #fef3c7;
      color: #f59e0b;
    }
    
    .mini-day {
      background: white;
      padding: 6px;
      text-align: center;
      font-size: 11px;
      min-height: 32px;
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .mini-day.weekend {
      background: #fffbeb;
    }
    
    .mini-day:hover {
      background: #f8fafc;
      z-index: 10;
    }
    
    .mini-day.has-assessments {
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .mini-day.has-critical {
      background: #fef2f2;
      color: #dc2626;
    }
    
    .assessment-dots {
      display: flex;
      justify-content: center;
      gap: 2px;
      margin-top: 2px;
    }
    
    .assessment-dot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
    }
    
    .dot-critical { background: #ef4444; }
    .dot-high { background: #f97316; }
    .dot-medium { background: #22c55e; }
    .dot-low { background: #3b82f6; }
    
    .assessment-item {
      background: linear-gradient(135deg, #4299e1, #3182ce);
      color: white;
      padding: 8px 10px;
      margin: 4px 0;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .assessment-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.1);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .assessment-item:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      z-index: 20;
    }
    
    .assessment-item:hover::before {
      opacity: 1;
    }
    
    .assessment-item.critical {
      background: linear-gradient(135deg, #fc8181, #e53e3e);
    }
    
    .assessment-item.high {
      background: linear-gradient(135deg, #f6ad55, #ed8936);
    }
    
    .assessment-item.medium {
      background: linear-gradient(135deg, #68d391, #38a169);
    }
    
    .assessment-item.low {
      background: linear-gradient(135deg, #63b3ed, #4299e1);
    }
    
    /* Enhanced Timeline Styles - Improved Design */
    .timeline-container {
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.08);
      overflow: hidden;
      border: 1px solid var(--border-color);
    }
    
    .timeline-wrapper {
      overflow-x: auto;
      overflow-y: visible;
      max-height: 85vh;
      position: relative;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
    }
    
    .timeline-wrapper::-webkit-scrollbar {
      height: 14px;
      width: 14px;
    }
    
    .timeline-wrapper::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }
    
    .timeline-wrapper::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
      border: 3px solid #f1f5f9;
    }
    
    .timeline-wrapper::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    .timeline-scroll-container {
      min-width: max-content;
      position: relative;
    }
    
    .timeline-grid {
      display: grid;
      grid-template-columns: 320px repeat(12, minmax(200px, 1fr));
      background: var(--border-color);
      gap: 1px;
      min-width: 2800px;
    }
    
    .timeline-cell {
      background: white;
      padding: 16px;
      position: relative;
      min-height: 100px;
      transition: all 0.2s ease;
      border-right: 1px solid #f3f4f6;
    }
    
    .timeline-cell:hover {
      background: #fafbfc;
    }
    
    /* Weekend columns in timeline */
    .timeline-weekend-overlay {
      position: absolute;
      top: 0;
      bottom: 0;
      background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 10px,
        rgba(251, 191, 36, 0.05) 10px,
        rgba(251, 191, 36, 0.05) 20px
      );
      pointer-events: none;
      z-index: 1;
    }
    
    .timeline-header {
      background: linear-gradient(135deg, #334155, #475569);
      color: white;
      font-weight: 700;
      text-align: center;
      padding: 24px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 14px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .timeline-month-header {
      position: relative;
    }
    
    .timeline-month-info {
      font-size: 10px;
      opacity: 0.8;
      margin-top: 4px;
      font-weight: normal;
    }
    
    .timeline-row-header {
      background: linear-gradient(135deg, #475569, #64748b);
      color: white;
      font-weight: 600;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      border-right: 3px solid #334155;
      position: sticky;
      left: 0;
      z-index: 50;
      min-width: 320px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
    }
    
    .timeline-row-header .target-name {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 6px;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.3;
    }
    
    .timeline-row-header .business-unit {
      font-size: 13px;
      opacity: 0.9;
      color: #e2e8f0;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .timeline-row-header .assessment-count {
      font-size: 11px;
      opacity: 0.8;
      color: #cbd5e1;
      margin-top: 4px;
      background: rgba(255,255,255,0.1);
      padding: 2px 8px;
      border-radius: 12px;
      display: inline-block;
    }
    
    .timeline-row-header .workload-indicator {
      margin-top: 8px;
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
      overflow: hidden;
    }
    
    .timeline-row-header .workload-bar {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #f59e0b, #ef4444);
      transition: width 0.3s ease;
    }
    
    .assessment-bar {
      position: absolute;
      border-radius: 10px;
      display: flex;
      align-items: center;
      padding: 0 14px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 2px solid rgba(255,255,255,0.3);
      backdrop-filter: blur(10px);
      height: 42px;
      min-width: 120px;
      z-index: 10;
    }
    
    .assessment-bar:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      z-index: 1000;
      border-color: rgba(255,255,255,0.5);
    }
    
    .assessment-bar .assessment-icon {
      margin-right: 8px;
      font-size: 14px;
    }
    
    .assessment-bar .assessment-text {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }
    
    .assessment-bar .duration-badge {
      margin-left: 8px;
      background: rgba(255,255,255,0.2);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
    }
    
    .priority-critical {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }
    
    .priority-high {
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: white;
    }
    
    .priority-medium {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
    }
    
    .priority-low {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
    }
    
    /* Enhanced Modal Styles */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(12px);
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal {
      background: white;
      border-radius: 24px;
      width: 95%;
      max-width: 1000px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* Enhanced Form Styles */
    .form-group {
      position: relative;
      margin-bottom: 28px;
    }
    
    .form-input {
      width: 100%;
      padding: 18px 20px;
      border: 2px solid var(--border-color);
      border-radius: 14px;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: white;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      transform: translateY(-1px);
    }
    
    .form-input:hover {
      border-color: #cbd5e1;
    }
    
    .form-input.error {
      border-color: var(--danger-color);
    }
    
    .form-label {
      display: flex;
      align-items: center;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--dark-color);
      font-size: 15px;
      letter-spacing: 0.3px;
    }
    
    .form-label i {
      margin-right: 10px;
      color: var(--primary-color);
      width: 20px;
    }
    
    .form-hint {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .form-hint i {
      font-size: 12px;
    }
    
    /* Weekend Exclusion Toggle */
    .weekend-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .weekend-toggle input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .weekend-toggle label {
      font-weight: 600;
      color: #475569;
      cursor: pointer;
      user-select: none;
    }
    
    /* Enhanced Button Styles */
    .btn {
      padding: 16px 32px;
      border-radius: 14px;
      font-weight: 700;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      letter-spacing: 0.3px;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to right, transparent, rgba(255,255,255,0.3), transparent);
      transform: translateX(-100%);
      transition: transform 0.6s;
    }
    
    .btn:hover::before {
      transform: translateX(100%);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }
    
    .btn-secondary {
      background: #f8fafc;
      color: #475569;
      border: 2px solid var(--border-color);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .btn-secondary:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--success-color), #059669);
      color: white;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--danger-color), #dc2626);
      color: white;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
    }
    
    /* Enhanced Stats Cards */
    .stats-card {
      background: white;
      border-radius: 20px;
      padding: 32px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
    }
    
    .stats-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }
    
    .stats-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.12);
    }
    
    .stats-icon {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-bottom: 20px;
    }
    
    /* Enhanced Floating Button */
    .floating-add-btn {
      position: fixed;
      bottom: 32px;
      right: 32px;
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      border: none;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100;
    }
    
    .floating-add-btn:hover {
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 12px 40px rgba(59, 130, 246, 0.5);
    }
    
    /* Enhanced Notification Styles */
    .notification {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 3000;
      padding: 18px 28px;
      border-radius: 14px;
      color: white;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 14px;
      transform: translateX(400px);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      backdrop-filter: blur(12px);
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background: linear-gradient(135deg, var(--success-color), #059669);
    }
    
    .notification.error {
      background: linear-gradient(135deg, var(--danger-color), #dc2626);
    }
    
    .notification.info {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    }
    
    /* Enhanced Export Grid */
    .export-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
    }
    
    .export-card {
      padding: 28px;
      border: 2px solid var(--border-color);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: white;
      position: relative;
      overflow: hidden;
    }
    
    .export-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .export-card:hover {
      border-color: var(--primary-color);
      transform: translateY(-3px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    }
    
    .export-card:hover::before {
      opacity: 0.05;
    }
    
    .export-icon {
      width: 72px;
      height: 72px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      font-size: 32px;
    }
    
    .export-card:hover .export-icon {
      transform: scale(1.1) rotate(5deg);
    }
    
    /* Loading Animation */
    .loading-spinner {
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      margin: 24px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Table Enhancements */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table thead {
      background: linear-gradient(135deg, #475569, #334155);
      color: white;
    }
    
    .data-table th {
      padding: 20px 24px;
      text-align: left;
      font-weight: 700;
      font-size: 14px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    
    .data-table td {
      padding: 18px 24px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .data-table tbody tr {
      transition: all 0.2s ease;
    }
    
    .data-table tbody tr:hover {
      background: #f8fafc;
      transform: translateX(4px);
    }
    
    /* Priority Badges */
    .priority-badge {
      padding: 8px 16px;
      border-radius: 24px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-block;
    }
    
    /* Chart Container */
    .chart-container {
      position: relative;
      height: 400px;
      padding: 20px;
    }
    
    /* Month indicator for timeline */
    .month-indicator {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0.1;
      background: repeating-linear-gradient(
        90deg,
        transparent,
        transparent 14.28%,
        #e2e8f0 14.28%,
        #e2e8f0 14.38%
      );
    }
    
    /* Timeline Legend */
    .timeline-legend {
      padding: 16px 24px;
      background: #f8fafc;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .timeline-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
    }
    
    .timeline-legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }
    
    /* Custom Field Styles */
    .custom-field-item {
      background: #f8fafc;
      border: 2px solid var(--border-color);
      border-radius: 14px;
      padding: 16px;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .custom-field-item:hover {
      border-color: var(--primary-color);
      background: white;
    }
    
    .custom-field-remove {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #fee2e2;
      color: #dc2626;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .custom-field-remove:hover {
      background: #fecaca;
      transform: scale(1.1);
    }
    
    /* Enhanced View Selector */
    .view-selector {
      display: flex;
      gap: 8px;
      background: #f1f5f9;
      padding: 6px;
      border-radius: 16px;
    }
    
    .view-btn {
      padding: 12px 24px;
      border-radius: 12px;
      background: transparent;
      border: none;
      color: #64748b;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .view-btn:hover {
      background: white;
      color: var(--primary-color);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .view-btn.active {
      background: white;
      color: var(--primary-color);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    /* Month Summary Card */
    .month-summary {
      background: #f8fafc;
      padding: 12px;
      margin-top: 8px;
      border-radius: 8px;
      font-size: 12px;
    }
    
    .month-summary-row {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
    }
    
    .month-summary-label {
      color: #64748b;
      font-weight: 600;
    }
    
    .month-summary-value {
      font-weight: 700;
      color: #1e293b;
    }
    
    /* Progress Indicator */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      transition: width 0.3s ease;
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 6px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 6px;
      transition: background 0.3s;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    /* Enhanced Reports Section */
    .report-metric {
      background: #f8fafc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .report-metric-title {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .report-metric-value {
      font-size: 28px;
      font-weight: 800;
      color: #1e293b;
    }
    
    .report-metric-subtitle {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 4px;
    }
    
    /* Duration Display */
    .duration-display {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #64748b;
    }
    
    .duration-display .business-days {
      font-weight: 700;
      color: #1e293b;
    }
    
    .duration-display .total-days {
      font-size: 12px;
      opacity: 0.8;
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
      .timeline-grid {
        grid-template-columns: 280px repeat(12, minmax(170px, 1fr));
        min-width: 2400px;
      }
      
      .export-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }
      
      .yearly-grid {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      }
    }
    
    @media (max-width: 768px) {
      .modal {
        width: 98%;
        margin: 12px;
        border-radius: 20px;
      }
      
      .floating-add-btn {
        width: 60px;
        height: 60px;
        font-size: 24px;
      }
      
      .stats-card {
        padding: 24px;
      }
      
      .btn {
        padding: 14px 24px;
        font-size: 14px;
      }
      
      .timeline-grid {
        grid-template-columns: 240px repeat(12, minmax(140px, 1fr));
        min-width: 2000px;
      }
      
      .view-selector {
        flex-wrap: wrap;
      }
      
      .view-btn {
        padding: 8px 16px;
        font-size: 14px;
      }
    }
    
    /* Print Styles */
    @media print {
      .no-print {
        display: none !important;
      }
      
      body {
        background: white;
      }
      
      .modal-backdrop {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Enhanced Header -->
    <header class="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 text-white shadow-2xl no-print">
      <div class="container mx-auto px-8">
        <div class="py-8">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-6">
              <div class="bg-white bg-opacity-10 backdrop-blur-sm p-4 rounded-2xl">
                <i class="fas fa-shield-halved text-4xl"></i>
              </div>
              <div>
                <h1 class="text-4xl font-bold tracking-tight bg-gradient-to-r from-white to-blue-200 bg-clip-text text-transparent">
                  Security Assessment Scheduler
                </h1>
                <p class="text-slate-300 text-lg mt-1">Enterprise Security Planning & Management Platform</p>
              </div>
            </div>
            <div class="flex items-center gap-6">
              <div class="relative">
                <select id="yearSelect" class="bg-slate-700 px-8 py-4 rounded-xl text-white border border-slate-600 appearance-none pr-14 font-semibold text-lg">
                  <option value="2024">2024</option>
                  <option value="2025">2025</option>
                  <option value="2026">2026</option>
                  <option value="2027">2027</option>
                  <option value="2028">2028</option>
                </select>
                <i class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-slate-300"></i>
              </div>
              <button onclick="SecurityScheduler.showAddAssessmentModal()" class="btn btn-primary text-lg shadow-xl">
                <i class="fas fa-plus-circle"></i>
                <span>New Assessment</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Enhanced Navigation -->
    <nav class="bg-white shadow-xl border-b-2 border-slate-100 sticky top-0 z-50 no-print">
      <div class="container mx-auto px-8">
        <div class="flex items-center justify-between py-6">
          <div class="view-selector">
            <button onclick="SecurityScheduler.changeView('calendar')" id="calendarViewBtn" class="view-btn active">
              <i class="fas fa-calendar-alt"></i>Monthly
            </button>
            <button onclick="SecurityScheduler.changeView('yearly')" id="yearlyViewBtn" class="view-btn">
              <i class="fas fa-calendar"></i>Yearly
            </button>
            <button onclick="SecurityScheduler.changeView('timeline')" id="timelineViewBtn" class="view-btn">
              <i class="fas fa-chart-gantt"></i>Timeline
            </button>
            <button onclick="SecurityScheduler.changeView('list')" id="listViewBtn" class="view-btn">
              <i class="fas fa-list-ul"></i>List
            </button>
            <button onclick="SecurityScheduler.changeView('analytics')" id="analyticsViewBtn" class="view-btn">
              <i class="fas fa-chart-line"></i>Analytics
            </button>
            <button onclick="SecurityScheduler.changeView('reports')" id="reportsViewBtn" class="view-btn">
              <i class="fas fa-file-contract"></i>Reports
            </button>
          </div>
          
          <div class="flex items-center gap-4">
            <div class="relative">
              <input type="text" id="searchInput" placeholder="Search assessments, targets, units..." 
                     class="pl-12 pr-6 py-3 border-2 border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-96 font-medium transition-all">
              <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
            </div>
            <button onclick="SecurityScheduler.showExportModal()" class="btn btn-success shadow-lg">
              <i class="fas fa-file-export"></i>Export
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-8 py-10">
      <!-- Calendar View -->
      <div id="calendarView" class="calendar-container">
        <div class="calendar-header">
          <div class="flex items-center justify-between">
            <button onclick="SecurityScheduler.previousMonth()" class="p-3 rounded-xl hover:bg-white hover:bg-opacity-20 transition-all">
              <i class="fas fa-chevron-left text-2xl"></i>
            </button>
            <div class="text-center">
              <h2 id="calendarTitle" class="text-3xl font-bold mb-2"></h2>
              <p class="text-slate-300 text-lg">Click any day to schedule an assessment</p>
            </div>
            <button onclick="SecurityScheduler.nextMonth()" class="p-3 rounded-xl hover:bg-white hover:bg-opacity-20 transition-all">
              <i class="fas fa-chevron-right text-2xl"></i>
            </button>
          </div>
        </div>
        <div class="calendar-grid" id="calendarGrid">
          <div class="calendar-day-header">Sunday</div>
          <div class="calendar-day-header">Monday</div>
          <div class="calendar-day-header">Tuesday</div>
          <div class="calendar-day-header">Wednesday</div>
          <div class="calendar-day-header">Thursday</div>
          <div class="calendar-day-header">Friday</div>
          <div class="calendar-day-header weekend">Saturday</div>
        </div>
      </div>

      <!-- Yearly View -->
      <div id="yearlyView" class="yearly-container hidden">
        <div class="text-center mb-8">
          <h2 class="text-3xl font-bold text-slate-800 mb-3">Year ${new Date().getFullYear()} Overview</h2>
          <p class="text-slate-600 text-lg">Complete annual security assessment calendar</p>
        </div>
        <div class="yearly-grid" id="yearlyGrid">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>

      <!-- Timeline View - Enhanced -->
      <div id="timelineView" class="timeline-container hidden">
        <div class="p-8 border-b bg-gradient-to-r from-slate-50 to-white">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-3xl font-bold text-slate-800 flex items-center gap-4">
                <i class="fas fa-chart-gantt text-blue-500"></i>
                Assessment Timeline
              </h2>
              <p class="text-slate-600 text-lg mt-2">Visual timeline showing all scheduled security assessments (business days only)</p>
            </div>
            <div class="flex items-center gap-6">
              <div class="flex items-center gap-4 text-sm font-semibold">
                <div class="flex items-center gap-2">
                  <div class="w-5 h-5 rounded-full bg-gradient-to-r from-red-500 to-red-600"></div>
                  <span>Critical</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-5 h-5 rounded-full bg-gradient-to-r from-orange-500 to-orange-600"></div>
                  <span>High</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-5 h-5 rounded-full bg-gradient-to-r from-green-500 to-green-600"></div>
                  <span>Medium</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-5 h-5 rounded-full bg-gradient-to-r from-blue-500 to-blue-600"></div>
                  <span>Low</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="timeline-legend">
          <div class="text-sm text-slate-600">
            <i class="fas fa-info-circle mr-2"></i>
            Scroll horizontally to view all months. Hover over assessments for details. Weekend days are excluded from duration calculations.
          </div>
          <div class="text-sm text-slate-600">
            <i class="fas fa-mouse-pointer mr-2"></i>
            Click on any assessment to view full details
          </div>
        </div>
        <div class="timeline-wrapper">
          <div class="timeline-scroll-container">
            <div id="timelineGrid" class="timeline-grid">
              <!-- Grid will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- List View -->
      <div id="listView" class="bg-white rounded-3xl shadow-2xl overflow-hidden hidden">
        <div class="p-8 border-b bg-gradient-to-r from-slate-50 to-white">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-3xl font-bold text-slate-800 flex items-center gap-4">
                <i class="fas fa-list-check text-green-500"></i>
                Assessment Management
              </h2>
              <p class="text-slate-600 text-lg mt-2">Comprehensive list of all security assessments</p>
            </div>
            <div class="flex items-center gap-4">
              <select id="filterPriority" class="form-input max-w-xs" onchange="SecurityScheduler.filterAssessments()">
                <option value="">All Priorities</option>
                <option value="critical">Critical Priority</option>
                <option value="high">High Priority</option>
                <option value="medium">Medium Priority</option>
                <option value="low">Low Priority</option>
              </select>
              <select id="filterType" class="form-input max-w-xs" onchange="SecurityScheduler.filterAssessments()">
                <option value="">All Types</option>
                <option value="External Pentest">External Penetration Test</option>
                <option value="Internal Pentest">Internal Penetration Test</option>
                <option value="Web Application">Web Application Security</option>
                <option value="Mobile Application">Mobile Application Security</option>
                <option value="Cloud Security">Cloud Security Assessment</option>
                <option value="Network Security">Network Security Assessment</option>
                <option value="Social Engineering">Social Engineering</option>
                <option value="Red Team">Red Team Exercise</option>
              </select>
            </div>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th><i class="fas fa-bullseye mr-3"></i>Target System</th>
                <th><i class="fas fa-cogs mr-3"></i>Assessment Type</th>
                <th><i class="fas fa-building mr-3"></i>Business Unit</th>
                <th><i class="fas fa-flag mr-3"></i>Priority</th>
                <th><i class="fas fa-play-circle mr-3"></i>Start Date</th>
                <th><i class="fas fa-stop-circle mr-3"></i>End Date</th>
                <th><i class="fas fa-clock mr-3"></i>Duration</th>
                <th class="text-center"><i class="fas fa-tools mr-3"></i>Actions</th>
              </tr>
            </thead>
            <tbody id="assessmentListBody">
              <!-- Will be populated by JavaScript -->
            </tbody>
          </table>
          <div id="emptyListMessage" class="p-20 text-center text-slate-500 hidden">
            <i class="fas fa-folder-open text-8xl mb-8 text-slate-300"></i>
            <h3 class="text-2xl font-bold mb-4">No assessments found</h3>
            <p class="text-slate-400 text-lg">Create your first assessment or adjust your search filters.</p>
          </div>
        </div>
      </div>

      <!-- Analytics View -->
      <div id="analyticsView" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-10">
          <div class="stats-card">
            <div class="stats-icon bg-gradient-to-br from-blue-100 to-blue-200 text-blue-600">
              <i class="fas fa-shield-halved"></i>
            </div>
            <p class="text-slate-500 text-sm font-bold uppercase tracking-wider mb-2">Total Assessments</p>
            <p class="text-4xl font-bold text-slate-800" id="totalAssessments">0</p>
            <p class="text-green-600 text-sm mt-2 font-semibold">
              <i class="fas fa-trending-up mr-2"></i>
              <span id="assessmentGrowth">0%</span> from last year
            </p>
          </div>
          
          <div class="stats-card">
            <div class="stats-icon bg-gradient-to-br from-green-100 to-green-200 text-green-600">
              <i class="fas fa-calendar-days"></i>
            </div>
            <p class="text-slate-500 text-sm font-bold uppercase tracking-wider mb-2">Business Days</p>
            <p class="text-4xl font-bold text-slate-800" id="totalBusinessDays">0</p>
            <p class="text-blue-600 text-sm mt-2 font-semibold">
              <i class="fas fa-calendar-check mr-2"></i>
              <span id="avgDuration">0</span> days average
            </p>
          </div>
          
          <div class="stats-card">
            <div class="stats-icon bg-gradient-to-br from-red-100 to-red-200 text-red-600">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <p class="text-slate-500 text-sm font-bold uppercase tracking-wider mb-2">Critical Priority</p>
            <p class="text-4xl font-bold text-slate-800" id="criticalCount">0</p>
            <p class="text-red-600 text-sm mt-2 font-semibold">
              <i class="fas fa-percent mr-2"></i>
              <span id="criticalPercent">0%</span> of total
            </p>
          </div>
          
          <div class="stats-card">
            <div class="stats-icon bg-gradient-to-br from-purple-100 to-purple-200 text-purple-600">
              <i class="fas fa-building"></i>
            </div>
            <p class="text-slate-500 text-sm font-bold uppercase tracking-wider mb-2">Business Units</p>
            <p class="text-4xl font-bold text-slate-800" id="uniqueBusinessUnits">0</p>
            <p class="text-purple-600 text-sm mt-2 font-semibold">
              <i class="fas fa-chart-simple mr-2"></i>
              <span id="avgAssessmentsPerUnit">0</span> avg per unit
            </p>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 mb-10">
          <div class="stats-card">
            <h3 class="text-2xl font-bold mb-8 flex items-center gap-4">
              <i class="fas fa-chart-pie text-blue-500"></i>
              Assessment Type Distribution
            </h3>
            <div class="chart-container">
              <canvas id="typesChart"></canvas>
            </div>
          </div>
          
          <div class="stats-card">
            <h3 class="text-2xl font-bold mb-8 flex items-center gap-4">
              <i class="fas fa-chart-column text-green-500"></i>
              Monthly Workload Analysis
            </h3>
            <div class="chart-container">
              <canvas id="workloadChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
          <div class="stats-card">
            <h3 class="text-2xl font-bold mb-8 flex items-center gap-4">
              <i class="fas fa-chart-line text-purple-500"></i>
              Priority Distribution
            </h3>
            <div class="chart-container">
              <canvas id="priorityChart"></canvas>
            </div>
          </div>
          
          <div class="stats-card">
            <h3 class="text-2xl font-bold mb-8 flex items-center gap-4">
              <i class="fas fa-ranking-star text-orange-500"></i>
              Top Business Units
            </h3>
            <div id="topBusinessUnitsList" class="space-y-4">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- Reports View -->
      <div id="reportsView" class="hidden">
        <div class="bg-white rounded-3xl shadow-2xl p-8">
          <h2 class="text-3xl font-bold text-slate-800 flex items-center gap-4 mb-8">
            <i class="fas fa-file-contract text-purple-500"></i>
            Advanced Reports Generator
          </h2>
          <p class="text-slate-600 text-lg mb-8">Generate comprehensive security assessment reports with advanced analytics and insights</p>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            <div class="border-2 border-slate-200 rounded-2xl p-6 hover:border-blue-400 transition-all cursor-pointer hover:shadow-lg"
                 onclick="SecurityScheduler.generateExecutiveReport()">
              <div class="flex items-center gap-4 mb-4">
                <div class="bg-gradient-to-br from-blue-100 to-blue-200 p-4 rounded-xl">
                  <i class="fas fa-chart-line text-blue-600 text-2xl"></i>
                </div>
                <div>
                  <h3 class="text-xl font-bold">Executive Dashboard Report</h3>
                  <p class="text-slate-600">High-level overview for leadership</p>
                </div>
              </div>
              <p class="text-sm text-slate-500">Includes KPIs, trends, risk summary, and strategic insights with business day calculations</p>
            </div>
            
            <div class="border-2 border-slate-200 rounded-2xl p-6 hover:border-green-400 transition-all cursor-pointer hover:shadow-lg"
                 onclick="SecurityScheduler.generateTechnicalReport()">
              <div class="flex items-center gap-4 mb-4">
                <div class="bg-gradient-to-br from-green-100 to-green-200 p-4 rounded-xl">
                  <i class="fas fa-cogs text-green-600 text-2xl"></i>
                </div>
                <div>
                  <h3 class="text-xl font-bold">Technical Operations Report</h3>
                  <p class="text-slate-600">Detailed technical analysis</p>
                </div>
              </div>
              <p class="text-sm text-slate-500">Assessment details, resource allocation, and technical metrics with weekend exclusions</p>
            </div>
            
            <div class="border-2 border-slate-200 rounded-2xl p-6 hover:border-purple-400 transition-all cursor-pointer hover:shadow-lg"
                 onclick="SecurityScheduler.generateComplianceReport()">
              <div class="flex items-center gap-4 mb-4">
                <div class="bg-gradient-to-br from-purple-100 to-purple-200 p-4 rounded-xl">
                  <i class="fas fa-shield-check text-purple-600 text-2xl"></i>
                </div>
                <div>
                  <h3 class="text-xl font-bold">Compliance & Audit Report</h3>
                  <p class="text-slate-600">Regulatory compliance tracking</p>
                </div>
              </div>
              <p class="text-sm text-slate-500">Compliance status, audit trails, and regulatory requirements</p>
            </div>
            
            <div class="border-2 border-slate-200 rounded-2xl p-6 hover:border-orange-400 transition-all cursor-pointer hover:shadow-lg"
                 onclick="SecurityScheduler.generateResourceReport()">
              <div class="flex items-center gap-4 mb-4">
                <div class="bg-gradient-to-br from-orange-100 to-orange-200 p-4 rounded-xl">
                  <i class="fas fa-users text-orange-600 text-2xl"></i>
                </div>
                <div>
                  <h3 class="text-xl font-bold">Resource Utilization Report</h3>
                  <p class="text-slate-600">Team and resource analysis</p>
                </div>
              </div>
              <p class="text-sm text-slate-500">Resource allocation, capacity planning, and workload distribution</p>
            </div>
          </div>
          
          <div class="p-8 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl">
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-3">
              <i class="fas fa-magic text-indigo-600"></i>
              Custom Report Builder
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
              <div>
                <label class="form-label">Report Type</label>
                <select id="customReportType" class="form-input">
                  <option value="summary">Summary Report</option>
                  <option value="detailed">Detailed Analysis</option>
                  <option value="timeline">Timeline Report</option>
                  <option value="comparison">Year-over-Year Comparison</option>
                  <option value="workload">Workload Distribution</option>
                  <option value="risk">Risk Assessment Matrix</option>
                </select>
              </div>
              <div>
                <label class="form-label">Date Range</label>
                <select id="customDateRange" class="form-input">
                  <option value="current">Current Year</option>
                  <option value="previous">Previous Year</option>
                  <option value="quarters">Last 4 Quarters</option>
                  <option value="custom">Custom Range</option>
                </select>
              </div>
              <div>
                <label class="form-label">Format</label>
                <select id="customReportFormat" class="form-input">
                  <option value="pdf">PDF Document</option>
                  <option value="excel">Excel Workbook</option>
                  <option value="html">Interactive HTML</option>
                </select>
              </div>
            </div>
            <button onclick="SecurityScheduler.generateCustomReport()" class="btn btn-primary text-lg">
              <i class="fas fa-magic"></i>Generate Custom Report
            </button>
          </div>
          
          <!-- Quick Metrics Section -->
          <div class="mt-12">
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-3">
              <i class="fas fa-tachometer-alt text-blue-600"></i>
              Quick Metrics Overview
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="report-metric">
                <div class="report-metric-title">Average Assessment Duration</div>
                <div class="report-metric-value" id="reportAvgDuration">0 days</div>
                <div class="report-metric-subtitle">Business days only</div>
              </div>
              <div class="report-metric">
                <div class="report-metric-title">Resource Utilization Rate</div>
                <div class="report-metric-value" id="reportUtilization">0%</div>
                <div class="report-metric-subtitle">Based on business days</div>
              </div>
              <div class="report-metric">
                <div class="report-metric-title">Risk Coverage Score</div>
                <div class="report-metric-value" id="reportRiskScore">0</div>
                <div class="report-metric-subtitle">Weighted by priority</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Floating Add Button -->
    <button class="floating-add-btn no-print" onclick="SecurityScheduler.showAddAssessmentModal()">
      <i class="fas fa-plus"></i>
    </button>

    <!-- Assessment Detail Card Modal -->
    <div id="assessmentDetailModal" class="modal-backdrop hidden">
      <div class="modal" style="max-width: 700px;">
        <div id="assessmentCardHeader" class="p-8 border-b bg-gradient-to-r from-slate-700 to-slate-800">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-2xl font-bold text-white" id="cardTargetName">Assessment Details</h3>
              <p class="text-slate-300 mt-1" id="cardBusinessUnit"></p>
            </div>
            <button onclick="SecurityScheduler.closeModal('assessmentDetailModal')" class="text-white hover:text-gray-200 p-2">
              <i class="fas fa-times text-2xl"></i>
            </button>
          </div>
        </div>
        <div class="p-8">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div>
              <label class="text-sm font-semibold text-slate-600 uppercase tracking-wider">Assessment Type</label>
              <p class="text-lg font-bold mt-1" id="cardAssessmentType"></p>
            </div>
            <div>
              <label class="text-sm font-semibold text-slate-600 uppercase tracking-wider">Priority Level</label>
              <div class="mt-1">
                <span class="priority-badge" id="cardPriority"></span>
              </div>
            </div>
            <div>
              <label class="text-sm font-semibold text-slate-600 uppercase tracking-wider">Start Date</label>
              <p class="text-lg font-bold mt-1" id="cardStartDate"></p>
            </div>
            <div>
              <label class="text-sm font-semibold text-slate-600 uppercase tracking-wider">End Date</label>
              <p class="text-lg font-bold mt-1" id="cardEndDate"></p>
            </div>
            <div>
              <label class="text-sm font-semibold text-slate-600 uppercase tracking-wider">Duration</label>
              <div class="duration-display mt-1">
                <span class="business-days" id="cardBusinessDays"></span>
                <span class="total-days" id="cardTotalDays"></span>
              </div>
            </div>
            <div>
              <label class="text-sm font-semibold text-slate-600 uppercase tracking-wider">Status</label>
              <div class="mt-1">
                <span class="priority-badge bg-blue-500 text-white" id="cardStatus">Scheduled</span>
              </div>
            </div>
          </div>
          
          <div class="mb-8" id="cardNotesSection">
            <label class="text-sm font-semibold text-slate-600 uppercase tracking-wider">Notes & Requirements</label>
            <p class="mt-2 p-4 bg-slate-50 rounded-xl" id="cardNotes"></p>
          </div>
          
          <div class="mb-8" id="cardCustomFieldsSection">
            <label class="text-sm font-semibold text-slate-600 uppercase tracking-wider">Custom Fields</label>
            <div id="cardCustomFields" class="mt-2 space-y-2"></div>
          </div>
          
          <div class="flex justify-between items-center pt-8 border-t">
            <div class="text-sm text-slate-500">
              <p>Created: <span id="cardCreatedAt"></span></p>
              <p>Modified: <span id="cardUpdatedAt"></span></p>
            </div>
            <div class="flex gap-3">
              <button onclick="SecurityScheduler.editAssessmentFromCard()" class="btn btn-primary">
                <i class="fas fa-edit"></i>Edit
              </button>
              <button onclick="SecurityScheduler.deleteAssessmentFromCard()" class="btn btn-danger">
                <i class="fas fa-trash"></i>Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Assessment Modal -->
    <div id="addAssessmentModal" class="modal-backdrop hidden">
      <div class="modal">
        <div class="p-8 border-b bg-gradient-to-r from-blue-50 to-indigo-50">
          <h2 class="text-3xl font-bold text-slate-800 flex items-center gap-4">
            <i class="fas fa-plus-circle text-blue-500"></i>
            <span id="modalTitle">Create Security Assessment</span>
          </h2>
          <p class="text-slate-600 text-lg mt-3">Configure your security assessment parameters</p>
        </div>
        <form id="assessmentForm" onsubmit="SecurityScheduler.saveAssessment(event)" class="p-8">
          <div class="weekend-toggle">
            <input type="checkbox" id="excludeWeekends" checked>
            <label for="excludeWeekends">Exclude weekends from duration (business days only)</label>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-bullseye"></i>Target System/Application
              </label>
              <input type="text" id="targetName" required class="form-input" placeholder="e.g., Customer Portal, API Gateway">
              <p class="form-hint">
                <i class="fas fa-info-circle"></i>
                Enter the name of the system or application to be assessed
              </p>
            </div>
            
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-building"></i>Business Unit
              </label>
              <input type="text" id="businessUnit" required class="form-input" placeholder="e.g., Finance, IT Operations">
              <p class="form-hint">
                <i class="fas fa-info-circle"></i>
                Specify the business unit responsible for this system
              </p>
            </div>
            
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-cogs"></i>Assessment Type
              </label>
              <select id="assessmentType" required class="form-input">
                <option value="">Select Assessment Type</option>
                <option value="External Pentest">External Penetration Test</option>
                <option value="Internal Pentest">Internal Penetration Test</option>
                <option value="Web Application">Web Application Security Assessment</option>
                <option value="Mobile Application">Mobile Application Security Assessment</option>
                <option value="Cloud Security">Cloud Security Assessment</option>
                <option value="Network Security">Network Security Assessment</option>
                <option value="Social Engineering">Social Engineering Assessment</option>
                <option value="Red Team">Red Team Exercise</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-flag"></i>Priority Level
              </label>
              <select id="priority" required class="form-input">
                <option value="">Select Priority Level</option>
                <option value="critical">Critical - Immediate attention required</option>
                <option value="high">High - Important business impact</option>
                <option value="medium">Medium - Standard business priority</option>
                <option value="low">Low - Maintenance and improvement</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-play-circle"></i>Start Date
              </label>
              <input type="date" id="startDate" required class="form-input" onchange="SecurityScheduler.updateEndDateMin()">
            </div>
            
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-stop-circle"></i>End Date
              </label>
              <input type="date" id="endDate" required class="form-input" onchange="SecurityScheduler.updateDurationPreview()">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-clock"></i>Duration Preview
            </label>
            <div id="durationPreview" class="p-4 bg-blue-50 rounded-xl text-blue-700 font-semibold">
              Select start and end dates to see duration
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-sticky-note"></i>Notes & Requirements
            </label>
            <textarea id="notes" rows="4" class="form-input" placeholder="Additional notes, specific requirements, compliance standards, or special considerations..."></textarea>
          </div>

          <!-- Custom Fields Section -->
          <div class="form-group">
            <div class="flex items-center justify-between mb-6">
              <label class="form-label mb-0">
                <i class="fas fa-plus-square"></i>Custom Fields
              </label>
              <button type="button" onclick="SecurityScheduler.addCustomField()" class="btn btn-secondary">
                <i class="fas fa-plus"></i>Add Field
              </button>
            </div>
            <div id="customFieldsContainer" class="space-y-4">
              <!-- Custom fields will be added here -->
            </div>
          </div>

          <!-- Conflict Detection -->
          <div id="conflictWarning" class="hidden">
            <!-- Will be populated by JavaScript -->
          </div>
          
          <div class="flex justify-end gap-6 mt-10 pt-8 border-t-2 border-slate-100">
            <button type="button" onclick="SecurityScheduler.closeModal('addAssessmentModal')" class="btn btn-secondary text-lg">
              <i class="fas fa-times"></i>Cancel
            </button>
            <button type="submit" class="btn btn-primary text-lg">
              <i class="fas fa-save"></i>
              <span id="saveButtonText">Save Assessment</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal-backdrop hidden">
      <div class="modal">
        <div class="p-8 border-b bg-gradient-to-r from-green-50 to-emerald-50">
          <h2 class="text-3xl font-bold text-slate-800 flex items-center gap-4">
            <i class="fas fa-file-export text-green-500"></i>
            Export Assessment Reports
          </h2>
          <p class="text-slate-600 text-lg mt-3">Generate comprehensive reports in your preferred format</p>
        </div>
        <div class="p-8">
          <div class="export-grid">
            <div class="export-card" onclick="SecurityScheduler.exportExcel()">
              <div class="export-icon bg-gradient-to-br from-green-100 to-green-200 text-green-600">
                <i class="fas fa-file-excel"></i>
              </div>
              <h3 class="font-bold text-xl mb-2">Excel Workbook</h3>
              <p class="text-sm text-slate-600">Multi-sheet spreadsheet with analysis and pivot tables</p>
            </div>
            
            <div class="export-card" onclick="SecurityScheduler.exportPDF()">
              <div class="export-icon bg-gradient-to-br from-red-100 to-red-200 text-red-600">
                <i class="fas fa-file-pdf"></i>
              </div>
              <h3 class="font-bold text-xl mb-2">PDF Report</h3>
              <p class="text-sm text-slate-600">Professional document with executive summary and charts</p>
            </div>
            
            <div class="export-card" onclick="SecurityScheduler.exportWord()">
              <div class="export-icon bg-gradient-to-br from-blue-100 to-blue-200 text-blue-600">
                <i class="fas fa-file-word"></i>
              </div>
              <h3 class="font-bold text-xl mb-2">Word Document</h3>
              <p class="text-sm text-slate-600">Detailed report with professional formatting</p>
            </div>
            
            <div class="export-card" onclick="SecurityScheduler.exportHTML()">
              <div class="export-icon bg-gradient-to-br from-purple-100 to-purple-200 text-purple-600">
                <i class="fas fa-code"></i>
              </div>
              <h3 class="font-bold text-xl mb-2">Interactive HTML</h3>
              <p class="text-sm text-slate-600">Web-based report with interactive features</p>
            </div>
            
            <div class="export-card" onclick="SecurityScheduler.exportJSON()">
              <div class="export-icon bg-gradient-to-br from-indigo-100 to-indigo-200 text-indigo-600">
                <i class="fas fa-database"></i>
              </div>
              <h3 class="font-bold text-xl mb-2">JSON Data</h3>
              <p class="text-sm text-slate-600">Raw data export for system integration</p>
            </div>
          </div>
          
          <div class="flex justify-end mt-10 pt-8 border-t-2 border-slate-100">
            <button onclick="SecurityScheduler.closeModal('exportModal')" class="btn btn-secondary text-lg">
              <i class="fas fa-times"></i>Close
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Application Script -->
  <script>
    // Global Security Scheduler Application
    const SecurityScheduler = {
      // Application state
      state: {
        assessments: [],
        currentView: 'calendar',
        selectedYear: new Date().getFullYear(),
        currentMonth: new Date().getMonth(),
        editingId: null,
        charts: {},
        customFieldCounter: 0,
        selectedAssessmentId: null,
        excludeWeekends: true // Default to excluding weekends
      },

      // Assessment type icons mapping
      typeIcons: {
        'External Pentest': 'fas fa-globe',
        'Internal Pentest': 'fas fa-building',
        'Web Application': 'fas fa-laptop-code',
        'Mobile Application': 'fas fa-mobile-alt',
        'Cloud Security': 'fas fa-cloud',
        'Network Security': 'fas fa-network-wired',
        'Social Engineering': 'fas fa-users',
        'Red Team': 'fas fa-crosshairs'
      },

      // Initialize application
      init() {
        try {
          this.loadData();
          this.setupEventListeners();
          this.setInitialYear();
          this.updateCalendar();
          this.updateViews();
          this.setupSearchFilter();
          this.showNotification('Security Assessment Scheduler loaded successfully!', 'success');
        } catch (error) {
          console.error('Initialization error:', error);
          this.showNotification('Error initializing application. Please refresh the page.', 'error');
        }
      },

      // Data management
      loadData() {
        try {
          const saved = localStorage.getItem('securityAssessmentsPro');
          if (saved) {
            this.state.assessments = JSON.parse(saved);
            this.state.assessments = this.state.assessments.map(assessment => ({
              ...assessment,
              businessUnit: assessment.businessUnit || assessment.client || 'Unknown',
              createdAt: assessment.createdAt || new Date().toISOString(),
              updatedAt: assessment.updatedAt || new Date().toISOString(),
              excludeWeekends: assessment.excludeWeekends !== undefined ? assessment.excludeWeekends : true
            }));
          }
        } catch (error) {
          console.error('Error loading data:', error);
          this.state.assessments = [];
          this.showNotification('Error loading saved data. Starting fresh.', 'error');
        }
      },

      saveData() {
        try {
          localStorage.setItem('securityAssessmentsPro', JSON.stringify(this.state.assessments));
        } catch (error) {
          console.error('Error saving data:', error);
          this.showNotification('Error saving data. Please try again.', 'error');
        }
      },

      // Weekend handling utilities
      isWeekend(date) {
        const day = date.getDay();
        return day === 0 || day === 6;
      },

      getBusinessDays(startDate, endDate) {
        let count = 0;
        const current = new Date(startDate);
        const end = new Date(endDate);
        
        while (current <= end) {
          if (!this.isWeekend(current)) {
            count++;
          }
          current.setDate(current.getDate() + 1);
        }
        
        return count;
      },

      getTotalDays(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        return Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
      },

      getDurationDisplay(startDate, endDate, excludeWeekends = true) {
        const businessDays = this.getBusinessDays(startDate, endDate);
        const totalDays = this.getTotalDays(startDate, endDate);
        
        if (excludeWeekends) {
          return {
            primary: `${businessDays} business days`,
            secondary: `(${totalDays} total days)`,
            value: businessDays
          };
        } else {
          return {
            primary: `${totalDays} days`,
            secondary: '',
            value: totalDays
          };
        }
      },

      // Enhanced scheduling algorithm
      SchedulingEngine: {
        detectConflicts(newAssessment, assessments) {
          const conflicts = [];
          const newStart = new Date(newAssessment.startDate);
          const newEnd = new Date(newAssessment.endDate);
          
          assessments.forEach(assessment => {
            if (assessment.id === newAssessment.id) return;
            
            const existingStart = new Date(assessment.startDate);
            const existingEnd = new Date(assessment.endDate);
            
            if (newStart <= existingEnd && newEnd >= existingStart) {
              if (assessment.businessUnit === newAssessment.businessUnit) {
                conflicts.push({
                  type: 'resource',
                  assessment: assessment,
                  message: `Resource conflict with ${assessment.target} (${assessment.type})`
                });
              } else if (assessment.type === newAssessment.type && assessment.priority === 'critical') {
                conflicts.push({
                  type: 'priority',
                  assessment: assessment,
                  message: `Priority conflict with critical ${assessment.type} assessment`
                });
              }
            }
          });
          
          return conflicts;
        },
        
        calculateOptimalSchedule(assessments) {
          return assessments.sort((a, b) => {
            const priorityOrder = { critical: 4, high: 3, medium: 2, low: 1 };
            const priorityDiff = priorityOrder[b.priority] - priorityOrder[a.priority];
            if (priorityDiff !== 0) return priorityDiff;
            return new Date(a.startDate) - new Date(b.startDate);
          });
        },
        
        getWorkloadDistribution(assessments, year) {
          const distribution = new Array(12).fill(0);
          assessments.forEach(assessment => {
            const start = new Date(assessment.startDate);
            const end = new Date(assessment.endDate);
            
            if (start.getFullYear() === year || end.getFullYear() === year) {
              for (let month = 0; month < 12; month++) {
                const monthStart = new Date(year, month, 1);
                const monthEnd = new Date(year, month + 1, 0);
                
                if (start <= monthEnd && end >= monthStart) {
                  distribution[month]++;
                }
              }
            }
          });
          return distribution;
        }
      },

      // Setup event listeners
      setupEventListeners() {
        document.getElementById('yearSelect').addEventListener('change', (e) => {
          this.state.selectedYear = parseInt(e.target.value);
          const newDate = new Date(this.state.selectedYear, this.state.currentMonth, 1);
          this.state.currentMonth = newDate.getMonth();
          this.updateViews();
        });

        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
              case 'n':
                e.preventDefault();
                this.showAddAssessmentModal();
                break;
              case 'e':
                e.preventDefault();
                this.showExportModal();
                break;
              case '1':
                e.preventDefault();
                this.changeView('calendar');
                break;
              case '2':
                e.preventDefault();
                this.changeView('timeline');
                break;
              case '3':
                e.preventDefault();
                this.changeView('list');
                break;
              case '4':
                e.preventDefault();
                this.changeView('analytics');
                break;
              case '5':
                e.preventDefault();
                this.changeView('reports');
                break;
            }
          }
          
          if (e.key === 'Escape') {
            const modals = document.querySelectorAll('.modal-backdrop');
            modals.forEach(modal => {
              if (!modal.classList.contains('hidden')) {
                modal.classList.add('hidden');
              }
            });
          }
        });
      },

      setInitialYear() {
        document.getElementById('yearSelect').value = this.state.selectedYear;
      },

      // View management
      changeView(view) {
        this.state.currentView = view;
        
        // Update navigation buttons
        document.querySelectorAll('.view-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        const viewBtnMap = {
          'calendar': 'calendarViewBtn',
          'yearly': 'yearlyViewBtn',
          'timeline': 'timelineViewBtn',
          'list': 'listViewBtn',
          'analytics': 'analyticsViewBtn',
          'reports': 'reportsViewBtn'
        };
        
        const activeBtn = document.getElementById(viewBtnMap[view]);
        if (activeBtn) {
          activeBtn.classList.add('active');
        }
        
        // Update view visibility
        document.getElementById('calendarView').classList.toggle('hidden', view !== 'calendar');
        document.getElementById('yearlyView').classList.toggle('hidden', view !== 'yearly');
        document.getElementById('timelineView').classList.toggle('hidden', view !== 'timeline');
        document.getElementById('listView').classList.toggle('hidden', view !== 'list');
        document.getElementById('analyticsView').classList.toggle('hidden', view !== 'analytics');
        document.getElementById('reportsView').classList.toggle('hidden', view !== 'reports');
        
        // Render specific view
        switch(view) {
          case 'yearly':
            this.renderYearlyView();
            break;
          case 'timeline':
            this.renderTimelineGrid();
            break;
          case 'list':
            this.updateListView();
            break;
          case 'analytics':
            setTimeout(() => this.updateAnalytics(), 100);
            break;
          case 'reports':
            this.updateReportMetrics();
            break;
        }
      },

      // Calendar functions
      updateCalendar() {
        try {
          const calendarGrid = document.getElementById('calendarGrid');
          const title = document.getElementById('calendarTitle');
          
          const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'];
          
          title.textContent = `${monthNames[this.state.currentMonth]} ${this.state.selectedYear}`;
          
          // Clear existing days (but not headers)
          const existingDays = calendarGrid.querySelectorAll('.calendar-day');
          existingDays.forEach(day => day.remove());
          
          const firstDay = new Date(this.state.selectedYear, this.state.currentMonth, 1).getDay();
          const daysInMonth = new Date(this.state.selectedYear, this.state.currentMonth + 1, 0).getDate();
          const daysInPrevMonth = new Date(this.state.selectedYear, this.state.currentMonth, 0).getDate();
          
          // Add previous month days
          for (let i = firstDay - 1; i >= 0; i--) {
            const dayDiv = this.createCalendarDay(daysInPrevMonth - i, true, false);
            calendarGrid.appendChild(dayDiv);
          }
          
          // Add current month days
          const today = new Date();
          for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(this.state.selectedYear, this.state.currentMonth, day);
            const isToday = today.getFullYear() === this.state.selectedYear && 
                           today.getMonth() === this.state.currentMonth && 
                           today.getDate() === day;
            const isWeekend = this.isWeekend(currentDate);
            const dayDiv = this.createCalendarDay(day, false, isToday, isWeekend);
            calendarGrid.appendChild(dayDiv);
          }
          
          // Add next month days
          const totalCells = calendarGrid.children.length - 7; // Subtract header cells
          const remainingCells = 42 - totalCells;
          for (let day = 1; day <= remainingCells; day++) {
            const dayDiv = this.createCalendarDay(day, true, false);
            calendarGrid.appendChild(dayDiv);
          }
        } catch (error) {
          console.error('Error updating calendar:', error);
          this.showNotification('Error updating calendar display.', 'error');
        }
      },

      createCalendarDay(dayNumber, otherMonth, isToday, isWeekend = false) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        if (otherMonth) dayDiv.classList.add('other-month');
        if (isToday) dayDiv.classList.add('today');
        if (isWeekend) dayDiv.classList.add('weekend');
        
        const dayNumberDiv = document.createElement('div');
        dayNumberDiv.className = 'day-number';
        dayNumberDiv.textContent = dayNumber;
        dayDiv.appendChild(dayNumberDiv);
        
        if (!otherMonth) {
          const dayAssessments = this.getAssessmentsForDay(this.state.selectedYear, this.state.currentMonth, dayNumber);
          
          dayAssessments.slice(0, 3).forEach(assessment => {
            const assessmentDiv = document.createElement('div');
            assessmentDiv.className = `assessment-item ${assessment.priority}`;
            
            assessmentDiv.innerHTML = `
              <i class="${this.typeIcons[assessment.type] || 'fas fa-shield-alt'}"></i>
              <span>${assessment.target.substring(0, 15)}${assessment.target.length > 15 ? '...' : ''}</span>
            `;
            
            assessmentDiv.onclick = (e) => {
              e.stopPropagation();
              this.showAssessmentCard(assessment.id);
            };
            
            const duration = this.getDurationDisplay(assessment.startDate, assessment.endDate, assessment.excludeWeekends);
            assessmentDiv.title = `${assessment.target}\nType: ${assessment.type}\nBusiness Unit: ${assessment.businessUnit}\nPriority: ${assessment.priority.toUpperCase()}\nDuration: ${duration.primary} ${duration.secondary}`;
            
            dayDiv.appendChild(assessmentDiv);
          });
          
          if (dayAssessments.length > 3) {
            const moreDiv = document.createElement('div');
            moreDiv.className = 'text-center text-xs text-slate-500 font-semibold mt-2';
            moreDiv.textContent = `+${dayAssessments.length - 3} more`;
            moreDiv.onclick = (e) => {
              e.stopPropagation();
              this.showDayAssessments(this.state.selectedYear, this.state.currentMonth, dayNumber);
            };
            dayDiv.appendChild(moreDiv);
          }
          
          dayDiv.onclick = (e) => {
            if (e.target === dayDiv || e.target === dayNumberDiv) {
              const clickedDate = new Date(this.state.selectedYear, this.state.currentMonth, dayNumber);
              this.showAddAssessmentModal(clickedDate);
            }
          };
        }
        
        return dayDiv;
      },

      // Yearly View
      renderYearlyView() {
        const yearlyGrid = document.getElementById('yearlyGrid');
        yearlyGrid.innerHTML = '';
        
        const months = ['January', 'February', 'March', 'April', 'May', 'June',
          'July', 'August', 'September', 'October', 'November', 'December'];
        
        months.forEach((month, monthIndex) => {
          const monthCard = document.createElement('div');
          monthCard.className = 'month-card';
          
          // Month header
          const header = document.createElement('div');
          header.className = 'month-card-header';
          header.textContent = month;
          monthCard.appendChild(header);
          
          // Mini calendar grid
          const miniGrid = document.createElement('div');
          miniGrid.className = 'mini-calendar-grid';
          
          // Day headers
          const dayHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
          dayHeaders.forEach((day, index) => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'mini-day-header';
            if (index === 0 || index === 6) dayHeader.classList.add('weekend');
            dayHeader.textContent = day;
            miniGrid.appendChild(dayHeader);
          });
          
          // Days
          const firstDay = new Date(this.state.selectedYear, monthIndex, 1).getDay();
          const daysInMonth = new Date(this.state.selectedYear, monthIndex + 1, 0).getDate();
          
          // Empty cells for start of month
          for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'mini-day';
            miniGrid.appendChild(emptyDay);
          }
          
          // Days of month
          for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(this.state.selectedYear, monthIndex, day);
            const isWeekend = this.isWeekend(currentDate);
            
            const dayDiv = document.createElement('div');
            dayDiv.className = 'mini-day';
            if (isWeekend) dayDiv.classList.add('weekend');
            dayDiv.textContent = day;
            
            const dayAssessments = this.getAssessmentsForDay(this.state.selectedYear, monthIndex, day);
            
            if (dayAssessments.length > 0) {
              dayDiv.classList.add('has-assessments');
              
              // Check for critical assessments
              if (dayAssessments.some(a => a.priority === 'critical')) {
                dayDiv.classList.add('has-critical');
              }
              
              // Add assessment dots
              const dotsContainer = document.createElement('div');
              dotsContainer.className = 'assessment-dots';
              
              const priorityOrder = ['critical', 'high', 'medium', 'low'];
              const uniquePriorities = [...new Set(dayAssessments.map(a => a.priority))];
              
              priorityOrder.forEach(priority => {
                if (uniquePriorities.includes(priority)) {
                  const dot = document.createElement('div');
                  dot.className = `assessment-dot dot-${priority}`;
                  dotsContainer.appendChild(dot);
                }
              });
              
              dayDiv.appendChild(dotsContainer);
            }
            
            dayDiv.onclick = () => {
              this.state.currentMonth = monthIndex;
              this.changeView('calendar');
              this.updateCalendar();
            };
            
            dayDiv.title = dayAssessments.length > 0 ? 
              `${dayAssessments.length} assessment${dayAssessments.length > 1 ? 's' : ''}` : 
              'Click to view';
            
            miniGrid.appendChild(dayDiv);
          }
          
          monthCard.appendChild(miniGrid);
          
          // Month summary
          const monthAssessments = this.state.assessments.filter(a => {
            const start = new Date(a.startDate);
            const end = new Date(a.endDate);
            return (start.getFullYear() === this.state.selectedYear || end.getFullYear() === this.state.selectedYear) &&
                   (start.getMonth() === monthIndex || end.getMonth() === monthIndex);
          });
          
          if (monthAssessments.length > 0) {
            const summary = document.createElement('div');
            summary.className = 'month-summary';
            
            const totalRow = document.createElement('div');
            totalRow.className = 'month-summary-row';
            totalRow.innerHTML = `
              <span class="month-summary-label">Total:</span>
              <span class="month-summary-value">${monthAssessments.length} assessments</span>
            `;
            summary.appendChild(totalRow);
            
            const criticalCount = monthAssessments.filter(a => a.priority === 'critical').length;
            if (criticalCount > 0) {
              const criticalRow = document.createElement('div');
              criticalRow.className = 'month-summary-row';
              criticalRow.innerHTML = `
                <span class="month-summary-label">Critical:</span>
                <span class="month-summary-value" style="color: #dc2626;">${criticalCount}</span>
              `;
              summary.appendChild(criticalRow);
            }
            
            // Business days in month
            const businessDaysInMonth = this.getBusinessDaysInMonth(this.state.selectedYear, monthIndex);
            const businessDaysRow = document.createElement('div');
            businessDaysRow.className = 'month-summary-row';
            businessDaysRow.innerHTML = `
              <span class="month-summary-label">Business Days:</span>
              <span class="month-summary-value">${businessDaysInMonth}</span>
            `;
            summary.appendChild(businessDaysRow);
            
            monthCard.appendChild(summary);
          }
          
          yearlyGrid.appendChild(monthCard);
        });
      },

      getBusinessDaysInMonth(year, month) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        let count = 0;
        
        for (let day = 1; day <= lastDay.getDate(); day++) {
          const date = new Date(year, month, day);
          if (!this.isWeekend(date)) {
            count++;
          }
        }
        
        return count;
      },

      getAssessmentsForDay(year, month, day) {
        const targetDate = new Date(year, month, day);
        targetDate.setHours(0, 0, 0, 0);
        
        return this.state.assessments.filter(assessment => {
          const startDate = new Date(assessment.startDate);
          const endDate = new Date(assessment.endDate);
          startDate.setHours(0, 0, 0, 0);
          endDate.setHours(0, 0, 0, 0);
          
          return targetDate >= startDate && targetDate <= endDate;
        });
      },

      showDayAssessments(year, month, day) {
        const dayAssessments = this.getAssessmentsForDay(year, month, day);
        const dateStr = new Date(year, month, day).toLocaleDateString('en-US', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        
        const content = `
          <div class="p-6">
            <h3 class="text-xl font-bold mb-4">Assessments for ${dateStr}</h3>
            <div class="space-y-3">
              ${dayAssessments.map(assessment => {
                const duration = this.getDurationDisplay(assessment.startDate, assessment.endDate, assessment.excludeWeekends);
                return `
                  <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg hover:bg-slate-100 cursor-pointer transition-all" 
                       onclick="SecurityScheduler.showAssessmentCard('${assessment.id}')">
                    <div class="flex items-center gap-3">
                      <i class="${this.typeIcons[assessment.type] || 'fas fa-shield-alt'} text-lg text-blue-500"></i>
                      <div>
                        <div class="font-semibold">${assessment.target}</div>
                        <div class="text-sm text-slate-600">${assessment.type} - ${assessment.businessUnit}</div>
                        <div class="text-xs text-slate-500 mt-1">${duration.primary} ${duration.secondary}</div>
                      </div>
                    </div>
                    <span class="priority-badge ${assessment.priority === 'critical' ? 'bg-red-500 text-white' : 
                     assessment.priority === 'high' ? 'bg-orange-500 text-white' : 
                     assessment.priority === 'medium' ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'}">
                      ${assessment.priority.toUpperCase()}
                    </span>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
        
        this.showCustomModal('Day Assessments', content);
      },

      showCustomModal(title, content) {
        const modal = document.createElement('div');
        modal.className = 'modal-backdrop';
        modal.innerHTML = `
          <div class="modal" style="max-width: 600px;">
            <div class="p-6 border-b bg-gradient-to-r from-blue-50 to-indigo-50">
              <h2 class="text-2xl font-bold text-slate-800">${title}</h2>
            </div>
            ${content}
            <div class="p-6 border-t">
              <button onclick="this.closest('.modal-backdrop').remove()" class="btn btn-secondary">
                <i class="fas fa-times"></i>Close
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      },

      previousMonth() {
        this.state.currentMonth--;
        if (this.state.currentMonth < 0) {
          this.state.currentMonth = 11;
          this.state.selectedYear--;
          document.getElementById('yearSelect').value = this.state.selectedYear;
        }
        this.updateCalendar();
      },

      nextMonth() {
        this.state.currentMonth++;
        if (this.state.currentMonth > 11) {
          this.state.currentMonth = 0;
          this.state.selectedYear++;
          document.getElementById('yearSelect').value = this.state.selectedYear;
        }
        this.updateCalendar();
      },

      // Enhanced Timeline with better design and weekend support
      renderTimelineGrid() {
        try {
          const grid = document.getElementById('timelineGrid');
          grid.innerHTML = '';
          
          // Add headers
          grid.innerHTML += `<div class="timeline-header">
            <i class="fas fa-building mr-3"></i>Target / Business Unit
          </div>`;
          
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          
          months.forEach((month, index) => {
            const businessDays = this.getBusinessDaysInMonth(this.state.selectedYear, index);
            grid.innerHTML += `<div class="timeline-header timeline-month-header">
              <i class="fas fa-calendar mr-2"></i>${month}
              <div class="timeline-month-info">${businessDays} business days</div>
              <div class="month-indicator"></div>
            </div>`;
          });
          
          // Get assessments for the year
          const yearAssessments = this.state.assessments.filter(a => {
            const year = new Date(a.startDate).getFullYear();
            return year === parseInt(this.state.selectedYear);
          });
          
          // Group by target and business unit
          const targetGroups = {};
          yearAssessments.forEach(assessment => {
            const key = `${assessment.target}|${assessment.businessUnit}`;
            if (!targetGroups[key]) {
              targetGroups[key] = {
                target: assessment.target,
                businessUnit: assessment.businessUnit,
                assessments: []
              };
            }
            targetGroups[key].assessments.push(assessment);
          });
          
          const sortedTargets = Object.values(targetGroups).sort((a, b) => 
            a.target.localeCompare(b.target)
          );
          
          if (sortedTargets.length === 0) {
            grid.innerHTML += `<div class="timeline-cell" style="grid-column: 1 / -1; text-align: center; padding: 80px; color: #a0aec0;">
              <i class="fas fa-calendar-times text-6xl mb-6"></i>
              <br><span class="text-xl font-semibold">No assessments scheduled for ${this.state.selectedYear}</span>
              <br><button onclick="SecurityScheduler.showAddAssessmentModal()" class="btn btn-primary mt-4">
                <i class="fas fa-plus"></i> Schedule First Assessment
              </button>
            </div>`;
            return;
          }
          
          // Create rows with enhanced layout
          sortedTargets.forEach((targetGroup, rowIndex) => {
            // Calculate workload
            const totalBusinessDays = targetGroup.assessments.reduce((sum, a) => {
              return sum + this.getBusinessDays(a.startDate, a.endDate);
            }, 0);
            const possibleBusinessDays = 260; // Approximate business days in a year
            const workloadPercent = Math.min(100, Math.round((totalBusinessDays / possibleBusinessDays) * 100));
            
            // Row header with workload indicator
            grid.innerHTML += `<div class="timeline-row-header">
              <div class="target-name" title="${targetGroup.target}">${targetGroup.target}</div>
              <div class="business-unit">
                <i class="fas fa-building mr-2"></i>${targetGroup.businessUnit}
              </div>
              <div class="assessment-count">${targetGroup.assessments.length} assessment${targetGroup.assessments.length > 1 ? 's' : ''}</div>
              <div class="workload-indicator">
                <div class="workload-bar" style="width: ${workloadPercent}%"></div>
              </div>
            </div>`;
            
            // Month cells
            for (let month = 0; month < 12; month++) {
              const cellId = `timeline-cell-${rowIndex}-${month}`;
              const weekendOverlays = this.getWeekendOverlaysForMonth(month);
              grid.innerHTML += `<div class="timeline-cell" id="${cellId}">
                ${weekendOverlays}
              </div>`;
            }
          });
          
          // Enhanced placement algorithm - guaranteed no overlaps
          sortedTargets.forEach((targetGroup, rowIndex) => {
            // Sort assessments by start date first
            const sortedAssessments = [...targetGroup.assessments].sort((a, b) => 
              new Date(a.startDate) - new Date(b.startDate)
            );
            
            // Calculate lanes for each assessment to avoid overlaps
            const lanes = [];
            
            sortedAssessments.forEach(assessment => {
              const startDate = new Date(assessment.startDate);
              const endDate = new Date(assessment.endDate);
              
              // Find the first available lane
              let assignedLane = 0;
              let laneFound = false;
              
              while (!laneFound) {
                let canUseLane = true;
                
                // Check if this lane is free for the duration of this assessment
                for (let i = 0; i < lanes.length; i++) {
                  if (lanes[i].lane === assignedLane) {
                    const existingStart = new Date(lanes[i].assessment.startDate);
                    const existingEnd = new Date(lanes[i].assessment.endDate);
                    
                    if (!(endDate < existingStart || startDate > existingEnd)) {
                      canUseLane = false;
                      break;
                    }
                  }
                }
                
                if (canUseLane) {
                  laneFound = true;
                  lanes.push({ assessment, lane: assignedLane });
                } else {
                  assignedLane++;
                }
              }
              
              // Place the assessment with calculated lane
              this.placeAssessmentBarEnhanced(assessment, rowIndex, assignedLane);
            });
            
            // Adjust row height based on number of lanes used
            const maxLane = Math.max(...lanes.map(l => l.lane), 0);
            const requiredHeight = 100 + (maxLane * 50);
            
            for (let month = 0; month < 12; month++) {
              const cell = document.getElementById(`timeline-cell-${rowIndex}-${month}`);
              if (cell) {
                cell.style.minHeight = `${requiredHeight}px`;
              }
            }
          });
        } catch (error) {
          console.error('Error rendering timeline:', error);
          this.showNotification('Error rendering timeline view.', 'error');
        }
      },

      getWeekendOverlaysForMonth(month) {
        const firstDay = new Date(this.state.selectedYear, month, 1);
        const lastDay = new Date(this.state.selectedYear, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        let overlays = '';
        
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(this.state.selectedYear, month, day);
          if (this.isWeekend(date)) {
            const leftPercent = ((day - 1) / daysInMonth) * 100;
            const widthPercent = (1 / daysInMonth) * 100;
            overlays += `<div class="timeline-weekend-overlay" style="left: ${leftPercent}%; width: ${widthPercent}%;"></div>`;
          }
        }
        
        return overlays;
      },

      // Enhanced assessment bar placement with better visuals
      placeAssessmentBarEnhanced(assessment, rowIndex, lane) {
        const startDate = new Date(assessment.startDate);
        const endDate = new Date(assessment.endDate);
        const startMonth = startDate.getMonth();
        const endMonth = endDate.getMonth();
        
        // Calculate position for start month
        const startDay = startDate.getDate();
        const daysInStartMonth = new Date(this.state.selectedYear, startMonth + 1, 0).getDate();
        const leftPercent = Math.max(5, (startDay / daysInStartMonth) * 85);
        
        // Calculate duration info
        const duration = this.getDurationDisplay(assessment.startDate, assessment.endDate, assessment.excludeWeekends);
        
        // Place bar in start month
        const startCell = document.getElementById(`timeline-cell-${rowIndex}-${startMonth}`);
        if (startCell) {
          const bar = document.createElement('div');
          bar.className = `assessment-bar priority-${assessment.priority}`;
          
          // Calculate width for first month
          let width;
          if (startMonth === endMonth) {
            const duration = endDate.getDate() - startDate.getDate() + 1;
            width = Math.max(25, (duration / daysInStartMonth) * 85);
          } else {
            width = Math.max(25, ((daysInStartMonth - startDay + 1) / daysInStartMonth) * 85);
          }
          
          bar.style.left = `${leftPercent}%`;
          bar.style.width = `${width}%`;
          bar.style.top = `${16 + (lane * 50)}px`;
          bar.style.zIndex = 10 + lane;
          
          bar.innerHTML = `
            <i class="${this.typeIcons[assessment.type] || 'fas fa-shield-alt'} assessment-icon"></i>
            <span class="assessment-text">${assessment.target} - ${assessment.type}</span>
            <span class="duration-badge">${duration.value}d</span>
          `;
          
          bar.onclick = () => this.showAssessmentCard(assessment.id);
          
          bar.title = `${assessment.target}\nType: ${assessment.type}\nBusiness Unit: ${assessment.businessUnit}\nPriority: ${assessment.priority.toUpperCase()}\nDuration: ${duration.primary} ${duration.secondary}`;
          
          startCell.appendChild(bar);
        }
        
        // Handle multi-month assessments
        for (let month = startMonth + 1; month < endMonth; month++) {
          const cell = document.getElementById(`timeline-cell-${rowIndex}-${month}`);
          if (cell) {
            const bar = document.createElement('div');
            bar.className = `assessment-bar priority-${assessment.priority}`;
            bar.style.left = '5%';
            bar.style.width = '90%';
            bar.style.top = `${16 + (lane * 50)}px`;
            bar.style.zIndex = 10 + lane;
            
            bar.innerHTML = `
              <i class="${this.typeIcons[assessment.type] || 'fas fa-shield-alt'} assessment-icon"></i>
              <span class="assessment-text">${assessment.target} - ${assessment.type}</span>
              <span class="duration-badge">cont.</span>
            `;
            
            bar.onclick = () => this.showAssessmentCard(assessment.id);
            bar.title = `${assessment.target} - ${assessment.type} (continued)`;
            cell.appendChild(bar);
          }
        }
        
        // Handle end month if different from start
        if (endMonth > startMonth && endMonth < 12) {
          const endCell = document.getElementById(`timeline-cell-${rowIndex}-${endMonth}`);
          if (endCell) {
            const endDay = endDate.getDate();
            const daysInEndMonth = new Date(this.state.selectedYear, endMonth + 1, 0).getDate();
            const endWidth = Math.max(25, (endDay / daysInEndMonth) * 85);
            
            const bar = document.createElement('div');
            bar.className = `assessment-bar priority-${assessment.priority}`;
            bar.style.left = '5%';
            bar.style.width = `${endWidth}%`;
            bar.style.top = `${16 + (lane * 50)}px`;
            bar.style.zIndex = 10 + lane;
            
            bar.innerHTML = `
              <i class="${this.typeIcons[assessment.type] || 'fas fa-shield-alt'} assessment-icon"></i>
              <span class="assessment-text">${assessment.target} - ${assessment.type}</span>
              <span class="duration-badge">ends</span>
            `;
            
            bar.onclick = () => this.showAssessmentCard(assessment.id);
            bar.title = `${assessment.target} - ${assessment.type} (ends ${this.formatDate(assessment.endDate)})`;
            endCell.appendChild(bar);
          }
        }
      },

      // Enhanced Assessment Card Display
      showAssessmentCard(assessmentId) {
        const assessment = this.state.assessments.find(a => a.id === assessmentId);
        if (!assessment) {
          this.showNotification('Assessment not found', 'error');
          return;
        }
        
        this.state.selectedAssessmentId = assessmentId;
        
        // Set header with priority color
        const headerColors = {
          critical: 'bg-gradient-to-r from-red-600 to-red-700',
          high: 'bg-gradient-to-r from-orange-600 to-orange-700',
          medium: 'bg-gradient-to-r from-green-600 to-green-700',
          low: 'bg-gradient-to-r from-blue-600 to-blue-700'
        };
        
        const header = document.getElementById('assessmentCardHeader');
        header.className = `p-8 border-b ${headerColors[assessment.priority]}`;
        
        // Populate card data
        document.getElementById('cardTargetName').textContent = assessment.target;
        document.getElementById('cardBusinessUnit').textContent = assessment.businessUnit;
        document.getElementById('cardAssessmentType').textContent = assessment.type;
        
        const priorityBadge = document.getElementById('cardPriority');
        priorityBadge.textContent = assessment.priority.toUpperCase();
        priorityBadge.className = `priority-badge ${assessment.priority === 'critical' ? 'bg-red-500 text-white' : 
         assessment.priority === 'high' ? 'bg-orange-500 text-white' : 
         assessment.priority === 'medium' ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'}`;
        
        document.getElementById('cardStartDate').textContent = this.formatDate(assessment.startDate);
        document.getElementById('cardEndDate').textContent = this.formatDate(assessment.endDate);
        
        // Duration with business days
        const duration = this.getDurationDisplay(assessment.startDate, assessment.endDate, assessment.excludeWeekends);
        document.getElementById('cardBusinessDays').textContent = duration.primary;
        document.getElementById('cardTotalDays').textContent = duration.secondary;
        
        // Notes section
        const notesSection = document.getElementById('cardNotesSection');
        const notesElement = document.getElementById('cardNotes');
        if (assessment.notes && assessment.notes.trim()) {
          notesSection.style.display = 'block';
          notesElement.textContent = assessment.notes;
        } else {
          notesSection.style.display = 'none';
        }
        
        // Custom fields section
        const customFieldsSection = document.getElementById('cardCustomFieldsSection');
        const customFieldsElement = document.getElementById('cardCustomFields');
        if (assessment.customFields && assessment.customFields.length > 0) {
          customFieldsSection.style.display = 'block';
          customFieldsElement.innerHTML = assessment.customFields.map(field => 
            `<div class="flex justify-between items-center p-3 bg-white rounded-lg border border-slate-200">
              <span class="font-semibold text-slate-600">${field.name}:</span>
              <span class="text-slate-800">${field.value}</span>
            </div>`
          ).join('');
        } else {
          customFieldsSection.style.display = 'none';
        }
        
        // Timestamps
        if (assessment.createdAt) {
          document.getElementById('cardCreatedAt').textContent = new Date(assessment.createdAt).toLocaleDateString();
        }
        if (assessment.updatedAt) {
          document.getElementById('cardUpdatedAt').textContent = new Date(assessment.updatedAt).toLocaleDateString();
        }
        
        // Show modal
        document.getElementById('assessmentDetailModal').classList.remove('hidden');
      },

      editAssessmentFromCard() {
        this.closeModal('assessmentDetailModal');
        this.editAssessment(this.state.selectedAssessmentId);
      },

      deleteAssessmentFromCard() {
        this.closeModal('assessmentDetailModal');
        this.deleteAssessment(this.state.selectedAssessmentId);
      },

      // List view
      updateListView() {
        try {
          const tbody = document.getElementById('assessmentListBody');
          const emptyMessage = document.getElementById('emptyListMessage');
          
          let yearAssessments = this.state.assessments.filter(a => {
            const year = new Date(a.startDate).getFullYear();
            return year === parseInt(this.state.selectedYear);
          });
          
          const searchTerm = document.getElementById('searchInput').value.toLowerCase();
          const priorityFilter = document.getElementById('filterPriority').value;
          const typeFilter = document.getElementById('filterType').value;
          
          if (searchTerm) {
            yearAssessments = yearAssessments.filter(a => 
              a.target.toLowerCase().includes(searchTerm) ||
              a.businessUnit.toLowerCase().includes(searchTerm) ||
              a.type.toLowerCase().includes(searchTerm) ||
              (a.notes && a.notes.toLowerCase().includes(searchTerm))
            );
          }
          
          if (priorityFilter) {
            yearAssessments = yearAssessments.filter(a => a.priority === priorityFilter);
          }
          
          if (typeFilter) {
            yearAssessments = yearAssessments.filter(a => a.type === typeFilter);
          }
          
          if (yearAssessments.length === 0) {
            tbody.innerHTML = '';
            emptyMessage.classList.remove('hidden');
            return;
          }
          
          emptyMessage.classList.add('hidden');
          
          yearAssessments = this.SchedulingEngine.calculateOptimalSchedule(yearAssessments);
          
          tbody.innerHTML = yearAssessments.map(a => {
            const duration = this.getDurationDisplay(a.startDate, a.endDate, a.excludeWeekends);
            const typeIcon = this.typeIcons[a.type] || 'fas fa-shield-alt';
            
            return `<tr class="hover:bg-slate-50 transition-all duration-200">
              <td>
                <div class="font-bold text-lg cursor-pointer hover:text-blue-600" onclick="SecurityScheduler.showAssessmentCard('${a.id}')">${a.target}</div>
                ${a.notes ? `<div class="text-sm text-slate-500 mt-1">${a.notes.substring(0, 80)}${a.notes.length > 80 ? '...' : ''}</div>` : ''}
              </td>
              <td>
                <div class="flex items-center gap-3">
                  <i class="${typeIcon} text-lg text-blue-500"></i>
                  <span class="font-semibold">${a.type}</span>
                </div>
              </td>
              <td>
                <div class="font-semibold">${a.businessUnit}</div>
              </td>
              <td>
                <span class="priority-badge ${a.priority === 'critical' ? 'bg-red-500 text-white' : 
                 a.priority === 'high' ? 'bg-orange-500 text-white' : 
                 a.priority === 'medium' ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'}">
                  ${a.priority}
                </span>
              </td>
              <td class="font-semibold">${this.formatDate(a.startDate)}</td>
              <td class="font-semibold">${this.formatDate(a.endDate)}</td>
              <td>
                <div class="duration-display">
                  <span class="business-days">${duration.value}</span>
                  <span class="total-days">business days</span>
                </div>
              </td>
              <td class="text-center">
                <div class="flex items-center justify-center gap-3">
                  <button onclick="SecurityScheduler.showAssessmentCard('${a.id}')" class="text-blue-600 hover:text-blue-800 p-3 rounded-xl hover:bg-blue-50 transition-all" title="View Details">
                    <i class="fas fa-eye text-lg"></i>
                  </button>
                  <button onclick="SecurityScheduler.editAssessment('${a.id}')" class="text-green-600 hover:text-green-800 p-3 rounded-xl hover:bg-green-50 transition-all" title="Edit">
                    <i class="fas fa-edit text-lg"></i>
                  </button>
                  <button onclick="SecurityScheduler.deleteAssessment('${a.id}')" class="text-red-600 hover:text-red-800 p-3 rounded-xl hover:bg-red-50 transition-all" title="Delete">
                    <i class="fas fa-trash-alt text-lg"></i>
                  </button>
                </div>
              </td>
            </tr>`;
          }).join('');
        } catch (error) {
          console.error('Error updating list view:', error);
          this.showNotification('Error updating list view.', 'error');
        }
      },

      // Search and filter
      setupSearchFilter() {
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;
        
        searchInput.addEventListener('input', () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            if (this.state.currentView === 'list') {
              this.updateListView();
            }
          }, 300);
        });
      },

      filterAssessments() {
        if (this.state.currentView === 'list') {
          this.updateListView();
        }
      },

      // Analytics
      updateAnalytics() {
        try {
          const yearAssessments = this.state.assessments.filter(a => {
            const year = new Date(a.startDate).getFullYear();
            return year === parseInt(this.state.selectedYear);
          });
          
          const prevYearAssessments = this.state.assessments.filter(a => {
            const year = new Date(a.startDate).getFullYear();
            return year === parseInt(this.state.selectedYear) - 1;
          });
          
          // Update KPIs
          document.getElementById('totalAssessments').textContent = yearAssessments.length;
          
          // Calculate total business days
          const totalBusinessDays = yearAssessments.reduce((sum, a) => {
            return sum + this.getBusinessDays(a.startDate, a.endDate);
          }, 0);
          document.getElementById('totalBusinessDays').textContent = totalBusinessDays;
          
          const avgDuration = yearAssessments.length > 0 ? Math.round(totalBusinessDays / yearAssessments.length) : 0;
          document.getElementById('avgDuration').textContent = avgDuration;
          
          const criticalCount = yearAssessments.filter(a => a.priority === 'critical').length;
          document.getElementById('criticalCount').textContent = criticalCount;
          
          const criticalPercent = yearAssessments.length > 0 ? Math.round((criticalCount / yearAssessments.length) * 100) : 0;
          document.getElementById('criticalPercent').textContent = criticalPercent;
          
          const uniqueBusinessUnits = [...new Set(yearAssessments.map(a => a.businessUnit))];
          document.getElementById('uniqueBusinessUnits').textContent = uniqueBusinessUnits.length;
          
          const avgPerUnit = uniqueBusinessUnits.length > 0 ? Math.round(yearAssessments.length / uniqueBusinessUnits.length) : 0;
          document.getElementById('avgAssessmentsPerUnit').textContent = avgPerUnit;
          
          const growth = prevYearAssessments.length > 0 ? 
            Math.round(((yearAssessments.length - prevYearAssessments.length) / prevYearAssessments.length) * 100) : 0;
          document.getElementById('assessmentGrowth').textContent = growth > 0 ? `+${growth}` : growth;
          
          // Update charts
          this.updateCharts(yearAssessments);
          this.updateTopBusinessUnitsList(yearAssessments);
        } catch (error) {
          console.error('Error updating analytics:', error);
          this.showNotification('Error updating analytics.', 'error');
        }
      },

      updateCharts(yearAssessments) {
        if (typeof Chart === 'undefined') {
          console.warn('Chart.js not loaded');
          return;
        }

        // Types distribution chart
        const typeCount = {};
        yearAssessments.forEach(a => {
          typeCount[a.type] = (typeCount[a.type] || 0) + 1;
        });
        
        if (this.state.charts.types) this.state.charts.types.destroy();
        
        const typesCtx = document.getElementById('typesChart');
        if (typesCtx) {
          this.state.charts.types = new Chart(typesCtx, {
            type: 'doughnut',
            data: {
              labels: Object.keys(typeCount),
              datasets: [{
                data: Object.values(typeCount),
                backgroundColor: [
                  '#3B82F6', '#10B981', '#F59E0B', '#EF4444', 
                  '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'
                ],
                borderWidth: 3,
                borderColor: '#fff',
                hoverBorderWidth: 4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    padding: 20,
                    usePointStyle: true,
                    font: {
                      size: 12,
                      weight: '600'
                    }
                  }
                }
              }
            }
          });
        }
        
        // Monthly workload chart
        const workloadData = this.SchedulingEngine.getWorkloadDistribution(yearAssessments, this.state.selectedYear);
        
        if (this.state.charts.workload) this.state.charts.workload.destroy();
        
        const workloadCtx = document.getElementById('workloadChart');
        if (workloadCtx) {
          this.state.charts.workload = new Chart(workloadCtx, {
            type: 'bar',
            data: {
              labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
              datasets: [{
                label: 'Active Assessments',
                data: workloadData,
                backgroundColor: '#3B82F6',
                borderRadius: 10,
                borderSkipped: false,
                hoverBackgroundColor: '#2563EB'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1,
                    font: {
                      size: 12,
                      weight: '600'
                    }
                  },
                  grid: {
                    color: '#E2E8F0'
                  }
                },
                x: {
                  grid: {
                    display: false
                  },
                  ticks: {
                    font: {
                      size: 12,
                      weight: '600'
                    }
                  }
                }
              },
              plugins: {
                legend: {
                  display: false
                }
              }
            }
          });
        }
        
        // Priority distribution chart
        const priorityCount = {
          critical: yearAssessments.filter(a => a.priority === 'critical').length,
          high: yearAssessments.filter(a => a.priority === 'high').length,
          medium: yearAssessments.filter(a => a.priority === 'medium').length,
          low: yearAssessments.filter(a => a.priority === 'low').length
        };
        
        if (this.state.charts.priority) this.state.charts.priority.destroy();
        
        const priorityCtx = document.getElementById('priorityChart');
        if (priorityCtx) {
          this.state.charts.priority = new Chart(priorityCtx, {
            type: 'bar',
            data: {
              labels: ['Critical', 'High', 'Medium', 'Low'],
              datasets: [{
                data: Object.values(priorityCount),
                backgroundColor: ['#EF4444', '#F97316', '#22C55E', '#3B82F6'],
                borderRadius: 10,
                borderSkipped: false,
                hoverBackgroundColor: ['#DC2626', '#EA580C', '#16A34A', '#2563EB']
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1,
                    font: {
                      size: 12,
                      weight: '600'
                    }
                  },
                  grid: {
                    color: '#E2E8F0'
                  }
                },
                x: {
                  grid: {
                    display: false
                  },
                  ticks: {
                    font: {
                      size: 12,
                      weight: '600'
                    }
                  }
                }
              },
              plugins: {
                legend: {
                  display: false
                }
              }
            }
          });
        }
      },

      updateTopBusinessUnitsList(yearAssessments) {
        const unitCount = {};
        yearAssessments.forEach(a => {
          unitCount[a.businessUnit] = (unitCount[a.businessUnit] || 0) + 1;
        });
        
        const sortedUnits = Object.entries(unitCount)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5);
        
        const container = document.getElementById('topBusinessUnitsList');
        if (container) {
          container.innerHTML = sortedUnits.map(([unit, count], index) => {
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-pink-500'];
            const icons = ['fas fa-crown', 'fas fa-medal', 'fas fa-trophy', 'fas fa-star', 'fas fa-award'];
            
            // Calculate business days for this unit
            const unitAssessments = yearAssessments.filter(a => a.businessUnit === unit);
            const totalBusinessDays = unitAssessments.reduce((sum, a) => {
              return sum + this.getBusinessDays(a.startDate, a.endDate);
            }, 0);
            
            return `<div class="flex items-center justify-between p-4 bg-gradient-to-r from-slate-50 to-white rounded-xl hover:shadow-md transition-all border border-slate-200">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full ${colors[index]} text-white flex items-center justify-center shadow-lg">
                  <i class="${icons[index]}"></i>
                </div>
                <div>
                  <div class="font-bold text-lg">${unit}</div>
                  <div class="text-sm text-slate-500">${count} assessment${count > 1 ? 's' : ''}  ${totalBusinessDays} business days</div>
                </div>
              </div>
              <div class="text-3xl font-bold text-slate-400">#${index + 1}</div>
            </div>`;
          }).join('') || '<div class="text-center text-slate-500 py-8">No business unit data available</div>';
        }
      },

      // Update report metrics
      updateReportMetrics() {
        const yearAssessments = this.state.assessments.filter(a => {
          const year = new Date(a.startDate).getFullYear();
          return year === parseInt(this.state.selectedYear);
        });
        
        // Average duration
        const totalBusinessDays = yearAssessments.reduce((sum, a) => {
          return sum + this.getBusinessDays(a.startDate, a.endDate);
        }, 0);
        const avgDuration = yearAssessments.length > 0 ? Math.round(totalBusinessDays / yearAssessments.length) : 0;
        document.getElementById('reportAvgDuration').textContent = `${avgDuration} days`;
        
        // Resource utilization
        const possibleBusinessDays = 260 * this.getUniqueBusinessUnits().length; // Approximate
        const utilizationRate = possibleBusinessDays > 0 ? Math.round((totalBusinessDays / possibleBusinessDays) * 100) : 0;
        document.getElementById('reportUtilization').textContent = `${utilizationRate}%`;
        
        // Risk score
        const riskScore = yearAssessments.reduce((sum, a) => {
          const scores = { critical: 4, high: 3, medium: 2, low: 1 };
          return sum + scores[a.priority];
        }, 0);
        document.getElementById('reportRiskScore').textContent = riskScore;
      },

      // Custom fields management
      addCustomField() {
        this.state.customFieldCounter++;
        const container = document.getElementById('customFieldsContainer');
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'custom-field-item';
        fieldDiv.id = `customField${this.state.customFieldCounter}`;
        
        fieldDiv.innerHTML = `
          <button type="button" onclick="SecurityScheduler.removeCustomField('customField${this.state.customFieldCounter}')" 
                  class="custom-field-remove" title="Remove field">
            <i class="fas fa-times"></i>
          </button>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <input type="text" 
                     id="customFieldName${this.state.customFieldCounter}" 
                     placeholder="Field Name (e.g., Compliance)" 
                     class="form-input" />
            </div>
            <div>
              <input type="text" 
                     id="customFieldValue${this.state.customFieldCounter}" 
                     placeholder="Field Value (e.g., SOX, PCI-DSS)" 
                     class="form-input" />
            </div>
          </div>
        `;
        
        container.appendChild(fieldDiv);
      },

      removeCustomField(fieldId) {
        const field = document.getElementById(fieldId);
        if (field) {
          field.style.opacity = '0';
          field.style.transform = 'scale(0.9)';
          setTimeout(() => field.remove(), 300);
        }
      },

      // CRUD Operations
      showAddAssessmentModal(selectedDate = null) {
        this.state.editingId = null;
        document.getElementById('assessmentForm').reset();
        document.getElementById('customFieldsContainer').innerHTML = '';
        document.getElementById('conflictWarning').classList.add('hidden');
        document.getElementById('excludeWeekends').checked = true;
        this.state.customFieldCounter = 0;
        
        document.getElementById('modalTitle').textContent = 'Create Security Assessment';
        document.getElementById('saveButtonText').textContent = 'Save Assessment';
        
        if (selectedDate) {
          const dateStr = selectedDate.toISOString().split('T')[0];
          document.getElementById('startDate').value = dateStr;
          document.getElementById('endDate').value = dateStr;
          this.updateDurationPreview();
        }
        
        document.getElementById('durationPreview').innerHTML = 'Select start and end dates to see duration';
        
        document.getElementById('addAssessmentModal').classList.remove('hidden');
        setTimeout(() => document.getElementById('targetName').focus(), 100);
      },

      editAssessment(id) {
        const assessment = this.state.assessments.find(a => a.id === id);
        if (!assessment) return;
        
        this.state.editingId = id;
        document.getElementById('modalTitle').textContent = 'Edit Security Assessment';
        document.getElementById('saveButtonText').textContent = 'Update Assessment';
        
        document.getElementById('targetName').value = assessment.target;
        document.getElementById('businessUnit').value = assessment.businessUnit;
        document.getElementById('assessmentType').value = assessment.type;
        document.getElementById('priority').value = assessment.priority;
        document.getElementById('startDate').value = assessment.startDate;
        document.getElementById('endDate').value = assessment.endDate;
        document.getElementById('notes').value = assessment.notes || '';
        document.getElementById('excludeWeekends').checked = assessment.excludeWeekends !== undefined ? assessment.excludeWeekends : true;
        
        this.updateDurationPreview();
        
        document.getElementById('customFieldsContainer').innerHTML = '';
        this.state.customFieldCounter = 0;
        if (assessment.customFields) {
          assessment.customFields.forEach(field => {
            this.addCustomField();
            const nameInput = document.getElementById(`customFieldName${this.state.customFieldCounter}`);
            const valueInput = document.getElementById(`customFieldValue${this.state.customFieldCounter}`);
            if (nameInput) nameInput.value = field.name;
            if (valueInput) valueInput.value = field.value;
          });
        }
        
        document.getElementById('addAssessmentModal').classList.remove('hidden');
      },

      updateDurationPreview() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const excludeWeekends = document.getElementById('excludeWeekends').checked;
        const previewDiv = document.getElementById('durationPreview');
        
        if (startDate && endDate) {
          const duration = this.getDurationDisplay(startDate, endDate, excludeWeekends);
          const businessDays = this.getBusinessDays(startDate, endDate);
          const totalDays = this.getTotalDays(startDate, endDate);
          
          if (excludeWeekends) {
            previewDiv.innerHTML = `
              <i class="fas fa-calendar-days mr-2"></i>
              Duration: <strong>${businessDays} business days</strong> 
              <span class="text-sm opacity-75">(${totalDays} total days including weekends)</span>
            `;
          } else {
            previewDiv.innerHTML = `
              <i class="fas fa-calendar mr-2"></i>
              Duration: <strong>${totalDays} days</strong>
              <span class="text-sm opacity-75">(includes weekends)</span>
            `;
          }
        } else {
          previewDiv.innerHTML = 'Select start and end dates to see duration';
        }
      },

      saveAssessment(event) {
        event.preventDefault();
        
        try {
          const customFields = [];
          const customFieldDivs = document.querySelectorAll('[id^="customField"]');
          
          customFieldDivs.forEach(div => {
            const fieldId = div.id.replace('customField', '');
            const nameInput = document.getElementById(`customFieldName${fieldId}`);
            const valueInput = document.getElementById(`customFieldValue${fieldId}`);
            
            if (nameInput && valueInput && nameInput.value && valueInput.value) {
              customFields.push({
                name: nameInput.value,
                value: valueInput.value
              });
            }
          });
          
          const assessment = {
            id: this.state.editingId || Date.now().toString(),
            target: document.getElementById('targetName').value,
            businessUnit: document.getElementById('businessUnit').value,
            type: document.getElementById('assessmentType').value,
            priority: document.getElementById('priority').value,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            notes: document.getElementById('notes').value,
            excludeWeekends: document.getElementById('excludeWeekends').checked,
            customFields: customFields,
            createdAt: this.state.editingId ? this.state.assessments.find(a => a.id === this.state.editingId).createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          
          const conflicts = this.SchedulingEngine.detectConflicts(assessment, this.state.assessments);
          if (conflicts.length > 0) {
            this.showConflictWarning(conflicts);
            return;
          }
          
          if (this.state.editingId) {
            const index = this.state.assessments.findIndex(a => a.id === this.state.editingId);
            this.state.assessments[index] = assessment;
          } else {
            this.state.assessments.push(assessment);
          }
          
          this.saveData();
          this.updateViews();
          this.closeModal('addAssessmentModal');
          
          this.showNotification('Assessment saved successfully!', 'success');
        } catch (error) {
          console.error('Error saving assessment:', error);
          this.showNotification('Error saving assessment. Please try again.', 'error');
        }
      },

      showConflictWarning(conflicts) {
        const warningDiv = document.getElementById('conflictWarning');
        warningDiv.innerHTML = `
          <div class="bg-red-50 border-2 border-red-200 rounded-xl p-4 mt-6">
            <div class="flex items-start gap-3">
              <i class="fas fa-exclamation-triangle text-red-500 text-xl mt-1"></i>
              <div class="flex-1">
                <div class="font-bold text-red-800 mb-2">Scheduling Conflicts Detected:</div>
                ${conflicts.map(c => `<div class="text-red-700 mb-1"> ${c.message}</div>`).join('')}
                <div class="mt-4 flex gap-3">
                  <button type="button" onclick="SecurityScheduler.saveAssessmentForced()" class="btn btn-primary">
                    <i class="fas fa-save"></i>Save Anyway
                  </button>
                  <button type="button" onclick="SecurityScheduler.hideConflictWarning()" class="btn btn-secondary">
                    <i class="fas fa-edit"></i>Modify Dates
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        warningDiv.classList.remove('hidden');
      },

      hideConflictWarning() {
        document.getElementById('conflictWarning').classList.add('hidden');
      },

      saveAssessmentForced() {
        const customFields = [];
        const customFieldDivs = document.querySelectorAll('[id^="customField"]');
        
        customFieldDivs.forEach(div => {
          const fieldId = div.id.replace('customField', '');
          const nameInput = document.getElementById(`customFieldName${fieldId}`);
          const valueInput = document.getElementById(`customFieldValue${fieldId}`);
          
          if (nameInput && valueInput && nameInput.value && valueInput.value) {
            customFields.push({
              name: nameInput.value,
              value: valueInput.value
            });
          }
        });
        
        const assessment = {
          id: this.state.editingId || Date.now().toString(),
          target: document.getElementById('targetName').value,
          businessUnit: document.getElementById('businessUnit').value,
          type: document.getElementById('assessmentType').value,
          priority: document.getElementById('priority').value,
          startDate: document.getElementById('startDate').value,
          endDate: document.getElementById('endDate').value,
          notes: document.getElementById('notes').value,
          excludeWeekends: document.getElementById('excludeWeekends').checked,
          customFields: customFields,
          createdAt: this.state.editingId ? this.state.assessments.find(a => a.id === this.state.editingId).createdAt : new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        if (this.state.editingId) {
          const index = this.state.assessments.findIndex(a => a.id === this.state.editingId);
          this.state.assessments[index] = assessment;
        } else {
          this.state.assessments.push(assessment);
        }
        
        this.saveData();
        this.updateViews();
        this.closeModal('addAssessmentModal');
        
        this.showNotification('Assessment saved with conflicts!', 'success');
      },

      deleteAssessment(id) {
        if (confirm('Are you sure you want to delete this assessment? This action cannot be undone.')) {
          try {
            this.state.assessments = this.state.assessments.filter(a => a.id !== id);
            this.saveData();
            this.updateViews();
            this.showNotification('Assessment deleted successfully!', 'success');
          } catch (error) {
            console.error('Error deleting assessment:', error);
            this.showNotification('Error deleting assessment. Please try again.', 'error');
          }
        }
      },

      updateEndDateMin() {
        const startDate = document.getElementById('startDate').value;
        const endDateInput = document.getElementById('endDate');
        endDateInput.min = startDate;
        if (endDateInput.value && endDateInput.value < startDate) {
          endDateInput.value = startDate;
        }
        this.updateDurationPreview();
      },

      // Helper Functions
      updateViews() {
        switch(this.state.currentView) {
          case 'calendar':
            this.updateCalendar();
            break;
          case 'yearly':
            this.renderYearlyView();
            break;
          case 'timeline':
            this.renderTimelineGrid();
            break;
          case 'list':
            this.updateListView();
            break;
          case 'analytics':
            setTimeout(() => this.updateAnalytics(), 100);
            break;
          case 'reports':
            this.updateReportMetrics();
            break;
        }
      },

      closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
      },

      formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric', 
          year: 'numeric' 
        });
      },

      calculateTotalBusinessDays() {
        const yearAssessments = this.state.assessments.filter(a => new Date(a.startDate).getFullYear() === parseInt(this.state.selectedYear));
        return yearAssessments.reduce((sum, a) => {
          return sum + this.getBusinessDays(a.startDate, a.endDate);
        }, 0);
      },

      calculateTotalDays() {
        const yearAssessments = this.state.assessments.filter(a => new Date(a.startDate).getFullYear() === parseInt(this.state.selectedYear));
        return yearAssessments.reduce((sum, a) => {
          const days = Math.ceil((new Date(a.endDate) - new Date(a.startDate)) / (1000 * 60 * 60 * 24)) + 1;
          return sum + days;
        }, 0);
      },

      getUniqueBusinessUnits() {
        const yearAssessments = this.state.assessments.filter(a => new Date(a.startDate).getFullYear() === parseInt(this.state.selectedYear));
        return [...new Set(yearAssessments.map(a => a.businessUnit))];
      },

      showNotification(message, type = 'info') {
        const existingNotifications = document.querySelectorAll('.notification');
        existingNotifications.forEach(n => n.remove());
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        const icons = {
          success: 'fas fa-check-circle',
          error: 'fas fa-exclamation-circle',
          info: 'fas fa-info-circle'
        };
        
        notification.innerHTML = `<i class="${icons[type]}"></i>${message}`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.classList.add('show');
        }, 100);
        
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 400);
        }, 4000);
      },

      // Advanced Reports Functions
      generateExecutiveReport() {
        this.showNotification('Generating Executive Dashboard Report...', 'info');
        setTimeout(() => this.exportPDF(), 500);
      },

      generateTechnicalReport() {
        this.showNotification('Generating Technical Operations Report...', 'info');
        setTimeout(() => this.exportExcel(), 500);
      },

      generateComplianceReport() {
        this.showNotification('Generating Compliance & Audit Report...', 'info');
        setTimeout(() => this.exportWord(), 500);
      },

      generateResourceReport() {
        this.showNotification('Generating Resource Utilization Report...', 'info');
        setTimeout(() => this.exportExcel(), 500);
      },

      generateCustomReport() {
        const type = document.getElementById('customReportType').value;
        const dateRange = document.getElementById('customDateRange').value;
        const format = document.getElementById('customReportFormat').value;
        
        this.showNotification(`Generating custom ${type} report in ${format.toUpperCase()} format...`, 'info');
        
        setTimeout(() => {
          switch(format) {
            case 'pdf':
              this.exportPDF();
              break;
            case 'excel':
              this.exportExcel();
              break;
            case 'html':
              this.exportHTML();
              break;
            default:
              this.exportJSON();
          }
        }, 500);
      },

      // Export functions
      showExportModal() {
        document.getElementById('exportModal').classList.remove('hidden');
      },

      // Export to Excel with business days
      exportExcel() {
        try {
          this.showNotification('Generating comprehensive Excel report...', 'info');
          
          if (typeof XLSX === 'undefined') {
            throw new Error('Excel library not available');
          }
          
          const wb = XLSX.utils.book_new();
          const yearAssessments = this.state.assessments.filter(a => new Date(a.startDate).getFullYear() === parseInt(this.state.selectedYear));
          
          // Executive Summary Sheet
          const summaryData = [
            ['SECURITY ASSESSMENT SCHEDULE - EXECUTIVE SUMMARY'],
            [''],
            ['Report Year:', this.state.selectedYear],
            ['Generated:', new Date().toLocaleString()],
            [''],
            ['KEY METRICS'],
            ['Total Assessments:', yearAssessments.length],
            ['Total Business Days:', this.calculateTotalBusinessDays()],
            ['Total Calendar Days:', this.calculateTotalDays()],
            ['Average Assessment Duration:', Math.round(this.calculateTotalBusinessDays() / (yearAssessments.length || 1)) + ' business days'],
            ['Unique Business Units:', this.getUniqueBusinessUnits().length],
            [''],
            ['PRIORITY BREAKDOWN'],
            ['Critical Priority:', yearAssessments.filter(a => a.priority === 'critical').length + ' (' + Math.round((yearAssessments.filter(a => a.priority === 'critical').length / (yearAssessments.length || 1)) * 100) + '%)'],
            ['High Priority:', yearAssessments.filter(a => a.priority === 'high').length + ' (' + Math.round((yearAssessments.filter(a => a.priority === 'high').length / (yearAssessments.length || 1)) * 100) + '%)'],
            ['Medium Priority:', yearAssessments.filter(a => a.priority === 'medium').length + ' (' + Math.round((yearAssessments.filter(a => a.priority === 'medium').length / (yearAssessments.length || 1)) * 100) + '%)'],
            ['Low Priority:', yearAssessments.filter(a => a.priority === 'low').length + ' (' + Math.round((yearAssessments.filter(a => a.priority === 'low').length / (yearAssessments.length || 1)) * 100) + '%)']
          ];
          
          const summaryWS = XLSX.utils.aoa_to_sheet(summaryData);
          summaryWS['!cols'] = [{ wch: 30 }, { wch: 20 }];
          XLSX.utils.book_append_sheet(wb, summaryWS, 'Executive Summary');
          
          // Detailed Assessments Sheet with business days
          const assessmentData = yearAssessments.map(a => {
            const businessDays = this.getBusinessDays(a.startDate, a.endDate);
            const totalDays = this.getTotalDays(a.startDate, a.endDate);
            
            const baseData = {
              'Target System': a.target,
              'Business Unit': a.businessUnit,
              'Assessment Type': a.type,
              'Priority': a.priority.toUpperCase(),
              'Start Date': a.startDate,
              'End Date': a.endDate,
              'Business Days': businessDays,
              'Total Days': totalDays,
              'Exclude Weekends': a.excludeWeekends ? 'Yes' : 'No',
              'Notes': a.notes || '',
              'Created Date': a.createdAt ? new Date(a.createdAt).toLocaleDateString() : '',
              'Last Modified': a.updatedAt ? new Date(a.updatedAt).toLocaleDateString() : ''
            };
            
            if (a.customFields) {
              a.customFields.forEach(field => {
                baseData[field.name] = field.value;
              });
            }
            
            return baseData;
          });
          
          const assessmentsWS = XLSX.utils.json_to_sheet(assessmentData);
          assessmentsWS['!cols'] = [
            { wch: 25 }, { wch: 20 }, { wch: 25 }, { wch: 12 },
            { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 12 },
            { wch: 15 }, { wch: 40 }, { wch: 15 }, { wch: 15 }
          ];
          
          XLSX.utils.book_append_sheet(wb, assessmentsWS, 'Assessment Details');
          
          // Monthly Calendar Sheet with business days
          const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
          const calendarData = months.map((month, index) => {
            const monthAssessments = yearAssessments.filter(a => {
              const startMonth = new Date(a.startDate).getMonth();
              const endMonth = new Date(a.endDate).getMonth();
              return index >= startMonth && index <= endMonth;
            });
            
            const businessDaysInMonth = this.getBusinessDaysInMonth(this.state.selectedYear, index);
            
            return {
              'Month': month,
              'Business Days': businessDaysInMonth,
              'Active Assessments': monthAssessments.length,
              'Critical': monthAssessments.filter(a => a.priority === 'critical').length,
              'High': monthAssessments.filter(a => a.priority === 'high').length,
              'Medium': monthAssessments.filter(a => a.priority === 'medium').length,
              'Low': monthAssessments.filter(a => a.priority === 'low').length,
              'Total Assessment Days': monthAssessments.reduce((sum, a) => {
                return sum + this.getBusinessDays(a.startDate, a.endDate);
              }, 0),
              'Business Units': [...new Set(monthAssessments.map(a => a.businessUnit))].length
            };
          });
          
          const calendarWS = XLSX.utils.json_to_sheet(calendarData);
          XLSX.utils.book_append_sheet(wb, calendarWS, 'Monthly Calendar');
          
          // Business Unit Analysis Sheet
          const unitStats = {};
          yearAssessments.forEach(a => {
            if (!unitStats[a.businessUnit]) {
              unitStats[a.businessUnit] = {
                totalAssessments: 0,
                totalBusinessDays: 0,
                totalCalendarDays: 0,
                priorities: { critical: 0, high: 0, medium: 0, low: 0 },
                types: {}
              };
            }
            
            unitStats[a.businessUnit].totalAssessments++;
            unitStats[a.businessUnit].totalBusinessDays += this.getBusinessDays(a.startDate, a.endDate);
            unitStats[a.businessUnit].totalCalendarDays += this.getTotalDays(a.startDate, a.endDate);
            unitStats[a.businessUnit].priorities[a.priority]++;
            unitStats[a.businessUnit].types[a.type] = (unitStats[a.businessUnit].types[a.type] || 0) + 1;
          });
          
          const businessUnitData = Object.entries(unitStats).map(([unit, stats]) => ({
            'Business Unit': unit,
            'Total Assessments': stats.totalAssessments,
            'Total Business Days': stats.totalBusinessDays,
            'Total Calendar Days': stats.totalCalendarDays,
            'Average Duration (Business Days)': Math.round(stats.totalBusinessDays / stats.totalAssessments),
            'Critical': stats.priorities.critical,
            'High': stats.priorities.high,
            'Medium': stats.priorities.medium,
            'Low': stats.priorities.low,
            'Most Common Type': Object.entries(stats.types).sort(([,a], [,b]) => b - a)[0]?.[0] || 'N/A',
            'Risk Score': (stats.priorities.critical * 4 + stats.priorities.high * 3 + stats.priorities.medium * 2 + stats.priorities.low * 1)
          }));
          
          const businessUnitWS = XLSX.utils.json_to_sheet(businessUnitData);
          XLSX.utils.book_append_sheet(wb, businessUnitWS, 'Business Unit Analysis');
          
          // Type Analysis Sheet
          const typeStats = {};
          yearAssessments.forEach(a => {
            if (!typeStats[a.type]) {
              typeStats[a.type] = {
                count: 0,
                totalBusinessDays: 0,
                totalCalendarDays: 0,
                priorities: { critical: 0, high: 0, medium: 0, low: 0 },
                businessUnits: new Set()
              };
            }
            
            typeStats[a.type].count++;
            typeStats[a.type].totalBusinessDays += this.getBusinessDays(a.startDate, a.endDate);
            typeStats[a.type].totalCalendarDays += this.getTotalDays(a.startDate, a.endDate);
            typeStats[a.type].priorities[a.priority]++;
            typeStats[a.type].businessUnits.add(a.businessUnit);
          });
          
          const typeAnalysisData = Object.entries(typeStats).map(([type, stats]) => ({
            'Assessment Type': type,
            'Count': stats.count,
            'Total Business Days': stats.totalBusinessDays,
            'Total Calendar Days': stats.totalCalendarDays,
            'Average Duration (Business Days)': Math.round(stats.totalBusinessDays / stats.count),
            'Critical': stats.priorities.critical,
            'High': stats.priorities.high,
            'Medium': stats.priorities.medium,
            'Low': stats.priorities.low,
            'Business Units': stats.businessUnits.size
          }));
          
          const typeAnalysisWS = XLSX.utils.json_to_sheet(typeAnalysisData);
          XLSX.utils.book_append_sheet(wb, typeAnalysisWS, 'Type Analysis');
          
          XLSX.writeFile(wb, `Security_Assessment_Schedule_${this.state.selectedYear}_Comprehensive.xlsx`);
          this.closeModal('exportModal');
          this.showNotification('Excel report generated successfully!', 'success');
          
        } catch (error) {
          console.error('Excel export error:', error);
          this.showNotification('Error generating Excel report. Please try again.', 'error');
        }
      },

      exportPDF() {
        try {
          this.showNotification('Generating professional PDF report...', 'info');
          
          const jsPDF = window.jspdf.jsPDF;
          
          if (!jsPDF) {
            throw new Error('PDF library not available');
          }
          
          const doc = new jsPDF('l', 'mm', 'a4');
          
          // Title page
          doc.setFillColor(30, 41, 59);
          doc.rect(0, 0, 297, 210, 'F');
          
          doc.setDrawColor(59, 130, 246);
          doc.setLineWidth(1);
          doc.line(30, 50, 267, 50);
          doc.line(30, 140, 267, 140);
          
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(42);
          doc.setFont(undefined, 'bold');
          doc.text('Security Assessment', 148.5, 80, { align: 'center' });
          doc.text('Schedule Report', 148.5, 100, { align: 'center' });
          
          doc.setFontSize(32);
          doc.setFont(undefined, 'normal');
          doc.text(`${this.state.selectedYear}`, 148.5, 125, { align: 'center' });
          
          doc.setFontSize(16);
          doc.text(`Generated: ${new Date().toLocaleDateString()}`, 148.5, 160, { align: 'center' });
          doc.text('CONFIDENTIAL - INTERNAL USE ONLY', 148.5, 180, { align: 'center' });
          
          // Executive Summary Page
          doc.addPage();
          doc.setFillColor(248, 250, 252);
          doc.rect(0, 0, 297, 40, 'F');
          
          doc.setTextColor(30, 41, 59);
          doc.setFontSize(28);
          doc.setFont(undefined, 'bold');
          doc.text('Executive Summary', 20, 30);
          
          const yearAssessments = this.state.assessments.filter(a => new Date(a.startDate).getFullYear() === parseInt(this.state.selectedYear));
          
          // KPI Cards
          const kpiY = 50;
          const kpiWidth = 65;
          const kpiHeight = 30;
          const kpiSpacing = 5;
          
          // Total Assessments
          doc.setFillColor(59, 130, 246);
          doc.roundedRect(20, kpiY, kpiWidth, kpiHeight, 5, 5, 'F');
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(12);
          doc.text('Total Assessments', 52.5, kpiY + 10, { align: 'center' });
          doc.setFontSize(22);
          doc.setFont(undefined, 'bold');
          doc.text(yearAssessments.length.toString(), 52.5, kpiY + 22, { align: 'center' });
          
          // Total Business Days
          doc.setFillColor(16, 185, 129);
          doc.roundedRect(20 + kpiWidth + kpiSpacing, kpiY, kpiWidth, kpiHeight, 5, 5, 'F');
          doc.setFontSize(12);
          doc.setFont(undefined, 'normal');
          doc.text('Business Days', 52.5 + kpiWidth + kpiSpacing, kpiY + 10, { align: 'center' });
          doc.setFontSize(22);
          doc.setFont(undefined, 'bold');
          doc.text(this.calculateTotalBusinessDays().toString(), 52.5 + kpiWidth + kpiSpacing, kpiY + 22, { align: 'center' });
          
          // Critical Priority
          doc.setFillColor(239, 68, 68);
          doc.roundedRect(20 + 2*(kpiWidth + kpiSpacing), kpiY, kpiWidth, kpiHeight, 5, 5, 'F');
          doc.setFontSize(12);
          doc.setFont(undefined, 'normal');
          doc.text('Critical Priority', 52.5 + 2*(kpiWidth + kpiSpacing), kpiY + 10, { align: 'center' });
          doc.setFontSize(22);
          doc.setFont(undefined, 'bold');
          doc.text(yearAssessments.filter(a => a.priority === 'critical').length.toString(), 52.5 + 2*(kpiWidth + kpiSpacing), kpiY + 22, { align: 'center' });
          
          // Business Units
          doc.setFillColor(139, 92, 246);
          doc.roundedRect(20 + 3*(kpiWidth + kpiSpacing), kpiY, kpiWidth, kpiHeight, 5, 5, 'F');
          doc.setFontSize(12);
          doc.setFont(undefined, 'normal');
          doc.text('Business Units', 52.5 + 3*(kpiWidth + kpiSpacing), kpiY + 10, { align: 'center' });
          doc.setFontSize(22);
          doc.setFont(undefined, 'bold');
          doc.text(this.getUniqueBusinessUnits().length.toString(), 52.5 + 3*(kpiWidth + kpiSpacing), kpiY + 22, { align: 'center' });
          
          // Summary statistics
          doc.setTextColor(30, 41, 59);
          doc.setFontSize(14);
          doc.setFont(undefined, 'normal');
          
          const statsY = 95;
          doc.text(`Average Assessment Duration: ${Math.round(this.calculateTotalBusinessDays() / (yearAssessments.length || 1))} business days`, 20, statsY);
          doc.text(`Highest Risk Business Unit: ${this.getHighestRiskUnit(yearAssessments)}`, 20, statsY + 10);
          doc.text(`Most Common Assessment Type: ${this.getMostCommonType(yearAssessments)}`, 20, statsY + 20);
          doc.text(`Peak Assessment Month: ${this.getPeakMonth(yearAssessments)}`, 20, statsY + 30);
          doc.text(`Total Calendar Days: ${this.calculateTotalDays()} (including weekends)`, 20, statsY + 40);
          
          // Priority Distribution
          const priorityData = [
            ['Priority Level', 'Count', 'Percentage', 'Risk Impact'],
            ['Critical', yearAssessments.filter(a => a.priority === 'critical').length.toString(), 
             Math.round((yearAssessments.filter(a => a.priority === 'critical').length / (yearAssessments.length || 1)) * 100) + '%', 'Immediate attention required'],
            ['High', yearAssessments.filter(a => a.priority === 'high').length.toString(),
             Math.round((yearAssessments.filter(a => a.priority === 'high').length / (yearAssessments.length || 1)) * 100) + '%', 'Significant business impact'],
            ['Medium', yearAssessments.filter(a => a.priority === 'medium').length.toString(),
             Math.round((yearAssessments.filter(a => a.priority === 'medium').length / (yearAssessments.length || 1)) * 100) + '%', 'Standard priority'],
            ['Low', yearAssessments.filter(a => a.priority === 'low').length.toString(),
             Math.round((yearAssessments.filter(a => a.priority === 'low').length / (yearAssessments.length || 1)) * 100) + '%', 'Routine maintenance']
          ];
          
          doc.autoTable({
            head: priorityData.slice(0, 1),
            body: priorityData.slice(1),
            startY: 150,
            styles: { fontSize: 11, cellPadding: 5 },
            headStyles: { fillColor: [51, 65, 84], textColor: [255, 255, 255], fontStyle: 'bold' },
            alternateRowStyles: { fillColor: [248, 250, 252] },
            margin: { left: 20, right: 20 }
          });
          
          // Assessment Details Page
          doc.addPage();
          doc.setFillColor(248, 250, 252);
          doc.rect(0, 0, 297, 40, 'F');
          
          doc.setTextColor(30, 41, 59);
          doc.setFontSize(28);
          doc.setFont(undefined, 'bold');
          doc.text('Assessment Schedule Details', 20, 30);
          
          const tableData = yearAssessments.map(a => {
            const businessDays = this.getBusinessDays(a.startDate, a.endDate);
            const totalDays = this.getTotalDays(a.startDate, a.endDate);
            
            return [
              a.target.length > 25 ? a.target.substring(0, 25) + '...' : a.target,
              a.businessUnit.length > 18 ? a.businessUnit.substring(0, 18) + '...' : a.businessUnit,
              a.type.length > 20 ? a.type.substring(0, 20) + '...' : a.type,
              a.priority.toUpperCase(),
              this.formatDate(a.startDate),
              this.formatDate(a.endDate),
              `${businessDays} (${totalDays} total)`
            ];
          });
          
          doc.autoTable({
            head: [['Target System', 'Business Unit', 'Assessment Type', 'Priority', 'Start Date', 'End Date', 'Duration']],
            body: tableData,
            startY: 45,
            styles: { fontSize: 9, cellPadding: 4 },
            headStyles: { fillColor: [51, 65, 84], textColor: [255, 255, 255], fontStyle: 'bold' },
            alternateRowStyles: { fillColor: [248, 250, 252] },
            columnStyles: {
              3: { cellWidth: 20, halign: 'center' },
              4: { cellWidth: 25 },
              5: { cellWidth: 25 },
              6: { cellWidth: 30, halign: 'center' }
            },
            margin: { left: 15, right: 15 }
          });
          
          // Footer on last page
          const pageCount = doc.internal.getNumberOfPages();
          doc.setPage(pageCount);
          doc.setFontSize(10);
          doc.setTextColor(100, 116, 139);
          doc.text('This document contains confidential security information. Distribution is restricted to authorized personnel only.', 148.5, 195, { align: 'center' });
          doc.text(`Page ${pageCount} of ${pageCount}`, 148.5, 200, { align: 'center' });
          
          doc.save(`Security_Assessment_Schedule_${this.state.selectedYear}_Professional.pdf`);
          this.closeModal('exportModal');
          this.showNotification('PDF report generated successfully!', 'success');
          
        } catch (error) {
          console.error('PDF export error:', error);
          this.showNotification('Error generating PDF report. Please try again.', 'error');
        }
      },

      // Helper functions for exports
      getHighestRiskUnit(assessments) {
        const unitRisk = {};
        assessments.forEach(a => {
          if (!unitRisk[a.businessUnit]) unitRisk[a.businessUnit] = 0;
          const riskScore = { critical: 4, high: 3, medium: 2, low: 1 }[a.priority];
          unitRisk[a.businessUnit] += riskScore;
        });
        
        const sorted = Object.entries(unitRisk).sort(([,a], [,b]) => b - a);
        return sorted[0] ? sorted[0][0] : 'N/A';
      },

      getMostCommonType(assessments) {
        const types = {};
        assessments.forEach(a => {
          types[a.type] = (types[a.type] || 0) + 1;
        });
        
        const sorted = Object.entries(types).sort(([,a], [,b]) => b - a);
        return sorted[0] ? sorted[0][0] : 'N/A';
      },

      getPeakMonth(assessments) {
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const monthCount = new Array(12).fill(0);
        
        assessments.forEach(a => {
          const startMonth = new Date(a.startDate).getMonth();
          const endMonth = new Date(a.endDate).getMonth();
          for (let m = startMonth; m <= endMonth; m++) {
            monthCount[m]++;
          }
        });
        
        const maxIndex = monthCount.indexOf(Math.max(...monthCount));
        return months[maxIndex];
      },

      // Word Export
      exportWord() {
        try {
          this.showNotification('Generating comprehensive Word document...', 'info');
          
          const yearAssessments = this.state.assessments.filter(a => new Date(a.startDate).getFullYear() === parseInt(this.state.selectedYear));
          
          const htmlContent = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Security Assessment Schedule Report ${this.state.selectedYear}</title>
  <style>
    @page {
      size: A4;
      margin: 2.5cm;
    }
    
    body {
      font-family: 'Calibri', 'Arial', sans-serif;
      line-height: 1.6;
      color: #1a202c;
      margin: 0;
      padding: 0;
    }
    
    .header {
      text-align: center;
      margin-bottom: 50px;
      page-break-after: always;
    }
    
    h1 {
      font-size: 36pt;
      color: #1e293b;
      margin-bottom: 20px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    
    h2 {
      font-size: 24pt;
      color: #334155;
      margin-top: 30px;
      margin-bottom: 20px;
      border-bottom: 3px solid #3b82f6;
      padding-bottom: 10px;
    }
    
    h3 {
      font-size: 18pt;
      color: #475569;
      margin-top: 25px;
      margin-bottom: 15px;
    }
    
    .subtitle {
      font-size: 20pt;
      color: #64748b;
      margin-bottom: 10px;
    }
    
    .metadata {
      font-size: 14pt;
      color: #94a3b8;
      margin-top: 30px;
    }
    
    .executive-summary {
      background-color: #f8fafc;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 30px;
      border-left: 5px solid #3b82f6;
    }
    
    .kpi-grid {
      display: table;
      width: 100%;
      margin: 30px 0;
    }
    
    .kpi-box {
      display: table-cell;
      width: 25%;
      background-color: #e0f2fe;
      padding: 20px;
      text-align: center;
      border: 1px solid #7dd3fc;
    }
    
    .kpi-value {
      font-size: 28pt;
      font-weight: bold;
      color: #0369a1;
      margin: 10px 0;
    }
    
    .kpi-label {
      font-size: 12pt;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 11pt;
    }
    
    th {
      background-color: #334155;
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    td {
      padding: 10px 12px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    tr:nth-child(even) {
      background-color: #f8fafc;
    }
    
    .priority-critical {
      background-color: #ef4444;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 10pt;
    }
    
    .priority-high {
      background-color: #f97316;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 10pt;
    }
    
    .priority-medium {
      background-color: #22c55e;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 10pt;
    }
    
    .priority-low {
      background-color: #3b82f6;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 10pt;
    }
    
    .section {
      margin-bottom: 40px;
      page-break-inside: avoid;
    }
    
    .footer {
      text-align: center;
      margin-top: 50px;
      padding-top: 20px;
      border-top: 2px solid #e2e8f0;
      color: #94a3b8;
      font-size: 10pt;
    }
    
    .confidential {
      background-color: #fef2f2;
      color: #991b1b;
      padding: 10px 20px;
      text-align: center;
      font-weight: bold;
      margin: 20px 0;
      border: 2px solid #fca5a5;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    ul {
      margin: 15px 0;
      padding-left: 30px;
    }
    
    li {
      margin-bottom: 8px;
      line-height: 1.8;
    }
    
    .highlight {
      background-color: #fef3c7;
      padding: 2px 6px;
    }
    
    .page-break {
      page-break-after: always;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Security Assessment Schedule</h1>
    <div class="subtitle">Comprehensive Planning Report</div>
    <div class="subtitle">Year ${this.state.selectedYear}</div>
    <div class="metadata">
      <p>Generated: ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
      <p>Time: ${new Date().toLocaleTimeString()}</p>
    </div>
    <div class="confidential">
      CONFIDENTIAL - INTERNAL USE ONLY
    </div>
  </div>
  
  <div class="section">
    <h2>Executive Summary</h2>
    <div class="executive-summary">
      <p>This comprehensive report provides a detailed analysis of the security assessment schedule for ${this.state.selectedYear}. 
      The document includes strategic insights, resource allocation, and risk prioritization to ensure optimal security coverage 
      across all business units. Business day calculations exclude weekends for accurate workload planning.</p>
      
      <div class="kpi-grid">
        <div class="kpi-box">
          <div class="kpi-label">Total Assessments</div>
          <div class="kpi-value">${yearAssessments.length}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">Business Days</div>
          <div class="kpi-value">${this.calculateTotalBusinessDays()}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">Business Units</div>
          <div class="kpi-value">${this.getUniqueBusinessUnits().length}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">Critical Priority</div>
          <div class="kpi-value">${yearAssessments.filter(a => a.priority === 'critical').length}</div>
        </div>
      </div>
      
      <h3>Key Insights</h3>
      <ul>
        <li><strong>Average Assessment Duration:</strong> <span class="highlight">${Math.round(this.calculateTotalBusinessDays() / (yearAssessments.length || 1))} business days</span></li>
        <li><strong>Total Calendar Days:</strong> <span class="highlight">${this.calculateTotalDays()} days</span> (including weekends)</li>
        <li><strong>Highest Risk Business Unit:</strong> <span class="highlight">${this.getHighestRiskUnit(yearAssessments)}</span></li>
        <li><strong>Most Common Assessment Type:</strong> <span class="highlight">${this.getMostCommonType(yearAssessments)}</span></li>
        <li><strong>Peak Assessment Month:</strong> <span class="highlight">${this.getPeakMonth(yearAssessments)}</span></li>
      </ul>
    </div>
  </div>
  
  <div class="section page-break">
    <h2>Assessment Schedule Details</h2>
    <p>The following table provides a comprehensive overview of all scheduled security assessments for ${this.state.selectedYear}, 
    with business day calculations for accurate resource planning:</p>
    
    <table>
      <thead>
        <tr>
          <th>Target System</th>
          <th>Business Unit</th>
          <th>Assessment Type</th>
          <th>Priority</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Duration</th>
        </tr>
      </thead>
      <tbody>
        ${yearAssessments.map(a => {
          const businessDays = this.getBusinessDays(a.startDate, a.endDate);
          const totalDays = this.getTotalDays(a.startDate, a.endDate);
          return `
            <tr>
              <td><strong>${a.target}</strong></td>
              <td>${a.businessUnit}</td>
              <td>${a.type}</td>
              <td><span class="priority-${a.priority}">${a.priority.toUpperCase()}</span></td>
              <td>${this.formatDate(a.startDate)}</td>
              <td>${this.formatDate(a.endDate)}</td>
              <td>${businessDays} business days<br>(${totalDays} total)</td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  </div>
  
  <div class="section">
    <h2>Priority Analysis</h2>
    <p>Understanding the distribution of assessment priorities is crucial for resource allocation and risk management:</p>
    
    <table>
      <thead>
        <tr>
          <th>Priority Level</th>
          <th>Count</th>
          <th>Percentage</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="priority-critical">CRITICAL</span></td>
          <td>${yearAssessments.filter(a => a.priority === 'critical').length}</td>
          <td>${Math.round((yearAssessments.filter(a => a.priority === 'critical').length / (yearAssessments.length || 1)) * 100)}%</td>
          <td>Immediate attention required, high business impact</td>
        </tr>
        <tr>
          <td><span class="priority-high">HIGH</span></td>
          <td>${yearAssessments.filter(a => a.priority === 'high').length}</td>
          <td>${Math.round((yearAssessments.filter(a => a.priority === 'high').length / (yearAssessments.length || 1)) * 100)}%</td>
          <td>Significant risk, prompt action needed</td>
        </tr>
        <tr>
          <td><span class="priority-medium">MEDIUM</span></td>
          <td>${yearAssessments.filter(a => a.priority === 'medium').length}</td>
          <td>${Math.round((yearAssessments.filter(a => a.priority === 'medium').length / (yearAssessments.length || 1)) * 100)}%</td>
          <td>Standard business priority</td>
        </tr>
        <tr>
          <td><span class="priority-low">LOW</span></td>
          <td>${yearAssessments.filter(a => a.priority === 'low').length}</td>
          <td>${Math.round((yearAssessments.filter(a => a.priority === 'low').length / (yearAssessments.length || 1)) * 100)}%</td>
          <td>Routine maintenance and improvements</td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <div class="section page-break">
    <h2>Business Unit Analysis</h2>
    <p>Assessment distribution across business units provides insights into organizational security coverage:</p>
    
    <table>
      <thead>
        <tr>
          <th>Business Unit</th>
          <th>Total Assessments</th>
          <th>Business Days</th>
          <th>Critical</th>
          <th>High</th>
          <th>Medium</th>
          <th>Low</th>
          <th>Risk Score</th>
        </tr>
      </thead>
      <tbody>
        ${(() => {
          const unitStats = {};
          yearAssessments.forEach(a => {
            if (!unitStats[a.businessUnit]) {
              unitStats[a.businessUnit] = {
                total: 0,
                businessDays: 0,
                critical: 0,
                high: 0,
                medium: 0,
                low: 0,
                riskScore: 0
              };
            }
            unitStats[a.businessUnit].total++;
            unitStats[a.businessUnit].businessDays += this.getBusinessDays(a.startDate, a.endDate);
            unitStats[a.businessUnit][a.priority]++;
            const riskValue = { critical: 4, high: 3, medium: 2, low: 1 }[a.priority];
            unitStats[a.businessUnit].riskScore += riskValue;
          });
          
          return Object.entries(unitStats)
            .sort(([,a], [,b]) => b.riskScore - a.riskScore)
            .map(([unit, stats]) => `
              <tr>
                <td><strong>${unit}</strong></td>
                <td>${stats.total}</td>
                <td>${stats.businessDays}</td>
                <td>${stats.critical}</td>
                <td>${stats.high}</td>
                <td>${stats.medium}</td>
                <td>${stats.low}</td>
                <td><strong>${stats.riskScore}</strong></td>
              </tr>
            `).join('');
        })()}
      </tbody>
    </table>
  </div>
  
  <div class="section">
    <h2>Strategic Recommendations</h2>
    <p>Based on the analysis of the security assessment schedule, the following recommendations are provided:</p>
    
    <h3>1. Priority Management</h3>
    <ul>
      <li>Focus immediate resources on the <strong>${yearAssessments.filter(a => a.priority === 'critical').length} critical priority assessments</strong></li>
      <li>Implement a quarterly review process for priority reassessment</li>
      <li>Establish clear escalation procedures for priority changes</li>
    </ul>
    
    <h3>2. Resource Optimization</h3>
    <ul>
      <li>Balance workload across business days to avoid resource bottlenecks</li>
      <li>Peak month <strong>${this.getPeakMonth(yearAssessments)}</strong> requires additional resource planning</li>
      <li>Consider cross-training teams to handle multiple assessment types</li>
      <li>Weekend exclusions ensure accurate resource planning</li>
    </ul>
    
    <h3>3. Risk Mitigation</h3>
    <ul>
      <li>Prioritize <strong>${this.getHighestRiskUnit(yearAssessments)}</strong> for enhanced security measures</li>
      <li>Implement continuous monitoring for critical systems</li>
      <li>Develop rapid response protocols for high-risk findings</li>
    </ul>
  </div>
  
  <div class="footer">
    <div class="confidential">
      This document contains confidential and proprietary information
    </div>
    <p> ${new Date().getFullYear()} Security Department. All rights reserved.</p>
    <p>Document Classification: CONFIDENTIAL | Distribution: RESTRICTED</p>
  </div>
</body>
</html>`;
          
          const blob = new Blob(['\ufeff', htmlContent], {
            type: 'application/msword'
          });
          
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Security_Assessment_Report_${this.state.selectedYear}.doc`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          this.closeModal('exportModal');
          this.showNotification('Word document generated successfully!', 'success');
          
        } catch (error) {
          console.error('Word export error:', error);
          this.showNotification('Error generating Word document. Please try again.', 'error');
        }
      },

      // HTML Export
      exportHTML() {
        try {
          this.showNotification('Generating interactive HTML report...', 'info');
          
          const yearAssessments = this.state.assessments.filter(a => new Date(a.startDate).getFullYear() === parseInt(this.state.selectedYear));
          
          const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Security Assessment Schedule ${this.state.selectedYear} - Interactive Report</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
      color: #1a202c; 
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
      background: white; 
      box-shadow: 0 25px 50px rgba(0,0,0,0.1); 
      border-radius: 0 0 24px 24px;
    }
    
    .header { 
      background: linear-gradient(135deg, #1e293b, #334155); 
      color: white; 
      padding: 80px 40px; 
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
      animation: pulse 4s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .header h1 { 
      font-size: 3.5em; 
      font-weight: 800; 
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
      text-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .header p { 
      font-size: 1.4em; 
      opacity: 0.95;
      position: relative;
      z-index: 1;
    }
    
    nav {
      background: #f8fafc;
      padding: 0;
      border-bottom: 1px solid #e2e8f0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    nav ul {
      list-style: none;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    nav li {
      margin: 0;
    }
    
    nav a {
      display: block;
      padding: 20px 30px;
      color: #475569;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }
    
    nav a:hover {
      background: #e2e8f0;
      color: #1e293b;
      border-bottom-color: #3b82f6;
    }
    
    nav a.active {
      background: white;
      color: #3b82f6;
      border-bottom-color: #3b82f6;
    }
    
    .content {
      padding: 60px 40px;
    }
    
    .section {
      margin-bottom: 60px;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.6s ease forwards;
    }
    
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .section:nth-child(1) { animation-delay: 0.1s; }
    .section:nth-child(2) { animation-delay: 0.2s; }
    .section:nth-child(3) { animation-delay: 0.3s; }
    .section:nth-child(4) { animation-delay: 0.4s; }
    
    h2 {
      font-size: 2.5em;
      color: #1e293b;
      margin-bottom: 30px;
      position: relative;
      padding-left: 20px;
    }
    
    h2::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 5px;
      height: 80%;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border-radius: 10px;
    }
    
    .stats-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
      gap: 30px; 
      margin-bottom: 60px;
    }
    
    .stat-card { 
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      padding: 40px; 
      border-radius: 20px; 
      text-align: center; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      border: 1px solid #e2e8f0;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    }
    
    .stat-card:hover { 
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    
    .stat-card i {
      font-size: 3em;
      margin-bottom: 20px;
      color: #3b82f6;
    }
    
    .stat-card h3 { 
      color: #64748b; 
      font-size: 14px; 
      font-weight: 700; 
      text-transform: uppercase; 
      letter-spacing: 1px;
      margin-bottom: 10px;
    }
    
    .stat-card p { 
      font-size: 3em; 
      font-weight: 800; 
      color: #1e293b; 
      margin: 0;
    }
    
    .stat-card .subtext {
      font-size: 14px;
      color: #64748b;
      margin-top: 10px;
      font-weight: 600;
    }
    
    table { 
      width: 100%; 
      border-collapse: separate; 
      border-spacing: 0;
      margin-top: 30px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      border-radius: 16px;
      overflow: hidden;
    }
    
    th, td { 
      padding: 18px 24px; 
      text-align: left; 
    }
    
    th { 
      background: linear-gradient(135deg, #334155, #475569); 
      color: white; 
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 13px;
    }
    
    td {
      border-bottom: 1px solid #f1f5f9;
      font-size: 14px;
    }
    
    tr {
      transition: all 0.2s ease;
    }
    
    tr:hover { 
      background: linear-gradient(90deg, #f8fafc, #f1f5f9);
      transform: translateX(5px);
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    .priority-badge {
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-block;
    }
    
    .priority-critical { 
      background: linear-gradient(135deg, #ef4444, #dc2626); 
      color: white;
      box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
    }
    
    .priority-high { 
      background: linear-gradient(135deg, #f97316, #ea580c); 
      color: white;
      box-shadow: 0 4px 10px rgba(249, 115, 22, 0.3);
    }
    
    .priority-medium { 
      background: linear-gradient(135deg, #22c55e, #16a34a); 
      color: white;
      box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3);
    }
    
    .priority-low { 
      background: linear-gradient(135deg, #3b82f6, #2563eb); 
      color: white;
      box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
    }
    
    .chart-container {
      background: #f8fafc;
      padding: 40px;
      border-radius: 20px;
      margin: 30px 0;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      text-align: center;
    }
    
    .footer { 
      padding: 40px; 
      text-align: center; 
      background: linear-gradient(135deg, #1e293b, #334155);
      color: #94a3b8;
      font-size: 14px;
    }
    
    .footer a {
      color: #60a5fa;
      text-decoration: none;
    }
    
    .footer a:hover {
      text-decoration: underline;
    }
    
    #scrollTop {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
      transition: all 0.3s ease;
      opacity: 0;
      transform: scale(0.8);
      font-size: 24px;
    }
    
    #scrollTop.visible {
      opacity: 1;
      transform: scale(1);
    }
    
    #scrollTop:hover {
      transform: scale(1.1);
      box-shadow: 0 15px 35px rgba(59, 130, 246, 0.5);
    }
    
    .search-box {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .search-box input {
      flex: 1;
      padding: 15px 20px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }
    
    .search-box button {
      padding: 15px 30px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .search-box button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
    }
    
    .duration-info {
      font-size: 12px;
      color: #64748b;
      margin-top: 2px;
    }
    
    @media (max-width: 768px) {
      .header h1 { font-size: 2.5em; }
      .stats-grid { grid-template-columns: 1fr; }
      nav ul { flex-wrap: wrap; }
      nav a { padding: 15px 20px; }
      table { font-size: 12px; }
      th, td { padding: 12px; }
      .content { padding: 30px 20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Security Assessment Schedule ${this.state.selectedYear}</h1>
      <p>Comprehensive Interactive Assessment Report</p>
      <p style="margin-top: 20px; opacity: 0.8;">Generated: ${new Date().toLocaleString()}</p>
    </div>
    
    <nav>
      <ul>
        <li><a href="#overview" class="active"><i class="fas fa-home"></i> Overview</a></li>
        <li><a href="#schedule"><i class="fas fa-calendar"></i> Schedule</a></li>
        <li><a href="#analytics"><i class="fas fa-chart-bar"></i> Analytics</a></li>
        <li><a href="#business-units"><i class="fas fa-building"></i> Business Units</a></li>
      </ul>
    </nav>
    
    <div class="content">
      <div id="overview" class="section">
        <h2><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
        
        <div class="stats-grid">
          <div class="stat-card">
            <i class="fas fa-shield-alt"></i>
            <h3>Total Assessments</h3>
            <p>${yearAssessments.length}</p>
            <div class="subtext">Scheduled for ${this.state.selectedYear}</div>
          </div>
          <div class="stat-card">
            <i class="fas fa-calendar-days"></i>
            <h3>Total Business Days</h3>
            <p>${this.calculateTotalBusinessDays()}</p>
            <div class="subtext">${Math.round(this.calculateTotalBusinessDays() / (yearAssessments.length || 1))} days average</div>
          </div>
          <div class="stat-card">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Critical Priority</h3>
            <p>${yearAssessments.filter(a => a.priority === 'critical').length}</p>
            <div class="subtext">${Math.round((yearAssessments.filter(a => a.priority === 'critical').length / (yearAssessments.length || 1)) * 100)}% of total</div>
          </div>
          <div class="stat-card">
            <i class="fas fa-building"></i>
            <h3>Business Units</h3>
            <p>${this.getUniqueBusinessUnits().length}</p>
            <div class="subtext">Unique departments</div>
          </div>
        </div>
      </div>
      
      <div id="schedule" class="section">
        <h2><i class="fas fa-list-check"></i> Assessment Schedule Details</h2>
        
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search by target, business unit, or assessment type...">
          <button onclick="filterTable()"><i class="fas fa-search"></i> Search</button>
        </div>
        
        <table id="assessmentTable">
          <thead>
            <tr>
              <th onclick="sortTable(0)">Target System <i class="fas fa-sort"></i></th>
              <th onclick="sortTable(1)">Business Unit <i class="fas fa-sort"></i></th>
              <th onclick="sortTable(2)">Assessment Type <i class="fas fa-sort"></i></th>
              <th onclick="sortTable(3)">Priority <i class="fas fa-sort"></i></th>
              <th onclick="sortTable(4)">Start Date <i class="fas fa-sort"></i></th>
              <th onclick="sortTable(5)">End Date <i class="fas fa-sort"></i></th>
              <th>Duration</th>
            </tr>
          </thead>
          <tbody>
            ${yearAssessments.map(a => {
              const businessDays = this.getBusinessDays(a.startDate, a.endDate);
              const totalDays = this.getTotalDays(a.startDate, a.endDate);
              return `<tr>
                <td><strong>${a.target}</strong></td>
                <td>${a.businessUnit}</td>
                <td>${a.type}</td>
                <td><span class="priority-badge priority-${a.priority}">${a.priority}</span></td>
                <td>${this.formatDate(a.startDate)}</td>
                <td>${this.formatDate(a.endDate)}</td>
                <td>
                  ${businessDays} business days
                  <div class="duration-info">(${totalDays} total days)</div>
                </td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
      
      <div id="analytics" class="section">
        <h2><i class="fas fa-chart-pie"></i> Analytics & Insights</h2>
        
        <div class="chart-container">
          <h3>Priority Distribution</h3>
          <canvas id="priorityChart" width="400" height="200"></canvas>
        </div>
        
        <div class="chart-container">
          <h3>Monthly Workload</h3>
          <canvas id="workloadChart" width="400" height="200"></canvas>
        </div>
      </div>
      
      <div id="business-units" class="section">
        <h2><i class="fas fa-building"></i> Business Unit Analysis</h2>
        
        <table>
          <thead>
            <tr>
              <th>Business Unit</th>
              <th>Total Assessments</th>
              <th>Business Days</th>
              <th>Critical</th>
              <th>High</th>
              <th>Medium</th>
              <th>Low</th>
              <th>Risk Score</th>
            </tr>
          </thead>
          <tbody>
            ${(() => {
              const unitStats = {};
              yearAssessments.forEach(a => {
                if (!unitStats[a.businessUnit]) {
                  unitStats[a.businessUnit] = {
                    total: 0,
                    businessDays: 0,
                    critical: 0,
                    high: 0,
                    medium: 0,
                    low: 0,
                    riskScore: 0
                  };
                }
                unitStats[a.businessUnit].total++;
                unitStats[a.businessUnit].businessDays += this.getBusinessDays(a.startDate, a.endDate);
                unitStats[a.businessUnit][a.priority]++;
                const riskValue = { critical: 4, high: 3, medium: 2, low: 1 }[a.priority];
                unitStats[a.businessUnit].riskScore += riskValue;
              });
              
              return Object.entries(unitStats)
                .sort(([,a], [,b]) => b.riskScore - a.riskScore)
                .map(([unit, stats]) => `
                  <tr>
                    <td><strong>${unit}</strong></td>
                    <td>${stats.total}</td>
                    <td>${stats.businessDays}</td>
                    <td>${stats.critical}</td>
                    <td>${stats.high}</td>
                    <td>${stats.medium}</td>
                    <td>${stats.low}</td>
                    <td><strong>${stats.riskScore}</strong></td>
                  </tr>
                `).join('');
            })()}
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="footer">
      <p>This document contains confidential information. Distribution is restricted to authorized personnel only.</p>
      <p>Generated by Security Assessment Scheduler Pro | <a href="#">View Documentation</a></p>
    </div>
  </div>
  
  <div id="scrollTop" onclick="scrollToTop()">
    <i class="fas fa-arrow-up"></i>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
  <script>
    // Smooth scrolling for navigation
    document.querySelectorAll('nav a').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
        this.classList.add('active');
        const targetId = this.getAttribute('href').substring(1);
        const targetSection = document.getElementById(targetId);
        if (targetSection) {
          targetSection.scrollIntoView({ behavior: 'smooth' });
        }
      });
    });
    
    // Scroll to top button
    window.addEventListener('scroll', () => {
      const scrollBtn = document.getElementById('scrollTop');
      if (window.pageYOffset > 300) {
        scrollBtn.classList.add('visible');
      } else {
        scrollBtn.classList.remove('visible');
      }
    });
    
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Table search functionality
    function filterTable() {
      const input = document.getElementById('searchInput');
      const filter = input.value.toUpperCase();
      const table = document.getElementById('assessmentTable');
      const tr = table.getElementsByTagName('tr');
      
      for (let i = 1; i < tr.length; i++) {
        let td = tr[i].getElementsByTagName('td');
        let found = false;
        
        for (let j = 0; j < td.length; j++) {
          if (td[j]) {
            let txtValue = td[j].textContent || td[j].innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
              found = true;
              break;
            }
          }
        }
        
        tr[i].style.display = found ? '' : 'none';
      }
    }
    
    // Table sorting
    function sortTable(n) {
      const table = document.getElementById('assessmentTable');
      let rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
      switching = true;
      dir = 'asc';
      
      while (switching) {
        switching = false;
        rows = table.rows;
        
        for (i = 1; i < (rows.length - 1); i++) {
          shouldSwitch = false;
          x = rows[i].getElementsByTagName('TD')[n];
          y = rows[i + 1].getElementsByTagName('TD')[n];
          
          if (dir == 'asc') {
            if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
              shouldSwitch = true;
              break;
            }
          } else if (dir == 'desc') {
            if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
              shouldSwitch = true;
              break;
            }
          }
        }
        
        if (shouldSwitch) {
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
          switchcount++;
        } else {
          if (switchcount == 0 && dir == 'asc') {
            dir = 'desc';
            switching = true;
          }
        }
      }
    }
    
    // Initialize charts
    const priorityData = {
      labels: ['Critical', 'High', 'Medium', 'Low'],
      datasets: [{
        data: [
          ${yearAssessments.filter(a => a.priority === 'critical').length},
          ${yearAssessments.filter(a => a.priority === 'high').length},
          ${yearAssessments.filter(a => a.priority === 'medium').length},
          ${yearAssessments.filter(a => a.priority === 'low').length}
        ],
        backgroundColor: ['#ef4444', '#f97316', '#22c55e', '#3b82f6'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    };
    
    new Chart(document.getElementById('priorityChart'), {
      type: 'doughnut',
      data: priorityData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 20,
              font: {
                size: 14,
                weight: '600'
              }
            }
          }
        }
      }
    });
    
    // Monthly workload data
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const workloadData = [${this.SchedulingEngine.getWorkloadDistribution(yearAssessments, this.state.selectedYear).join(', ')}];
    
    new Chart(document.getElementById('workloadChart'), {
      type: 'bar',
      data: {
        labels: months,
        datasets: [{
          label: 'Active Assessments',
          data: workloadData,
          backgroundColor: '#3b82f6',
          borderRadius: 8,
          hoverBackgroundColor: '#2563eb'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  
</body>
</html>`;
          
          const blob = new Blob([htmlContent], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Security_Assessment_Interactive_Report_${this.state.selectedYear}.html`;
          a.click();
          URL.revokeObjectURL(url);
          
          this.closeModal('exportModal');
          this.showNotification('Interactive HTML report generated!', 'success');
          
        } catch (error) {
          console.error('HTML export error:', error);
          this.showNotification('Error generating HTML report. Please try again.', 'error');
        }
      },

      // JSON Export
      exportJSON() {
        try {
          this.showNotification('Generating JSON data export...', 'info');
          
          const yearAssessments = this.state.assessments.filter(a => new Date(a.startDate).getFullYear() === parseInt(this.state.selectedYear));
          
          const exportData = {
            metadata: {
              reportTitle: 'Security Assessment Schedule Export',
              reportYear: this.state.selectedYear,
              generatedDate: new Date().toISOString(),
              generatedBy: 'Security Assessment Scheduler Pro',
              version: '2.0',
              exportFormat: 'JSON',
              dataIntegrity: {
                totalRecords: yearAssessments.length,
                checksum: this.generateChecksum(yearAssessments)
              }
            },
            
            summary: {
              overview: {
                totalAssessments: yearAssessments.length,
                totalBusinessDays: this.calculateTotalBusinessDays(),
                totalCalendarDays: this.calculateTotalDays(),
                averageBusinessDays: yearAssessments.length > 0 ? Math.round(this.calculateTotalBusinessDays() / yearAssessments.length) : 0,
                averageCalendarDays: yearAssessments.length > 0 ? Math.round(this.calculateTotalDays() / yearAssessments.length) : 0,
                uniqueBusinessUnits: this.getUniqueBusinessUnits().length,
                dateRange: {
                  earliest: yearAssessments.length > 0 ? 
                    yearAssessments.reduce((min, a) => new Date(a.startDate) < new Date(min) ? a.startDate : min, yearAssessments[0].startDate) : null,
                  latest: yearAssessments.length > 0 ?
                    yearAssessments.reduce((max, a) => new Date(a.endDate) > new Date(max) ? a.endDate : max, yearAssessments[0].endDate) : null
                }
              },
              
              priorityBreakdown: {
                critical: {
                  count: yearAssessments.filter(a => a.priority === 'critical').length,
                  percentage: Math.round((yearAssessments.filter(a => a.priority === 'critical').length / (yearAssessments.length || 1)) * 100),
                  averageBusinessDays: this.getAverageBusinessDaysByPriority(yearAssessments, 'critical')
                },
                high: {
                  count: yearAssessments.filter(a => a.priority === 'high').length,
                  percentage: Math.round((yearAssessments.filter(a => a.priority === 'high').length / (yearAssessments.length || 1)) * 100),
                  averageBusinessDays: this.getAverageBusinessDaysByPriority(yearAssessments, 'high')
                },
                medium: {
                  count: yearAssessments.filter(a => a.priority === 'medium').length,
                  percentage: Math.round((yearAssessments.filter(a => a.priority === 'medium').length / (yearAssessments.length || 1)) * 100),
                  averageBusinessDays: this.getAverageBusinessDaysByPriority(yearAssessments, 'medium')
                },
                low: {
                  count: yearAssessments.filter(a => a.priority === 'low').length,
                  percentage: Math.round((yearAssessments.filter(a => a.priority === 'low').length / (yearAssessments.length || 1)) * 100),
                  averageBusinessDays: this.getAverageBusinessDaysByPriority(yearAssessments, 'low')
                }
              },
              
              typeBreakdown: (() => {
                const types = {};
                yearAssessments.forEach(a => {
                  if (!types[a.type]) {
                    types[a.type] = {
                      count: 0,
                      totalBusinessDays: 0,
                      totalCalendarDays: 0,
                      businessUnits: new Set(),
                      priorities: { critical: 0, high: 0, medium: 0, low: 0 }
                    };
                  }
                  types[a.type].count++;
                  types[a.type].totalBusinessDays += this.getBusinessDays(a.startDate, a.endDate);
                  types[a.type].totalCalendarDays += this.getTotalDays(a.startDate, a.endDate);
                  types[a.type].businessUnits.add(a.businessUnit);
                  types[a.type].priorities[a.priority]++;
                });
                
                Object.keys(types).forEach(type => {
                  types[type].averageBusinessDays = Math.round(types[type].totalBusinessDays / types[type].count);
                  types[type].averageCalendarDays = Math.round(types[type].totalCalendarDays / types[type].count);
                  types[type].businessUnits = Array.from(types[type].businessUnits);
                });
                
                return types;
              })(),
              
              monthlyWorkload: {
                distribution: this.SchedulingEngine.getWorkloadDistribution(yearAssessments, this.state.selectedYear),
                peak: {
                  month: this.getPeakMonth(yearAssessments),
                  assessmentCount: Math.max(...this.SchedulingEngine.getWorkloadDistribution(yearAssessments, this.state.selectedYear))
                }
              }
            },
            
            assessments: yearAssessments.map(a => ({
              id: a.id,
              target: a.target,
              businessUnit: a.businessUnit,
              type: a.type,
              priority: a.priority,
              dates: {
                start: a.startDate,
                end: a.endDate,
                businessDays: this.getBusinessDays(a.startDate, a.endDate),
                calendarDays: this.getTotalDays(a.startDate, a.endDate),
                excludeWeekends: a.excludeWeekends !== undefined ? a.excludeWeekends : true
              },
              notes: a.notes || null,
              customFields: a.customFields || [],
              metadata: {
                createdAt: a.createdAt,
                updatedAt: a.updatedAt,
                quarter: `Q${Math.floor(new Date(a.startDate).getMonth() / 3) + 1}`,
                weekNumber: this.getWeekNumber(new Date(a.startDate))
              },
              riskScore: { critical: 4, high: 3, medium: 2, low: 1 }[a.priority]
            })),
            
            businessUnits: this.getUniqueBusinessUnits().map(unit => {
              const unitAssessments = yearAssessments.filter(a => a.businessUnit === unit);
              return {
                name: unit,
                statistics: {
                  totalAssessments: unitAssessments.length,
                  totalBusinessDays: unitAssessments.reduce((sum, a) => {
                    return sum + this.getBusinessDays(a.startDate, a.endDate);
                  }, 0),
                  totalCalendarDays: unitAssessments.reduce((sum, a) => {
                    return sum + this.getTotalDays(a.startDate, a.endDate);
                  }, 0),
                  averageBusinessDays: unitAssessments.length > 0 ? Math.round(unitAssessments.reduce((sum, a) => {
                    return sum + this.getBusinessDays(a.startDate, a.endDate);
                  }, 0) / unitAssessments.length) : 0,
                  riskScore: unitAssessments.reduce((sum, a) => {
                    const score = { critical: 4, high: 3, medium: 2, low: 1 }[a.priority];
                    return sum + score;
                  }, 0),
                  priorityDistribution: {
                    critical: unitAssessments.filter(a => a.priority === 'critical').length,
                    high: unitAssessments.filter(a => a.priority === 'high').length,
                    medium: unitAssessments.filter(a => a.priority === 'medium').length,
                    low: unitAssessments.filter(a => a.priority === 'low').length
                  },
                  typeDistribution: (() => {
                    const types = {};
                    unitAssessments.forEach(a => {
                      types[a.type] = (types[a.type] || 0) + 1;
                    });
                    return types;
                  })(),
                  assessmentIds: unitAssessments.map(a => a.id)
                }
              };
            }),
            
            analytics: {
              trends: {
                assessmentGrowth: (() => {
                  const prevYearCount = this.state.assessments.filter(a => 
                    new Date(a.startDate).getFullYear() === this.state.selectedYear - 1
                  ).length;
                  
                  return {
                    previousYear: prevYearCount,
                    currentYear: yearAssessments.length,
                    growthRate: prevYearCount > 0 ? 
                      Math.round(((yearAssessments.length - prevYearCount) / prevYearCount) * 100) : 0
                  };
                })(),
                
                quarterlyDistribution: [1, 2, 3, 4].map(q => ({
                  quarter: `Q${q}`,
                  assessmentCount: yearAssessments.filter(a => {
                    const month = new Date(a.startDate).getMonth();
                    return Math.floor(month / 3) + 1 === q;
                  }).length
                }))
              },
              
              insights: {
                mostBusyMonth: this.getPeakMonth(yearAssessments),
                highestRiskUnit: this.getHighestRiskUnit(yearAssessments),
                mostCommonType: this.getMostCommonType(yearAssessments),
                averageAssessmentsPerUnit: Math.round(yearAssessments.length / (this.getUniqueBusinessUnits().length || 1)),
                weekendExclusionRate: Math.round((yearAssessments.filter(a => a.excludeWeekends !== false).length / (yearAssessments.length || 1)) * 100)
              }
            }
          };
          
          const jsonString = JSON.stringify(exportData, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Security_Assessment_Data_${this.state.selectedYear}_Complete.json`;
          a.click();
          URL.revokeObjectURL(url);
          
          this.closeModal('exportModal');
          this.showNotification('JSON data export completed successfully!', 'success');
          
        } catch (error) {
          console.error('JSON export error:', error);
          this.showNotification('Error generating JSON export. Please try again.', 'error');
        }
      },

      // Helper functions for JSON export
      generateChecksum(data) {
        const str = JSON.stringify(data);
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }
        return Math.abs(hash).toString(16);
      },

      getAverageBusinessDaysByPriority(assessments, priority) {
        const filtered = assessments.filter(a => a.priority === priority);
        if (filtered.length === 0) return 0;
        
        const totalDays = filtered.reduce((sum, a) => {
          return sum + this.getBusinessDays(a.startDate, a.endDate);
        }, 0);
        
        return Math.round(totalDays / filtered.length);
      },

      getWeekNumber(date) {
        const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
        const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
        return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
      }
    };

    // Initialize the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      SecurityScheduler.init();
    });
  </script>
</body>
</html>






