<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise STIG Compliance Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'inter': ['Inter', 'sans-serif'] },
                    colors: {
                        'brand': '#0066cc',
                        'brand-dark': '#004499',
                        'brand-light': '#3399ff',
                        'success': '#00c851',
                        'danger': '#ff4444',
                        'warning': '#ffbb33',
                        'info': '#00bcd4'
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
        .animate-slideUp { animation: slideUp 0.5s ease-out; }
        .animate-bounce { animation: bounce 0.6s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0, -20px, 0); }
            70% { transform: translate3d(0, -10px, 0); }
            90% { transform: translate3d(0, -4px, 0); }
        }
        
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        
        .btn-primary { background: linear-gradient(135deg, #0066cc 0%, #004499 100%); }
        .btn-primary:hover { background: linear-gradient(135deg, #004499 0%, #003366 100%); }
        
        .nav-tab { transition: all 0.3s ease; border-bottom: 3px solid transparent; }
        .nav-tab.active { border-bottom-color: #0066cc; background-color: #f0f8ff; }
        .nav-tab:hover { background-color: #f8fafc; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .table-hover:hover { background-color: #f8fafc; }
        
        .progress-bar { transition: width 0.8s ease-in-out; }
        .metric-hover:hover { transform: scale(1.02); }
        
        .gradient-bg { background: linear-gradient(135deg, #0066cc 0%, #003d7a 100%); }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-xl sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center justify-center w-12 h-12 bg-white/20 rounded-xl backdrop-blur">
                        <i class="fas fa-shield-check text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Enterprise STIG Manager</h1>
                        <p class="text-white/80 text-sm">Security Technical Implementation Guide Compliance</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-6">
                    <div class="hidden md:flex items-center space-x-4 text-sm">
                        <div class="bg-white/20 rounded-lg px-3 py-2 backdrop-blur">
                            <i class="fas fa-database mr-2"></i>
                            <span id="headerTotal" class="font-semibold">0</span> Requirements
                        </div>
                        <div class="bg-white/20 rounded-lg px-3 py-2 backdrop-blur">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span id="headerCompliant" class="font-semibold">0%</span> Compliant
                        </div>
                    </div>
                    
                    <button id="exportBtn" onclick="showExportModal()" class="hidden bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-medium transition-all">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white border-b border-gray-200 sticky top-16 z-40">
        <div class="container mx-auto px-6">
            <div class="flex space-x-0 overflow-x-auto">
                <button class="nav-tab active px-6 py-4 text-sm font-medium whitespace-nowrap" data-tab="upload">
                    <i class="fas fa-upload mr-2"></i>Upload & Parse
                </button>
                <button class="nav-tab px-6 py-4 text-sm font-medium whitespace-nowrap" data-tab="dashboard">
                    <i class="fas fa-chart-pie mr-2"></i>Dashboard
                </button>
                <button class="nav-tab px-6 py-4 text-sm font-medium whitespace-nowrap" data-tab="requirements">
                    <i class="fas fa-list-check mr-2"></i>Requirements
                </button>
                <button class="nav-tab px-6 py-4 text-sm font-medium whitespace-nowrap" data-tab="analytics">
                    <i class="fas fa-chart-line mr-2"></i>Analytics
                </button>
                <button class="nav-tab px-6 py-4 text-sm font-medium whitespace-nowrap" data-tab="compliance">
                    <i class="fas fa-clipboard-check mr-2"></i>Compliance
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Upload Section -->
        <section id="upload" class="tab-section active">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-bold text-gray-900 mb-4">STIG File Parser</h2>
                    <p class="text-xl text-gray-600">Upload your Security Technical Implementation Guide JSON file</p>
                </div>

                <!-- Upload Card -->
                <div class="card p-12 mb-8 text-center animate-fadeIn">
                    <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-2xl p-16 hover:border-brand hover:bg-blue-50 transition-all duration-300 cursor-pointer group">
                        <div class="flex flex-col items-center">
                            <div class="w-24 h-24 bg-gradient-to-r from-brand to-brand-dark rounded-full flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                                <i class="fas fa-cloud-upload-alt text-3xl text-white"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-3">Drop STIG JSON File</h3>
                            <p class="text-gray-600 mb-8 max-w-md">Drag and drop your STIG JSON file here or click to browse</p>
                            <button class="btn-primary text-white px-8 py-4 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all">
                                <i class="fas fa-folder-open mr-2"></i>Choose File
                            </button>
                            <p class="text-sm text-gray-500 mt-4">Supports JSON files up to 100MB</p>
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept=".json" class="hidden">
                </div>

                <!-- Progress Section -->
                <div id="progressSection" class="hidden">
                    <div class="card p-8 mb-8 animate-slideUp">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-4">
                                <div class="animate-spin w-8 h-8 border-4 border-brand border-t-transparent rounded-full"></div>
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-900">Processing STIG File</h3>
                                    <p class="text-gray-600" id="progressMessage">Starting...</p>
                                </div>
                            </div>
                            <div class="text-3xl font-bold text-brand" id="progressPercent">0%</div>
                        </div>
                        
                        <div class="relative">
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div id="progressBar" class="progress-bar h-4 bg-gradient-to-r from-brand to-brand-dark rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-6 mt-8 text-center">
                            <div>
                                <div class="text-2xl font-bold text-gray-900" id="parsedCount">0</div>
                                <div class="text-sm text-gray-600">Parsed</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-gray-900" id="validatedCount">0</div>
                                <div class="text-sm text-gray-600">Validated</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-gray-900" id="processedCount">0</div>
                                <div class="text-sm text-gray-600">Processed</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 animate-bounce">
                        <div class="card p-6 text-center metric-hover">
                            <div class="text-3xl font-bold text-gray-900" id="totalParsed">0</div>
                            <div class="text-gray-600">Total Requirements</div>
                        </div>
                        <div class="card p-6 text-center metric-hover">
                            <div class="text-3xl font-bold text-danger" id="highSeverity">0</div>
                            <div class="text-gray-600">High Risk</div>
                        </div>
                        <div class="card p-6 text-center metric-hover">
                            <div class="text-3xl font-bold text-warning" id="mediumSeverity">0</div>
                            <div class="text-gray-600">Medium Risk</div>
                        </div>
                        <div class="card p-6 text-center metric-hover">
                            <div class="text-3xl font-bold text-success" id="lowSeverity">0</div>
                            <div class="text-gray-600">Low Risk</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard" class="tab-section hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Compliance Dashboard</h2>
                <p class="text-xl text-gray-600">Real-time overview of STIG compliance metrics</p>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                <div class="card p-6 metric-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-2">Total Requirements</p>
                            <p class="text-3xl font-bold text-gray-900" id="dashTotal">0</p>
                            <p class="text-sm text-brand">
                                <i class="fas fa-database mr-1"></i>
                                Loaded from STIG
                            </p>
                        </div>
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-list text-brand text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="card p-6 metric-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-2">Compliance Rate</p>
                            <p class="text-3xl font-bold text-gray-900" id="dashCompliance">0%</p>
                            <p class="text-sm text-success">
                                <i class="fas fa-arrow-up mr-1"></i>
                                <span id="complianceChange">0%</span> improvement
                            </p>
                        </div>
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-check-circle text-success text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="card p-6 metric-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-2">High Risk</p>
                            <p class="text-3xl font-bold text-gray-900" id="dashHighRisk">0</p>
                            <p class="text-sm text-danger">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                Immediate attention
                            </p>
                        </div>
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-danger text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="card p-6 metric-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-2">In Progress</p>
                            <p class="text-3xl font-bold text-gray-900" id="dashInProgress">0</p>
                            <p class="text-sm text-warning">
                                <i class="fas fa-clock mr-1"></i>
                                Under review
                            </p>
                        </div>
                        <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-clock text-warning text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Compliance Status</h3>
                    <div style="height: 300px;">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>

                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Risk Distribution</h3>
                    <div style="height: 300px;">
                        <canvas id="riskChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Progress by Category -->
            <div class="card p-8">
                <h3 class="text-xl font-semibold text-gray-900 mb-8">Progress by Risk Level</h3>
                <div class="space-y-8">
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-medium text-gray-700">High Risk</span>
                            <span class="text-sm text-gray-600">
                                <span id="highCompliant">0</span> / <span id="highTotal">0</span> Complete
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="progress-bar bg-danger h-4 rounded-full" id="highProgress" style="width: 0%"></div>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-medium text-gray-700">Medium Risk</span>
                            <span class="text-sm text-gray-600">
                                <span id="mediumCompliant">0</span> / <span id="mediumTotal">0</span> Complete
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="progress-bar bg-warning h-4 rounded-full" id="mediumProgress" style="width: 0%"></div>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-medium text-gray-700">Low Risk</span>
                            <span class="text-sm text-gray-600">
                                <span id="lowCompliant">0</span> / <span id="lowTotal">0</span> Complete
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="progress-bar bg-success h-4 rounded-full" id="lowProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Requirements Section -->
        <section id="requirements" class="tab-section hidden">
            <div class="mb-8">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-4">Requirements Management</h2>
                        <p class="text-xl text-gray-600">Manage and track individual STIG requirements</p>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="toggleView()" id="viewToggle" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-table mr-2"></i>Table View
                        </button>
                        <button onclick="exportRequirements()" class="btn-primary text-white px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card p-6 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="searchInput" placeholder="Search requirements..." 
                                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand focus:border-transparent">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Severity</label>
                        <select id="severityFilter" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand">
                            <option value="">All</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="statusFilter" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand">
                            <option value="">All</option>
                            <option value="compliant">Compliant</option>
                            <option value="non-compliant">Non-Compliant</option>
                            <option value="in-progress">In Progress</option>
                            <option value="not-reviewed">Not Reviewed</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-4 flex justify-between items-center text-sm text-gray-600">
                    <div>
                        Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> requirements
                    </div>
                    <button onclick="clearFilters()" class="text-brand hover:text-brand-dark">Clear Filters</button>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div id="bulkActions" class="hidden card p-4 mb-6 border-l-4 border-brand">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <i class="fas fa-check-square text-brand"></i>
                        <span class="font-medium text-brand">
                            <span id="selectedCount">0</span> requirements selected
                        </span>
                        <select id="bulkStatus" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Update Status</option>
                            <option value="compliant">Mark Compliant</option>
                            <option value="non-compliant">Mark Non-Compliant</option>
                            <option value="in-progress">Mark In Progress</option>
                        </select>
                        <button onclick="applyBulkUpdate()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm transition-all">
                            Apply
                        </button>
                    </div>
                    <button onclick="clearSelection()" class="text-brand hover:text-brand-dark text-sm">
                        Clear Selection
                    </button>
                </div>
            </div>

            <!-- Requirements Table -->
            <div id="requirementsTable" class="card overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="px-6 py-4 text-left">
                                    <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-brand focus:ring-brand">
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('vulnerability_id')">
                                    Vuln ID <i class="fas fa-sort ml-2"></i>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('title')">
                                    Title <i class="fas fa-sort ml-2"></i>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('severity')">
                                    Severity <i class="fas fa-sort ml-2"></i>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('status')">
                                    Status <i class="fas fa-sort ml-2"></i>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-gray-200">
                            <!-- Table rows will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="bg-white px-6 py-4 border-t">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-600">
                            Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="previousPage()" id="prevBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 disabled:opacity-50">
                                <i class="fas fa-chevron-left mr-1"></i>Previous
                            </button>
                            <button onclick="nextPage()" id="nextBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 disabled:opacity-50">
                                Next<i class="fas fa-chevron-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="tab-section hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Advanced Analytics</h2>
                <p class="text-xl text-gray-600">Deep insights into compliance trends and risk analysis</p>
            </div>

            <!-- Analytics Grid -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 mb-12">
                <div class="xl:col-span-2 card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Compliance Trends</h3>
                    <div style="height: 400px;">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>

                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Risk Matrix</h3>
                    <div class="space-y-4">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="status-dot bg-danger"></div>
                                    <span class="font-medium text-red-800">Critical</span>
                                </div>
                                <span class="text-red-600 font-bold" id="criticalCount">0</span>
                            </div>
                        </div>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="status-dot bg-orange-500"></div>
                                    <span class="font-medium text-orange-800">High</span>
                                </div>
                                <span class="text-orange-600 font-bold" id="highRiskCount">0</span>
                            </div>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="status-dot bg-warning"></div>
                                    <span class="font-medium text-yellow-800">Medium</span>
                                </div>
                                <span class="text-warning font-bold" id="mediumRiskCount">0</span>
                            </div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="status-dot bg-success"></div>
                                    <span class="font-medium text-green-800">Low</span>
                                </div>
                                <span class="text-success font-bold" id="lowRiskCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Performance Score</h3>
                    <div style="height: 300px;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Completion Metrics</h3>
                    <div class="space-y-6">
                        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700">Overall Progress</span>
                            <div class="flex items-center space-x-3">
                                <div class="w-32 bg-gray-200 rounded-full h-3">
                                    <div class="bg-brand h-3 rounded-full progress-bar" id="overallProgressBar" style="width: 0%"></div>
                                </div>
                                <span class="font-bold text-brand" id="overallProgress">0%</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700">Security Score</span>
                            <div class="flex items-center space-x-3">
                                <div class="w-32 bg-gray-200 rounded-full h-3">
                                    <div class="bg-success h-3 rounded-full progress-bar" id="securityScoreBar" style="width: 0%"></div>
                                </div>
                                <span class="font-bold text-success" id="securityScore">0%</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700">Risk Mitigation</span>
                            <div class="flex items-center space-x-3">
                                <div class="w-32 bg-gray-200 rounded-full h-3">
                                    <div class="bg-warning h-3 rounded-full progress-bar" id="riskMitigationBar" style="width: 0%"></div>
                                </div>
                                <span class="font-bold text-warning" id="riskMitigation">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Compliance Section -->
        <section id="compliance" class="tab-section hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Compliance Tracking</h2>
                <p class="text-xl text-gray-600">Track compliance progress and generate reports</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Compliance Timeline</h3>
                    <div style="height: 400px;">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>

                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Quick Actions</h3>
                    <div class="space-y-4">
                        <button onclick="generateReport('summary')" class="w-full p-4 text-left border border-gray-200 rounded-lg hover:bg-gray-50 transition-all">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-file-alt text-brand text-xl"></i>
                                <div>
                                    <div class="font-medium">Summary Report</div>
                                    <div class="text-sm text-gray-600">Executive overview</div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="generateReport('detailed')" class="w-full p-4 text-left border border-gray-200 rounded-lg hover:bg-gray-50 transition-all">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-list-ul text-brand text-xl"></i>
                                <div>
                                    <div class="font-medium">Detailed Report</div>
                                    <div class="text-sm text-gray-600">Full requirements list</div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="generateReport('risk')" class="w-full p-4 text-left border border-gray-200 rounded-lg hover:bg-gray-50 transition-all">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-exclamation-triangle text-brand text-xl"></i>
                                <div>
                                    <div class="font-medium">Risk Assessment</div>
                                    <div class="text-sm text-gray-600">Security risks analysis</div>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Requirement Details Modal -->
    <div id="requirementModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="card max-w-6xl w-full max-h-[90vh] overflow-y-auto animate-fadeIn">
            <div class="sticky top-0 bg-white border-b px-8 py-6 flex items-center justify-between">
                <h2 class="text-2xl font-bold text-gray-900" id="modalTitle">Requirement Details</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-all">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="p-8" id="modalContent">
                <!-- Content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="card max-w-md w-full animate-fadeIn">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-6">Export Options</h3>
                <div class="space-y-3">
                    <button onclick="exportExcel()" class="w-full flex items-center space-x-3 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-all">
                        <i class="fas fa-file-excel text-success text-xl"></i>
                        <div class="text-left">
                            <div class="font-medium">Excel Report</div>
                            <div class="text-sm text-gray-600">Complete compliance workbook</div>
                        </div>
                    </button>
                    <button onclick="exportCSV()" class="w-full flex items-center space-x-3 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-all">
                        <i class="fas fa-file-csv text-brand text-xl"></i>
                        <div class="text-left">
                            <div class="font-medium">CSV Data</div>
                            <div class="text-sm text-gray-600">Raw data export</div>
                        </div>
                    </button>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="closeExportModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-all">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let allRequirements = [];
        let filteredRequirements = [];
        let selectedRequirements = new Set();
        let currentView = 'table';
        let currentPage = 1;
        let itemsPerPage = 25;
        let sortColumn = '';
        let sortDirection = 'asc';
        
        // Chart instances
        let statusChart = null;
        let riskChart = null;
        let trendsChart = null;
        let performanceChart = null;
        let timelineChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadFromStorage();
        });

        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });

            // File handling
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            document.getElementById('dropZone').addEventListener('click', () => document.getElementById('fileInput').click());
            
            // Drag and drop
            setupDragAndDrop();
            
            // Filters
            document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));
            document.getElementById('severityFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            
            // Select all
            document.getElementById('selectAll').addEventListener('change', handleSelectAll);
        }

        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('border-brand', 'bg-blue-50');
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('border-brand', 'bg-blue-50');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('border-brand', 'bg-blue-50');
                const files = e.dataTransfer.files;
                if (files.length > 0) processFile(files[0]);
            });
        }

        // Tab Management
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update sections
            document.querySelectorAll('.tab-section').forEach(section => {
                section.classList.add('hidden');
                section.classList.remove('active');
            });
            
            const targetSection = document.getElementById(tabName);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.classList.add('active');
            }
            
            // Initialize section-specific content
            if (tabName === 'dashboard' && allRequirements.length > 0) {
                updateDashboard();
                initializeDashboardCharts();
            } else if (tabName === 'analytics' && allRequirements.length > 0) {
                updateAnalytics();
                initializeAnalyticsCharts();
            } else if (tabName === 'requirements' && allRequirements.length > 0) {
                renderRequirements();
            } else if (tabName === 'compliance' && allRequirements.length > 0) {
                initializeComplianceCharts();
            }
        }

        // File Processing
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) processFile(file);
        }

        async function processFile(file) {
            if (!file.name.endsWith('.json')) {
                alert('Please select a JSON file');
                return;
            }

            showProgress(true);
            updateProgress(0, 'Reading file...');

            try {
                const content = await readFile(file);
                updateProgress(20, 'Parsing JSON...');
                
                const data = JSON.parse(content);
                updateProgress(40, 'Validating structure...');
                
                if (!data.stig || !data.stig.findings) {
                    throw new Error('Invalid STIG format. Expected: { stig: { findings: {...} } }');
                }

                updateProgress(60, 'Processing requirements...');
                const requirements = await processRequirements(data.stig);
                
                updateProgress(90, 'Finalizing...');
                allRequirements = requirements;
                filteredRequirements = [...requirements];
                
                updateProgress(100, 'Complete!');
                
                setTimeout(() => {
                    showProgress(false);
                    showResults();
                    saveToStorage();
                    switchTab('dashboard');
                }, 1000);

            } catch (error) {
                showProgress(false);
                alert(`Error: ${error.message}`);
            }
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        async function processRequirements(stig) {
            const requirements = [];
            const findings = stig.findings;
            const keys = Object.keys(findings);
            
            for (let i = 0; i < keys.length; i++) {
                const vulnId = keys[i];
                const finding = findings[vulnId];
                
                // Update progress
                if (i % 10 === 0) {
                    const progress = 60 + (i / keys.length) * 30;
                    updateProgress(progress, `Processing ${i + 1}/${keys.length}...`);
                    document.getElementById('parsedCount').textContent = i;
                    document.getElementById('validatedCount').textContent = i;
                    document.getElementById('processedCount').textContent = i;
                    await new Promise(resolve => setTimeout(resolve, 10));
                }

                const req = {
                    id: finding.id || vulnId,
                    vulnerability_id: vulnId,
                    rule_id: finding.ruleID || finding.ruleid || '',
                    title: finding.title || 'No title provided',
                    description: finding.description || 'No description available',
                    severity: normalizeSeverity(finding.severity),
                    status: 'not-reviewed',
                    check_text: finding.checktext || finding.check_text || 'No check procedure provided',
                    fix_text: finding.fixtext || finding.fix_text || 'No fix procedure provided',
                    version: finding.version || 'TBD',
                    stig_title: stig.title || 'STIG Requirements',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                requirements.push(req);
            }

            // Final counts
            document.getElementById('parsedCount').textContent = requirements.length;
            document.getElementById('validatedCount').textContent = requirements.length;
            document.getElementById('processedCount').textContent = requirements.length;

            return requirements.sort((a, b) => a.vulnerability_id.localeCompare(b.vulnerability_id));
        }

        function normalizeSeverity(severity) {
            if (!severity) return 'medium';
            const s = severity.toString().toLowerCase();
            if (s.includes('high') || s.includes('cat i')) return 'high';
            if (s.includes('low') || s.includes('cat iii')) return 'low';
            return 'medium';
        }

        // Progress Display
        function showProgress(show) {
            document.getElementById('progressSection').classList.toggle('hidden', !show);
        }

        function updateProgress(percent, message) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressPercent').textContent = `${Math.round(percent)}%`;
            document.getElementById('progressMessage').textContent = message;
        }

        function showResults() {
            const high = allRequirements.filter(r => r.severity === 'high').length;
            const medium = allRequirements.filter(r => r.severity === 'medium').length;
            const low = allRequirements.filter(r => r.severity === 'low').length;
            const total = allRequirements.length;

            document.getElementById('totalParsed').textContent = total;
            document.getElementById('highSeverity').textContent = high;
            document.getElementById('mediumSeverity').textContent = medium;
            document.getElementById('lowSeverity').textContent = low;

            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('exportBtn').classList.remove('hidden');
            
            updateAllStats();
        }

        // Statistics Updates
        function updateAllStats() {
            updateHeaderStats();
            if (document.getElementById('dashboard').classList.contains('active')) {
                updateDashboard();
            }
        }

        function updateHeaderStats() {
            const total = allRequirements.length;
            const compliant = allRequirements.filter(r => r.status === 'compliant').length;
            const rate = total > 0 ? Math.round((compliant / total) * 100) : 0;

            document.getElementById('headerTotal').textContent = total;
            document.getElementById('headerCompliant').textContent = `${rate}%`;
        }

        function updateDashboard() {
            const total = allRequirements.length;
            const compliant = allRequirements.filter(r => r.status === 'compliant').length;
            const highRisk = allRequirements.filter(r => r.severity === 'high' && r.status !== 'compliant').length;
            const inProgress = allRequirements.filter(r => r.status === 'in-progress').length;
            const rate = total > 0 ? Math.round((compliant / total) * 100) : 0;

            document.getElementById('dashTotal').textContent = total;
            document.getElementById('dashCompliance').textContent = `${rate}%`;
            document.getElementById('dashHighRisk').textContent = highRisk;
            document.getElementById('dashInProgress').textContent = inProgress;

            updateProgressBars();
        }

        function updateProgressBars() {
            const severities = ['high', 'medium', 'low'];
            
            severities.forEach(severity => {
                const severityReqs = allRequirements.filter(r => r.severity === severity);
                const compliantReqs = severityReqs.filter(r => r.status === 'compliant');
                const total = severityReqs.length;
                const compliant = compliantReqs.length;
                const percentage = total > 0 ? Math.round((compliant / total) * 100) : 0;
                
                document.getElementById(`${severity}Total`).textContent = total;
                document.getElementById(`${severity}Compliant`).textContent = compliant;
                document.getElementById(`${severity}Progress`).style.width = `${percentage}%`;
            });
        }

        // Chart Initialization
        function initializeDashboardCharts() {
            initializeStatusChart();
            initializeRiskChart();
        }

        function initializeStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if (statusChart) statusChart.destroy();
            
            const compliant = allRequirements.filter(r => r.status === 'compliant').length;
            const nonCompliant = allRequirements.filter(r => r.status === 'non-compliant').length;
            const inProgress = allRequirements.filter(r => r.status === 'in-progress').length;
            const notReviewed = allRequirements.filter(r => r.status === 'not-reviewed').length;

            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Compliant', 'Non-Compliant', 'In Progress', 'Not Reviewed'],
                    datasets: [{
                        data: [compliant, nonCompliant, inProgress, notReviewed],
                        backgroundColor: ['#00c851', '#ff4444', '#0066cc', '#ffbb33'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 20, usePointStyle: true }
                        }
                    }
                }
            });
        }

        function initializeRiskChart() {
            const ctx = document.getElementById('riskChart').getContext('2d');
            
            if (riskChart) riskChart.destroy();
            
            const high = allRequirements.filter(r => r.severity === 'high').length;
            const medium = allRequirements.filter(r => r.severity === 'medium').length;
            const low = allRequirements.filter(r => r.severity === 'low').length;

            riskChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['High Risk', 'Medium Risk', 'Low Risk'],
                    datasets: [{
                        label: 'Requirements',
                        data: [high, medium, low],
                        backgroundColor: ['#ff444450', '#ffbb3350', '#00c85150'],
                        borderColor: ['#ff4444', '#ffbb33', '#00c851'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }

        function updateAnalytics() {
            const critical = allRequirements.filter(r => r.severity === 'high' && r.status === 'non-compliant').length;
            const highRisk = allRequirements.filter(r => r.severity === 'medium' && r.status === 'non-compliant').length;
            const mediumRisk = allRequirements.filter(r => r.severity === 'low' && r.status === 'non-compliant').length;
            const lowRisk = allRequirements.filter(r => r.status === 'compliant').length;

            document.getElementById('criticalCount').textContent = critical;
            document.getElementById('highRiskCount').textContent = highRisk;
            document.getElementById('mediumRiskCount').textContent = mediumRisk;
            document.getElementById('lowRiskCount').textContent = lowRisk;

            updatePerformanceMetrics();
        }

        function updatePerformanceMetrics() {
            const total = allRequirements.length;
            const compliant = allRequirements.filter(r => r.status === 'compliant').length;
            const overall = total > 0 ? Math.round((compliant / total) * 100) : 0;
            
            const highTotal = allRequirements.filter(r => r.severity === 'high').length;
            const highCompliant = allRequirements.filter(r => r.severity === 'high' && r.status === 'compliant').length;
            const security = highTotal > 0 ? Math.round((highCompliant / highTotal) * 100) : 100;
            
            const nonCompliantHigh = allRequirements.filter(r => r.severity === 'high' && r.status === 'non-compliant').length;
            const risk = highTotal > 0 ? Math.round(((highTotal - nonCompliantHigh) / highTotal) * 100) : 100;

            document.getElementById('overallProgress').textContent = `${overall}%`;
            document.getElementById('overallProgressBar').style.width = `${overall}%`;
            
            document.getElementById('securityScore').textContent = `${security}%`;
            document.getElementById('securityScoreBar').style.width = `${security}%`;
            
            document.getElementById('riskMitigation').textContent = `${risk}%`;
            document.getElementById('riskMitigationBar').style.width = `${risk}%`;
        }

        function initializeAnalyticsCharts() {
            initializeTrendsChart();
            initializePerformanceChart();
        }

        function initializeTrendsChart() {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            if (trendsChart) trendsChart.destroy();
            
            // Generate mock trend data
            const dates = [];
            const complianceData = [];
            const currentDate = new Date();
            
            for (let i = 30; i >= 0; i--) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
                
                const baseCompliance = 15;
                const progressiveFactor = (30 - i) / 30;
                const currentCompliance = Math.min(90, baseCompliance + (progressiveFactor * 70) + (Math.random() * 8 - 4));
                complianceData.push(Math.round(currentCompliance));
            }

            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Compliance Rate (%)',
                        data: complianceData,
                        borderColor: '#0066cc',
                        backgroundColor: '#0066cc20',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day', displayFormats: { day: 'MMM dd' } }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: function(value) { return value + '%'; } }
                        }
                    }
                }
            });
        }

        function initializePerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (performanceChart) performanceChart.destroy();
            
            const total = allRequirements.length;
            const compliant = allRequirements.filter(r => r.status === 'compliant').length;
            const score = total > 0 ? Math.round((compliant / total) * 100) : 0;

            performanceChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Security', 'Compliance', 'Implementation', 'Risk Management', 'Documentation'],
                    datasets: [{
                        label: 'Performance Score',
                        data: [score, score, Math.max(0, score - 10), Math.min(100, score + 5), score],
                        backgroundColor: '#0066cc30',
                        borderColor: '#0066cc',
                        borderWidth: 2,
                        pointBackgroundColor: '#0066cc'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { stepSize: 20 }
                        }
                    }
                }
            });
        }

        function initializeComplianceCharts() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (timelineChart) timelineChart.destroy();
            
            // Generate mock timeline data
            const dates = [];
            const completedData = [];
            const currentDate = new Date();
            
            for (let i = 30; i >= 0; i--) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
                
                const baseCompleted = 10;
                const progressiveFactor = (30 - i) / 30;
                const completed = Math.round(baseCompleted + (progressiveFactor * (allRequirements.length - baseCompleted)));
                completedData.push(completed);
            }

            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Completed Requirements',
                        data: completedData,
                        borderColor: '#00c851',
                        backgroundColor: '#00c85120',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day', displayFormats: { day: 'MMM dd' } }
                        },
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Requirements Management
        function renderRequirements() {
            renderTable();
            updateFilterCounts();
        }

        function renderTable() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredRequirements.slice(start, end);
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = pageData.map(req => createTableRow(req)).join('');
            
            updatePagination();
        }

        function createTableRow(req) {
            const severityColors = {
                'high': 'bg-red-100 text-red-800',
                'medium': 'bg-yellow-100 text-yellow-800',
                'low': 'bg-green-100 text-green-800'
            };

            const statusColors = {
                'compliant': 'bg-green-100 text-green-800',
                'non-compliant': 'bg-red-100 text-red-800',
                'in-progress': 'bg-blue-100 text-blue-800',
                'not-reviewed': 'bg-yellow-100 text-yellow-800'
            };

            return `
                <tr class="table-hover transition-all">
                    <td class="px-6 py-4">
                        <input type="checkbox" value="${req.id}" class="rounded border-gray-300 text-brand focus:ring-brand" 
                               onchange="toggleSelection('${req.id}')">
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-semibold text-gray-900">${req.vulnerability_id}</div>
                        <div class="text-sm text-gray-500">${req.rule_id || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900 max-w-xs truncate" title="${req.title}">
                            ${req.title}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${severityColors[req.severity]}">
                            ${req.severity.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <select onchange="updateStatus('${req.id}', this.value)" 
                                class="text-xs px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand ${statusColors[req.status]}">
                            <option value="not-reviewed" ${req.status === 'not-reviewed' ? 'selected' : ''}>Not Reviewed</option>
                            <option value="compliant" ${req.status === 'compliant' ? 'selected' : ''}>Compliant</option>
                            <option value="non-compliant" ${req.status === 'non-compliant' ? 'selected' : ''}>Non-Compliant</option>
                            <option value="in-progress" ${req.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                        </select>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="showRequirementDetails('${req.id}')" 
                                class="btn-primary text-white px-3 py-1 rounded-lg text-sm transition-all">
                            <i class="fas fa-eye mr-1"></i>View
                        </button>
                    </td>
                </tr>
            `;
        }

        // Modal Functions
        function showRequirementDetails(reqId) {
            const req = allRequirements.find(r => r.id === reqId);
            if (!req) return;

            document.getElementById('modalTitle').textContent = req.vulnerability_id;
            document.getElementById('modalContent').innerHTML = `
                <div class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Vulnerability ID</label>
                            <div class="text-lg font-semibold text-gray-900">${req.vulnerability_id}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rule ID</label>
                            <div class="text-gray-800">${req.rule_id || 'Not specified'}</div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                        <div class="text-xl font-semibold text-gray-900">${req.title}</div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Severity</label>
                            <span class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-semibold ${req.severity === 'high' ? 'bg-red-100 text-red-800' : req.severity === 'medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                ${req.severity.toUpperCase()}
                            </span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select onchange="updateStatus('${req.id}', this.value)" 
                                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand">
                                <option value="not-reviewed" ${req.status === 'not-reviewed' ? 'selected' : ''}>Not Reviewed</option>
                                <option value="compliant" ${req.status === 'compliant' ? 'selected' : ''}>Compliant</option>
                                <option value="non-compliant" ${req.status === 'non-compliant' ? 'selected' : ''}>Non-Compliant</option>
                                <option value="in-progress" ${req.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Description</label>
                        <div class="bg-gray-50 rounded-xl p-6 text-gray-800">${req.description}</div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Check Procedure</label>
                            <div class="bg-blue-50 rounded-xl p-6 max-h-80 overflow-y-auto">
                                <pre class="text-sm text-gray-800 whitespace-pre-wrap">${req.check_text}</pre>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Fix Procedure</label>
                            <div class="bg-green-50 rounded-xl p-6 max-h-80 overflow-y-auto">
                                <pre class="text-sm text-gray-800 whitespace-pre-wrap">${req.fix_text}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('requirementModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('requirementModal').classList.add('hidden');
        }

        // Status Updates
        function updateStatus(reqId, newStatus) {
            const req = allRequirements.find(r => r.id === reqId);
            if (!req) return;

            req.status = newStatus;
            req.updated_at = new Date().toISOString();
            
            updateAllStats();
            saveToStorage();
            
            // Refresh views
            if (document.getElementById('requirements').classList.contains('active')) {
                renderRequirements();
            }
            
            // Update charts
            if (document.getElementById('dashboard').classList.contains('active')) {
                initializeDashboardCharts();
            }
        }

        // Selection Management
        function toggleSelection(reqId) {
            if (selectedRequirements.has(reqId)) {
                selectedRequirements.delete(reqId);
            } else {
                selectedRequirements.add(reqId);
            }
            updateBulkActions();
        }

        function handleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedRequirements.add(cb.value);
                } else {
                    selectedRequirements.delete(cb.value);
                }
            });
            
            updateBulkActions();
        }

        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const count = selectedRequirements.size;
            
            if (count > 0) {
                bulkActions.classList.remove('hidden');
                document.getElementById('selectedCount').textContent = count;
            } else {
                bulkActions.classList.add('hidden');
            }
        }

        function applyBulkUpdate() {
            const newStatus = document.getElementById('bulkStatus').value;
            if (!newStatus) return;
            
            if (confirm(`Update ${selectedRequirements.size} requirements to "${newStatus.replace('-', ' ')}"?`)) {
                selectedRequirements.forEach(reqId => {
                    updateStatus(reqId, newStatus);
                });
                clearSelection();
            }
        }

        function clearSelection() {
            selectedRequirements.clear();
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateBulkActions();
        }

        // Filtering
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const severity = document.getElementById('severityFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            filteredRequirements = allRequirements.filter(req => {
                const matchesSearch = !search || 
                    req.title.toLowerCase().includes(search) ||
                    req.vulnerability_id.toLowerCase().includes(search) ||
                    req.description.toLowerCase().includes(search);
                
                const matchesSeverity = !severity || req.severity === severity;
                const matchesStatus = !status || req.status === status;
                
                return matchesSearch && matchesSeverity && matchesStatus;
            });
            
            currentPage = 1;
            updateFilterCounts();
            
            if (document.getElementById('requirements').classList.contains('active')) {
                renderRequirements();
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('severityFilter').value = '';
            document.getElementById('statusFilter').value = '';
            filteredRequirements = [...allRequirements];
            currentPage = 1;
            updateFilterCounts();
            
            if (document.getElementById('requirements').classList.contains('active')) {
                renderRequirements();
            }
        }

        function updateFilterCounts() {
            const total = filteredRequirements.length;
            document.getElementById('totalCount').textContent = allRequirements.length;
            document.getElementById('showingCount').textContent = total;
        }

        // Pagination
        function updatePagination() {
            const total = filteredRequirements.length;
            const totalPages = Math.ceil(total / itemsPerPage);
            
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredRequirements.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        // Sorting
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            filteredRequirements.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (sortDirection === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
            
            renderTable();
        }

        // Export Functions
        function showExportModal() {
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function exportExcel() {
            if (allRequirements.length === 0) {
                alert('No data to export');
                return;
            }

            const wb = XLSX.utils.book_new();
            
            // Summary
            const stats = calculateStats();
            const summaryData = [
                ['Enterprise STIG Compliance Report'],
                ['Generated:', new Date().toLocaleString()],
                [''],
                ['Summary'],
                ['Total Requirements:', stats.total],
                ['Compliant:', stats.compliant, `${stats.complianceRate}%`],
                ['Non-Compliant:', stats.nonCompliant],
                ['In Progress:', stats.inProgress],
                ['Not Reviewed:', stats.notReviewed],
                [''],
                ['Risk Distribution'],
                ['High Risk:', stats.high],
                ['Medium Risk:', stats.medium],
                ['Low Risk:', stats.low]
            ];
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
            
            // Requirements
            const reqData = [
                ['Vulnerability ID', 'Rule ID', 'Title', 'Description', 'Severity', 'Status', 'Check Procedure', 'Fix Procedure', 'Version', 'Last Updated']
            ];
            
            allRequirements.forEach(req => {
                reqData.push([
                    req.vulnerability_id,
                    req.rule_id,
                    req.title,
                    req.description,
                    req.severity,
                    req.status,
                    req.check_text,
                    req.fix_text,
                    req.version,
                    new Date(req.updated_at).toLocaleString()
                ]);
            });
            
            const reqWs = XLSX.utils.aoa_to_sheet(reqData);
            XLSX.utils.book_append_sheet(wb, reqWs, 'Requirements');
            
            XLSX.writeFile(wb, `STIG-Compliance-Report-${new Date().toISOString().split('T')[0]}.xlsx`);
            closeExportModal();
        }

        function exportCSV() {
            if (allRequirements.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['Vulnerability ID', 'Rule ID', 'Title', 'Severity', 'Status', 'Last Updated'];
            const csvData = [headers];
            
            allRequirements.forEach(req => {
                csvData.push([
                    req.vulnerability_id,
                    req.rule_id,
                    req.title.replace(/"/g, '""'),
                    req.severity,
                    req.status,
                    new Date(req.updated_at).toLocaleDateString()
                ]);
            });
            
            const csvContent = csvData.map(row => 
                row.map(field => `"${field}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `STIG-Requirements-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            
            closeExportModal();
        }

        function calculateStats() {
            const total = allRequirements.length;
            const compliant = allRequirements.filter(r => r.status === 'compliant').length;
            const nonCompliant = allRequirements.filter(r => r.status === 'non-compliant').length;
            const inProgress = allRequirements.filter(r => r.status === 'in-progress').length;
            const notReviewed = allRequirements.filter(r => r.status === 'not-reviewed').length;
            
            const high = allRequirements.filter(r => r.severity === 'high').length;
            const medium = allRequirements.filter(r => r.severity === 'medium').length;
            const low = allRequirements.filter(r => r.severity === 'low').length;
            
            const complianceRate = total > 0 ? Math.round((compliant / total) * 100) : 0;

            return {
                total, compliant, nonCompliant, inProgress, notReviewed,
                high, medium, low, complianceRate
            };
        }

        // Report Generation
        function generateReport(type) {
            switch(type) {
                case 'summary':
                    exportExcel();
                    break;
                case 'detailed':
                    exportCSV();
                    break;
                case 'risk':
                    alert('Risk assessment report will be available in the next update.');
                    break;
            }
        }

        // View Toggle
        function toggleView() {
            // Placeholder for view toggle functionality
            alert('Card view will be implemented in the next update.');
        }

        function exportRequirements() {
            showExportModal();
        }

        // Storage
        function saveToStorage() {
            localStorage.setItem('stigRequirements', JSON.stringify(allRequirements));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('stigRequirements');
            if (saved) {
                try {
                    allRequirements = JSON.parse(saved);
                    filteredRequirements = [...allRequirements];
                    if (allRequirements.length > 0) {
                        showResults();
                        switchTab('dashboard');
                    }
                } catch (e) {
                    console.error('Error loading from storage:', e);
                }
            }
        }

        // Utility Functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>