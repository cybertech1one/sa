<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
/**
 * Advanced Security Analysis PDF Report Generator
 * Focuses on critical IP addresses, payloads, and in-depth threat analysis
 */
class AdvancedSecurityReportGenerator {
    constructor() {
        this.reportData = null;
        this.criticalThreshold = 70; // Threat score threshold for critical classification
        this.initializeReportButton();
        this.payloadPatterns = this.initializePayloadPatterns();
    }

    // Initialize the report generation button
    initializeReportButton() {
        // Add button to the export options section
        const exportSection = document.querySelector('.bg-white.rounded-lg.shadow-sm.p-6:last-of-type .space-y-3');
        
        if (exportSection && !document.getElementById('generateSecurityPDFBtn')) {
            const securityReportBtn = document.createElement('button');
            securityReportBtn.id = 'generateSecurityPDFBtn';
            securityReportBtn.className = 'w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500';
            securityReportBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                Generate Security Analysis PDF
            `;
            
            securityReportBtn.addEventListener('click', () => {
                this.generateSecurityReport();
            });
            
            exportSection.appendChild(securityReportBtn);
        }
    }

    // Initialize payload detection patterns
    initializePayloadPatterns() {
        return {
            sqlInjection: [
                /(\bUNION\b.*\bSELECT\b)/gi,
                /(\bSELECT\b.*\bFROM\b.*\bWHERE\b)/gi,
                /(\bINSERT\b.*\bINTO\b)/gi,
                /(\bDROP\b.*\bTABLE\b)/gi,
                /(\bUPDATE\b.*\bSET\b)/gi,
                /(\bDELETE\b.*\bFROM\b)/gi,
                /(';.*--)/gi,
                /(\b1=1\b|\b1=0\b)/gi,
                /(\bOR\b.*\b1=1\b)/gi,
                /(\bAND\b.*\b1=1\b)/gi
            ],
            xss: [
                /(<script[^>]*>.*?<\/script>)/gi,
                /(javascript:)/gi,
                /(onload\s*=)/gi,
                /(onerror\s*=)/gi,
                /(onclick\s*=)/gi,
                /(alert\s*\()/gi,
                /(document\.cookie)/gi,
                /(<iframe[^>]*>)/gi,
                /(<img[^>]*onerror)/gi
            ],
            commandInjection: [
                /(;\s*(cat|ls|dir|type|whoami|id|pwd)\b)/gi,
                /(\|\s*(cat|ls|dir|type|whoami|id|pwd)\b)/gi,
                /(\&\&\s*(cat|ls|dir|type|whoami|id|pwd)\b)/gi,
                /(;.*\/bin\/)/gi,
                /(;.*cmd\.exe)/gi,
                /(;.*powershell)/gi,
                /(`.*`)/gi,
                /(\$\(.*\))/gi
            ],
            pathTraversal: [
                /(\.\.\/){2,}/gi,
                /(\.\.\\){2,}/gi,
                /(%2e%2e%2f){2,}/gi,
                /(%252e%252e%252f){2,}/gi,
                /(\/etc\/passwd)/gi,
                /(\/etc\/shadow)/gi,
                /(boot\.ini)/gi,
                /(\.\.\/.*\/etc\/)/gi
            ],
            fileInclusion: [
                /(php:\/\/filter)/gi,
                /(data:\/\/)/gi,
                /(file:\/\/)/gi,
                /(ftp:\/\/)/gi,
                /(expect:\/\/)/gi,
                /(zip:\/\/)/gi,
                /(\?file=http)/gi,
                /(\?page=http)/gi,
                /(\?include=http)/gi
            ]
        };
    }

    // Extract comprehensive analysis data
    extractAnalysisData() {
        // Get the current analysis results from the UI controller
        const uiController = window.uiController;
        if (!uiController || !uiController.results) {
            this.showNotification('No analysis results found. Please run an analysis first.', 'error');
            return null;
        }

        const results = uiController.results;
        
        return {
            // Basic statistics
            stats: {
                totalRequests: this.getElementNumber('totalEntries'),
                uniqueIPs: this.getElementNumber('uniqueIPs'),
                criticalEvents: this.getElementNumber('criticalEvents'),
                warningEvents: this.getElementNumber('warningEvents'),
                threatScore: results.threatScore || 0,
                threatLevel: results.threatLevel || 'Low',
                analysisDate: new Date().toISOString(),
                timeRange: this.getAnalysisTimeRange(results)
            },
            
            // Critical IP analysis
            criticalIPs: this.analyzeCriticalIPs(results.ipActivity || {}),
            
            // Security events
            securityEvents: this.categorizeSecurityEvents(results.events || []),
            
            // Payload analysis
            payloadAnalysis: this.analyzePayloads(results.events || []),
            
            // Attack patterns
            attackPatterns: this.identifyAttackPatterns(results),
            
            // Correlation analysis
            correlations: results.correlation || {},
            
            // Geographical threats
            geoThreats: this.analyzeGeographicalThreats(results.geoDistribution || {}),
            
            // User agent threats
            userAgentThreats: this.analyzeUserAgentThreats(results.userAgentStats || {}),
            
            // Recommendations
            recommendations: this.generateRecommendations(results)
        };
    }

    // Analyze critical IP addresses
    analyzeCriticalIPs(ipActivity) {
        const criticalIPs = [];
        
        Object.entries(ipActivity).forEach(([ip, data]) => {
            const threatScore = this.calculateIPThreatScore(data);
            
            if (threatScore >= this.criticalThreshold) {
                criticalIPs.push({
                    ip: ip,
                    threatScore: threatScore,
                    threatLevel: this.getThreatLevel(threatScore),
                    requests: data.requests || 0,
                    failedRequests: data.failedRequests || 0,
                    errorRate: data.requests > 0 ? ((data.failedRequests || 0) / data.requests * 100).toFixed(2) : 0,
                    firstSeen: data.firstSeen,
                    lastSeen: data.lastSeen,
                    userAgents: Array.isArray(data.userAgents) ? data.userAgents : [],
                    topUrls: this.getTopUrls(data.urls || {}),
                    attackTypes: this.identifyAttackTypes(data),
                    geoLocation: this.getGeoLocation(ip),
                    reputation: this.getIPReputation(ip),
                    behaviors: this.analyzeBehaviors(data)
                });
            }
        });
        
        return criticalIPs.sort((a, b) => b.threatScore - a.threatScore);
    }

    // Calculate IP threat score
    calculateIPThreatScore(data) {
        let score = 0;
        
        // High request volume
        if (data.requests > 1000) score += 20;
        else if (data.requests > 500) score += 10;
        
        // High error rate
        const errorRate = data.requests > 0 ? (data.failedRequests || 0) / data.requests : 0;
        if (errorRate > 0.5) score += 30;
        else if (errorRate > 0.3) score += 20;
        else if (errorRate > 0.1) score += 10;
        
        // Multiple user agents (possible evasion)
        const userAgentCount = Array.isArray(data.userAgents) ? data.userAgents.length : 0;
        if (userAgentCount > 10) score += 15;
        else if (userAgentCount > 5) score += 10;
        
        // High URL diversity (scanning behavior)
        const urlCount = data.urls ? Object.keys(data.urls).length : 0;
        if (urlCount > 100) score += 25;
        else if (urlCount > 50) score += 15;
        else if (urlCount > 20) score += 10;
        
        // Existing threat indicators
        if (data.malicious) score += 40;
        if (data.scanner) score += 30;
        if (data.threatLevel > 0) score += data.threatLevel * 10;
        
        return Math.min(100, score);
    }

    // Get threat level from score
    getThreatLevel(score) {
        if (score >= 90) return 'Critical';
        if (score >= 70) return 'High';
        if (score >= 50) return 'Medium';
        return 'Low';
    }

    // Categorize security events
    categorizeSecurityEvents(events) {
        const categories = {
            critical: [],
            high: [],
            medium: [],
            low: []
        };
        
        events.forEach(event => {
            if (event.severity && categories[event.severity]) {
                categories[event.severity].push({
                    timestamp: event.timestamp,
                    category: event.category,
                    description: event.description,
                    ip: event.ip,
                    url: event.url,
                    method: event.method,
                    statusCode: event.statusCode,
                    userAgent: event.userAgent,
                    confidence: event.confidence || 0.5,
                    payload: this.extractPayload(event)
                });
            }
        });
        
        return categories;
    }

    // Analyze payloads in events
    analyzePayloads(events) {
        const payloads = {
            sqlInjection: [],
            xss: [],
            commandInjection: [],
            pathTraversal: [],
            fileInclusion: [],
            other: []
        };
        
        events.forEach(event => {
            const payload = this.extractPayload(event);
            if (payload) {
                const payloadType = this.classifyPayload(payload);
                
                const payloadInfo = {
                    payload: payload,
                    source: event.ip,
                    timestamp: event.timestamp,
                    url: event.url,
                    method: event.method,
                    severity: event.severity,
                    decoded: this.decodePayload(payload),
                    analysis: this.analyzePayloadContent(payload)
                };
                
                if (payloads[payloadType]) {
                    payloads[payloadType].push(payloadInfo);
                } else {
                    payloads.other.push(payloadInfo);
                }
            }
        });
        
        return payloads;
    }

    // Extract payload from event
    extractPayload(event) {
        // Try to extract payload from URL, user agent, or other fields
        let payload = '';
        
        if (event.url && event.url.includes('?')) {
            const queryString = event.url.split('?')[1];
            if (this.containsSuspiciousContent(queryString)) {
                payload = queryString;
            }
        }
        
        if (!payload && event.userAgent && this.containsSuspiciousContent(event.userAgent)) {
            payload = event.userAgent;
        }
        
        if (!payload && event.description) {
            // Extract payload from description if it contains suspicious patterns
            const suspiciousMatch = event.description.match(/['"](.*?)['"]/) || 
                                  event.description.match(/payload:\s*(.*?)(?:\s|$)/i);
            if (suspiciousMatch) {
                payload = suspiciousMatch[1];
            }
        }
        
        return payload;
    }

    // Check if content contains suspicious patterns
    containsSuspiciousContent(content) {
        const suspiciousPatterns = [
            /select.*from/i, /union.*select/i, /drop.*table/i,
            /<script/i, /javascript:/i, /alert\(/i,
            /\.\.\//i, /\.\.\\/i, /\/etc\/passwd/i,
            /;.*cat\b/i, /\|.*ls\b/i, /cmd\.exe/i
        ];
        
        return suspiciousPatterns.some(pattern => pattern.test(content));
    }

    // Classify payload type
    classifyPayload(payload) {
        for (const [type, patterns] of Object.entries(this.payloadPatterns)) {
            if (patterns.some(pattern => pattern.test(payload))) {
                return type;
            }
        }
        return 'other';
    }

    // Decode payload
    decodePayload(payload) {
        try {
            // URL decode
            let decoded = decodeURIComponent(payload);
            
            // HTML decode
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = decoded;
            decoded = tempDiv.textContent || tempDiv.innerText || decoded;
            
            // Additional decoding for common encodings
            decoded = decoded.replace(/\\x([0-9A-Fa-f]{2})/g, (match, hex) => 
                String.fromCharCode(parseInt(hex, 16))
            );
            
            return decoded;
        } catch (e) {
            return payload;
        }
    }

    // Analyze payload content
    analyzePayloadContent(payload) {
        const analysis = {
            type: 'unknown',
            risk: 'low',
            techniques: [],
            indicators: []
        };
        
        // SQL Injection analysis
        if (/union.*select/i.test(payload)) {
            analysis.type = 'SQL Injection';
            analysis.risk = 'critical';
            analysis.techniques.push('UNION-based injection');
        }
        
        if (/;.*drop\s+table/i.test(payload)) {
            analysis.type = 'SQL Injection';
            analysis.risk = 'critical';
            analysis.techniques.push('Destructive SQL commands');
        }
        
        // XSS analysis
        if (/<script[^>]*>/i.test(payload)) {
            analysis.type = 'Cross-Site Scripting';
            analysis.risk = 'high';
            analysis.techniques.push('Script injection');
        }
        
        if (/javascript:/i.test(payload)) {
            analysis.type = 'Cross-Site Scripting';
            analysis.risk = 'high';
            analysis.techniques.push('JavaScript protocol injection');
        }
        
        // Command injection analysis
        if (/[;&|].*(?:cat|ls|dir|whoami|id)\b/i.test(payload)) {
            analysis.type = 'Command Injection';
            analysis.risk = 'critical';
            analysis.techniques.push('System command execution');
        }
        
        // Path traversal analysis
        if (/\.\.[\/\\]/i.test(payload)) {
            analysis.type = 'Path Traversal';
            analysis.risk = 'high';
            analysis.techniques.push('Directory traversal');
        }
        
        return analysis;
    }

    // Identify attack patterns
    identifyAttackPatterns(results) {
        const patterns = [];
        
        // Brute force patterns
        const bruteForceIPs = this.identifyBruteForcePatterns(results.events || []);
        if (bruteForceIPs.length > 0) {
            patterns.push({
                type: 'Brute Force Attack',
                severity: 'High',
                description: `Detected brute force attempts from ${bruteForceIPs.length} IP addresses`,
                ips: bruteForceIPs,
                recommendations: [
                    'Implement account lockout policies',
                    'Deploy rate limiting',
                    'Monitor failed authentication attempts'
                ]
            });
        }
        
        // Scanning patterns
        const scanningIPs = this.identifyScanningPatterns(results.ipActivity || {});
        if (scanningIPs.length > 0) {
            patterns.push({
                type: 'Port/Directory Scanning',
                severity: 'Medium',
                description: `Detected scanning activity from ${scanningIPs.length} IP addresses`,
                ips: scanningIPs,
                recommendations: [
                    'Block scanning IP addresses',
                    'Implement web application firewall',
                    'Monitor for reconnaissance activities'
                ]
            });
        }
        
        // SQL injection patterns
        const sqlInjectionEvents = (results.events || []).filter(e => 
            e.category && e.category.toLowerCase().includes('sql')
        );
        if (sqlInjectionEvents.length > 0) {
            patterns.push({
                type: 'SQL Injection Attempts',
                severity: 'Critical',
                description: `Detected ${sqlInjectionEvents.length} SQL injection attempts`,
                events: sqlInjectionEvents.slice(0, 10), // Top 10
                recommendations: [
                    'Implement parameterized queries',
                    'Use input validation and sanitization',
                    'Deploy database firewall'
                ]
            });
        }
        
        return patterns;
    }

    // Identify brute force patterns
    identifyBruteForcePatterns(events) {
        const authFailures = {};
        
        events.forEach(event => {
            if (event.category && 
                (event.category.includes('auth_failure') || 
                 event.statusCode === 401 || 
                 event.statusCode === 403)) {
                
                if (!authFailures[event.ip]) {
                    authFailures[event.ip] = [];
                }
                authFailures[event.ip].push(event);
            }
        });
        
        return Object.entries(authFailures)
            .filter(([ip, failures]) => failures.length >= 10)
            .map(([ip, failures]) => ({
                ip: ip,
                attempts: failures.length,
                timeSpan: this.getTimeSpan(failures),
                rate: this.calculateAttemptRate(failures)
            }));
    }

    // Identify scanning patterns
    identifyScanningPatterns(ipActivity) {
        return Object.entries(ipActivity)
            .filter(([ip, data]) => {
                const urlCount = data.urls ? Object.keys(data.urls).length : 0;
                const errorRate = data.requests > 0 ? (data.failedRequests || 0) / data.requests : 0;
                return urlCount > 50 || (errorRate > 0.7 && data.requests > 20);
            })
            .map(([ip, data]) => ({
                ip: ip,
                uniqueUrls: data.urls ? Object.keys(data.urls).length : 0,
                errorRate: data.requests > 0 ? ((data.failedRequests || 0) / data.requests * 100).toFixed(2) : 0,
                scanType: this.determineScanType(data)
            }));
    }

    // Determine scan type
    determineScanType(data) {
        const urls = data.urls || {};
        const urlPaths = Object.keys(urls);
        
        if (urlPaths.some(path => path.includes('admin') || path.includes('login'))) {
            return 'Admin Panel Discovery';
        }
        
        if (urlPaths.some(path => path.includes('.php') || path.includes('.asp'))) {
            return 'File Extension Enumeration';
        }
        
        if (urlPaths.length > 100) {
            return 'Comprehensive Directory Scan';
        }
        
        return 'General Reconnaissance';
    }

    // Analyze geographical threats
    analyzeGeographicalThreats(geoDistribution) {
        const threats = [];
        
        Object.entries(geoDistribution).forEach(([country, data]) => {
            const threatRatio = data.maliciousCount / data.count;
            
            if (threatRatio > 0.3 || data.maliciousCount > 10) {
                threats.push({
                    country: country,
                    totalIPs: data.count,
                    maliciousIPs: data.maliciousCount,
                    threatRatio: (threatRatio * 100).toFixed(1),
                    riskLevel: this.getGeoRiskLevel(threatRatio)
                });
            }
        });
        
        return threats.sort((a, b) => b.maliciousIPs - a.maliciousIPs);
    }

    // Get geographical risk level
    getGeoRiskLevel(ratio) {
        if (ratio > 0.7) return 'Critical';
        if (ratio > 0.5) return 'High';
        if (ratio > 0.3) return 'Medium';
        return 'Low';
    }

    // Analyze user agent threats
    analyzeUserAgentThreats(userAgentStats) {
        const threats = [];
        
        if (userAgentStats.malicious && userAgentStats.malicious.length > 0) {
            userAgentStats.malicious.forEach(ua => {
                threats.push({
                    userAgent: ua,
                    type: 'Malicious',
                    risk: 'High'
                });
            });
        }
        
        if (userAgentStats.riskyAgents) {
            Object.entries(userAgentStats.riskyAgents).forEach(([ua, data]) => {
                if (data.risk === 'critical' || data.risk === 'high') {
                    threats.push({
                        userAgent: ua,
                        type: data.type || 'Unknown',
                        risk: data.risk,
                        count: data.count,
                        ips: Array.isArray(data.ips) ? data.ips.length : 0
                    });
                }
            });
        }
        
        return threats;
    }

    // Generate recommendations
    generateRecommendations(results) {
        const recommendations = [];
        
        // Critical IP recommendations
        const criticalIPCount = Object.values(results.ipActivity || {})
            .filter(data => this.calculateIPThreatScore(data) >= this.criticalThreshold).length;
        
        if (criticalIPCount > 0) {
            recommendations.push({
                priority: 'Critical',
                category: 'IP Blocking',
                description: `Block ${criticalIPCount} critical IP addresses immediately`,
                action: 'Implement firewall rules to block identified malicious IPs',
                impact: 'Immediate threat reduction'
            });
        }
        
        // SQL injection recommendations
        const sqlEvents = (results.events || []).filter(e => 
            e.category && e.category.toLowerCase().includes('sql')
        ).length;
        
        if (sqlEvents > 0) {
            recommendations.push({
                priority: 'Critical',
                category: 'SQL Injection Protection',
                description: `Address ${sqlEvents} SQL injection attempts`,
                action: 'Implement parameterized queries and input validation',
                impact: 'Prevent database compromise'
            });
        }
        
        // Scanning activity recommendations
        const scanningIPs = Object.values(results.ipActivity || {})
            .filter(data => {
                const urlCount = data.urls ? Object.keys(data.urls).length : 0;
                return urlCount > 50;
            }).length;
        
        if (scanningIPs > 0) {
            recommendations.push({
                priority: 'High',
                category: 'Reconnaissance Prevention',
                description: `Detected scanning from ${scanningIPs} IP addresses`,
                action: 'Deploy rate limiting and bot detection',
                impact: 'Reduce attack surface discovery'
            });
        }
        
        // General security recommendations
        recommendations.push({
            priority: 'Medium',
            category: 'Monitoring Enhancement',
            description: 'Improve security monitoring capabilities',
            action: 'Implement real-time log analysis and alerting',
            impact: 'Faster threat detection and response'
        });
        
        return recommendations.sort((a, b) => {
            const priorityOrder = { 'Critical': 0, 'High': 1, 'Medium': 2, 'Low': 3 };
            return priorityOrder[a.priority] - priorityOrder[b.priority];
        });
    }

    // Main report generation function
    async generateSecurityReport() {
        this.showNotification('Generating advanced security analysis...', 'info');
        
        try {
            // Extract analysis data
            this.reportData = this.extractAnalysisData();
            
            if (!this.reportData) {
                return;
            }
            
            // Generate report content
            const reportContent = this.generateReportHTML();
            
            // Create PDF
            await this.generatePDF(reportContent);
            
            this.showNotification('Security analysis PDF generated successfully!', 'success');
            
        } catch (error) {
            console.error('Error generating security report:', error);
            this.showNotification('Error generating security report: ' + error.message, 'error');
        }
    }

    // Generate comprehensive report HTML
    generateReportHTML() {
        const data = this.reportData;
        const reportDate = new Date().toLocaleDateString();
        const reportTime = new Date().toLocaleTimeString();
        
        return `
            <div style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 1200px; margin: 0 auto; padding: 20px;">
                <!-- Report Header -->
                <div style="text-align: center; border-bottom: 3px solid #dc2626; padding-bottom: 20px; margin-bottom: 30px;">
                    <h1 style="color: #dc2626; font-size: 28px; margin: 0;">ADVANCED SECURITY ANALYSIS REPORT</h1>
                    <h2 style="color: #666; font-size: 18px; margin: 10px 0;">IIS Log Security Assessment</h2>
                    <div style="color: #888; font-size: 14px;">
                        <strong>Generated:</strong> ${reportDate} at ${reportTime}<br>
                        <strong>Analysis Period:</strong> ${data.stats.timeRange}<br>
                        <strong>Threat Level:</strong> <span style="color: ${this.getThreatColor(data.stats.threatLevel)}; font-weight: bold;">${data.stats.threatLevel.toUpperCase()}</span>
                    </div>
                </div>

                <!-- Executive Summary -->
                <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                    <h2 style="color: #dc2626; border-bottom: 2px solid #dc2626; padding-bottom: 10px;">🔴 EXECUTIVE SUMMARY</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 6px; text-align: center; border-left: 4px solid #dc2626;">
                            <div style="font-size: 24px; font-weight: bold; color: #dc2626;">${data.stats.threatScore}/100</div>
                            <div style="color: #666; font-size: 12px;">THREAT SCORE</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; text-align: center; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${data.criticalIPs.length}</div>
                            <div style="color: #666; font-size: 12px;">CRITICAL IPs</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; text-align: center; border-left: 4px solid #ef4444;">
                            <div style="font-size: 24px; font-weight: bold; color: #ef4444;">${data.stats.criticalEvents}</div>
                            <div style="color: #666; font-size: 12px;">CRITICAL EVENTS</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; text-align: center; border-left: 4px solid #3b82f6;">
                            <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">${data.stats.totalRequests.toLocaleString()}</div>
                            <div style="color: #666; font-size: 12px;">TOTAL REQUESTS</div>
                        </div>
                    </div>
                </div>

                <!-- Critical IP Addresses -->
                ${this.generateCriticalIPsSection(data.criticalIPs)}

                <!-- Payload Analysis -->
                ${this.generatePayloadAnalysisSection(data.payloadAnalysis)}

                <!-- Security Events Breakdown -->
                ${this.generateSecurityEventsSection(data.securityEvents)}

                <!-- Attack Patterns -->
                ${this.generateAttackPatternsSection(data.attackPatterns)}

                <!-- Geographical Threat Analysis -->
                ${data.geoThreats.length > 0 ? this.generateGeoThreatsSection(data.geoThreats) : ''}

                <!-- User Agent Threats -->
                ${data.userAgentThreats.length > 0 ? this.generateUserAgentThreatsSection(data.userAgentThreats) : ''}

                <!-- Recommendations -->
                ${this.generateRecommendationsSection(data.recommendations)}

                <!-- Report Footer -->
                <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center; color: #888; font-size: 12px;">
                    <p><strong>Advanced IIS Log Security Analyzer</strong> | Generated on ${new Date().toISOString()}</p>
                    <p>This report contains sensitive security information. Handle with appropriate confidentiality.</p>
                </div>
            </div>
        `;
    }

    // Generate Critical IPs section
    generateCriticalIPsSection(criticalIPs) {
        if (criticalIPs.length === 0) {
            return `
                <div style="margin-bottom: 30px;">
                    <h2 style="color: #059669; border-bottom: 2px solid #059669; padding-bottom: 10px;">✅ CRITICAL IP ADDRESSES</h2>
                    <p style="color: #059669; font-weight: bold;">No critical IP addresses detected.</p>
                </div>
            `;
        }

        return `
            <div style="margin-bottom: 30px;">
                <h2 style="color: #dc2626; border-bottom: 2px solid #dc2626; padding-bottom: 10px;">🚨 CRITICAL IP ADDRESSES (${criticalIPs.length} detected)</h2>
                <div style="background: #fef2f2; padding: 15px; border-radius: 6px; border-left: 4px solid #dc2626; margin-bottom: 20px;">
                    <strong>⚠️ IMMEDIATE ACTION REQUIRED:</strong> The following IP addresses pose significant security threats and should be blocked immediately.
                </div>
                
                ${criticalIPs.slice(0, 10).map((ip, index) => `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: #dc2626; font-size: 18px;">🔴 ${ip.ip}</h3>
                            <div style="text-align: right;">
                                <span style="background: ${this.getThreatColor(ip.threatLevel)}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                                    THREAT SCORE: ${ip.threatScore}/100
                                </span>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <strong>Total Requests:</strong> ${ip.requests.toLocaleString()}<br>
                                <strong>Failed Requests:</strong> ${ip.failedRequests.toLocaleString()}<br>
                                <strong>Error Rate:</strong> ${ip.errorRate}%
                            </div>
                            <div>
                                <strong>First Seen:</strong> ${new Date(ip.firstSeen).toLocaleString()}<br>
                                <strong>Last Seen:</strong> ${new Date(ip.lastSeen).toLocaleString()}<br>
                                <strong>Location:</strong> ${ip.geoLocation || 'Unknown'}
                            </div>
                            <div>
                                <strong>User Agents:</strong> ${ip.userAgents.length}<br>
                                <strong>Unique URLs:</strong> ${ip.topUrls.length}<br>
                                <strong>Reputation:</strong> ${ip.reputation.category}
                            </div>
                        </div>
                        
                        ${ip.attackTypes.length > 0 ? `
                            <div style="margin-bottom: 15px;">
                                <strong>🎯 Attack Types Detected:</strong><br>
                                ${ip.attackTypes.map(type => `<span style="background: #fecaca; color: #dc2626; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 5px;">${type}</span>`).join('')}
                            </div>
                        ` : ''}
                        
                        ${ip.topUrls.length > 0 ? `
                            <div style="margin-bottom: 15px;">
                                <strong>🎯 Top Targeted URLs:</strong>
                                <div style="background: #f9fafb; padding: 10px; border-radius: 4px; margin-top: 5px;">
                                    ${ip.topUrls.slice(0, 5).map(url => `<div style="font-family: monospace; font-size: 11px; color: #374151;">${url.url} (${url.count} requests)</div>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="background: #fffbeb; padding: 10px; border-radius: 4px; border-left: 3px solid #f59e0b;">
                            <strong>⚡ RECOMMENDED ACTION:</strong> 
                            Block this IP immediately using firewall rules. Monitor for similar activity patterns from related IP ranges.
                        </div>
                    </div>
                `).join('')}
                
                ${criticalIPs.length > 10 ? `
                    <div style="background: #f3f4f6; padding: 15px; border-radius: 6px; text-align: center; color: #666;">
                        <strong>... and ${criticalIPs.length - 10} more critical IPs</strong><br>
                        <small>Complete list available in detailed analysis logs</small>
                    </div>
                ` : ''}
            </div>
        `;
    }

    // Generate Payload Analysis section
    generatePayloadAnalysisSection(payloadAnalysis) {
        const totalPayloads = Object.values(payloadAnalysis).reduce((sum, arr) => sum + arr.length, 0);
        
        if (totalPayloads === 0) {
            return `
                <div style="margin-bottom: 30px;">
                    <h2 style="color: #059669; border-bottom: 2px solid #059669; padding-bottom: 10px;">✅ PAYLOAD ANALYSIS</h2>
                    <p style="color: #059669; font-weight: bold;">No malicious payloads detected.</p>
                </div>
            `;
        }

        return `
            <div style="margin-bottom: 30px;">
                <h2 style="color: #dc2626; border-bottom: 2px solid #dc2626; padding-bottom: 10px;">💀 MALICIOUS PAYLOAD ANALYSIS (${totalPayloads} detected)</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    ${Object.entries(payloadAnalysis).map(([type, payloads]) => `
                        <div style="background: white; border: 1px solid #e5e7eb; padding: 15px; text-align: center; border-radius: 6px;">
                            <div style="font-size: 20px; font-weight: bold; color: #dc2626;">${payloads.length}</div>
                            <div style="font-size: 12px; color: #666; text-transform: uppercase;">${type.replace(/([A-Z])/g, ' $1')}</div>
                        </div>
                    `).join('')}
                </div>
                
                ${Object.entries(payloadAnalysis)
                    .filter(([type, payloads]) => payloads.length > 0)
                    .map(([type, payloads]) => `
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                            <h3 style="color: #dc2626; margin-top: 0;">🔍 ${type.replace(/([A-Z])/g, ' $1').toUpperCase()} PAYLOADS (${payloads.length})</h3>
                            
                            ${payloads.slice(0, 5).map((payload, index) => `
                                <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 15px; margin-bottom: 10px; border-radius: 6px;">
                                    <div style="display: flex; justify-content: between; margin-bottom: 10px;">
                                        <strong>Payload #${index + 1}</strong>
                                        <span style="background: ${this.getSeverityColor(payload.severity)}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                            ${(payload.severity || 'medium').toUpperCase()}
                                        </span>
                                    </div>
                                    
                                    <div style="font-family: monospace; background: #1f2937; color: #f3f4f6; padding: 10px; border-radius: 4px; font-size: 12px; margin-bottom: 10px; word-break: break-all;">
                                        <strong>Original:</strong> ${this.escapeHtml(payload.payload)}<br>
                                        ${payload.decoded !== payload.payload ? `<strong>Decoded:</strong> ${this.escapeHtml(payload.decoded)}<br>` : ''}
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 12px;">
                                        <div><strong>Source IP:</strong> ${payload.source}</div>
                                        <div><strong>Timestamp:</strong> ${new Date(payload.timestamp).toLocaleString()}</div>
                                        <div><strong>Method:</strong> ${payload.method || 'Unknown'}</div>
                                        <div><strong>Risk Level:</strong> ${payload.analysis.risk || 'Unknown'}</div>
                                    </div>
                                    
                                    ${payload.analysis.techniques.length > 0 ? `
                                        <div style="margin-top: 10px;">
                                            <strong>Techniques:</strong> 
                                            ${payload.analysis.techniques.map(tech => `<span style="background: #fecaca; color: #dc2626; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-right: 5px;">${tech}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                            
                            ${payloads.length > 5 ? `
                                <div style="background: #f3f4f6; padding: 10px; border-radius: 4px; text-align: center; color: #666; font-size: 12px;">
                                    ... and ${payloads.length - 5} more ${type} payloads
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
            </div>
        `;
    }

    // Generate Security Events section
    generateSecurityEventsSection(securityEvents) {
        const totalEvents = Object.values(securityEvents).reduce((sum, arr) => sum + arr.length, 0);
        
        return `
            <div style="margin-bottom: 30px;">
                <h2 style="color: #dc2626; border-bottom: 2px solid #dc2626; padding-bottom: 10px;">📊 SECURITY EVENTS BREAKDOWN (${totalEvents} total)</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    ${Object.entries(securityEvents).map(([severity, events]) => `
                        <div style="background: white; border: 1px solid #e5e7eb; padding: 15px; text-align: center; border-radius: 6px; border-left: 4px solid ${this.getSeverityColor(severity)};">
                            <div style="font-size: 20px; font-weight: bold; color: ${this.getSeverityColor(severity)};">${events.length}</div>
                            <div style="font-size: 12px; color: #666; text-transform: uppercase;">${severity}</div>
                        </div>
                    `).join('')}
                </div>
                
                ${securityEvents.critical.length > 0 ? `
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                        <h3 style="color: #dc2626; margin-top: 0;">🚨 CRITICAL EVENTS (${securityEvents.critical.length})</h3>
                        ${securityEvents.critical.slice(0, 10).map((event, index) => `
                            <div style="background: white; padding: 10px; margin-bottom: 8px; border-radius: 4px; border-left: 3px solid #dc2626;">
                                <div style="font-weight: bold; color: #dc2626;">${event.description}</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    IP: ${event.ip} | Time: ${new Date(event.timestamp).toLocaleString()} | Category: ${event.category}
                                </div>
                                ${event.url ? `<div style="font-family: monospace; font-size: 11px; color: #374151; margin-top: 3px;">URL: ${event.url}</div>` : ''}
                            </div>
                        `).join('')}
                        ${securityEvents.critical.length > 10 ? `<div style="text-align: center; color: #666; font-size: 12px;">... and ${securityEvents.critical.length - 10} more critical events</div>` : ''}
                    </div>
                ` : ''}
            </div>
        `;
    }

    // Generate Attack Patterns section
    generateAttackPatternsSection(attackPatterns) {
        if (attackPatterns.length === 0) {
            return `
                <div style="margin-bottom: 30px;">
                    <h2 style="color: #059669; border-bottom: 2px solid #059669; padding-bottom: 10px;">✅ ATTACK PATTERNS</h2>
                    <p style="color: #059669; font-weight: bold;">No significant attack patterns detected.</p>
                </div>
            `;
        }

        return `
            <div style="margin-bottom: 30px;">
                <h2 style="color: #dc2626; border-bottom: 2px solid #dc2626; padding-bottom: 10px;">🎯 IDENTIFIED ATTACK PATTERNS (${attackPatterns.length})</h2>
                
                ${attackPatterns.map((pattern, index) => `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: #dc2626;">${pattern.type}</h3>
                            <span style="background: ${this.getSeverityColor(pattern.severity.toLowerCase())}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
                                ${pattern.severity.toUpperCase()}
                            </span>
                        </div>
                        
                        <p style="color: #666; margin-bottom: 15px;">${pattern.description}</p>
                        
                        ${pattern.ips && pattern.ips.length > 0 ? `
                            <div style="margin-bottom: 15px;">
                                <strong>Involved IP Addresses:</strong>
                                <div style="background: #f9fafb; padding: 10px; border-radius: 4px; margin-top: 5px;">
                                    ${pattern.ips.slice(0, 5).map(ip => `
                                        <div style="font-family: monospace; font-size: 12px; color: #374151;">
                                            ${typeof ip === 'object' ? `${ip.ip} (${ip.attempts} attempts, ${ip.rate} req/min)` : ip}
                                        </div>
                                    `).join('')}
                                    ${pattern.ips.length > 5 ? `<div style="font-size: 11px; color: #666;">... and ${pattern.ips.length - 5} more IPs</div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="background: #fffbeb; padding: 10px; border-radius: 4px; border-left: 3px solid #f59e0b;">
                            <strong>Recommendations:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                ${pattern.recommendations.map(rec => `<li style="font-size: 12px;">${rec}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // Generate Geographical Threats section
    generateGeoThreatsSection(geoThreats) {
        return `
            <div style="margin-bottom: 30px;">
                <h2 style="color: #dc2626; border-bottom: 2px solid #dc2626; padding-bottom: 10px;">🌍 GEOGRAPHICAL THREAT ANALYSIS</h2>
                
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f9fafb;">
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb;">Country</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid #e5e7eb;">Total IPs</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid #e5e7eb;">Malicious IPs</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid #e5e7eb;">Threat Ratio</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid #e5e7eb;">Risk Level</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${geoThreats.map(threat => `
                                <tr>
                                    <td style="padding: 10px; border-bottom: 1px solid #f3f4f6;">${threat.country}</td>
                                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #f3f4f6;">${threat.totalIPs}</td>
                                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #f3f4f6; color: #dc2626; font-weight: bold;">${threat.maliciousIPs}</td>
                                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #f3f4f6;">${threat.threatRatio}%</td>
                                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #f3f4f6;">
                                        <span style="background: ${this.getSeverityColor(threat.riskLevel.toLowerCase())}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                            ${threat.riskLevel}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    // Generate User Agent Threats section
    generateUserAgentThreatsSection(userAgentThreats) {
        return `
            <div style="margin-bottom: 30px;">
                <h2 style="color: #dc2626; border-bottom: 2px solid #dc2626; padding-bottom: 10px;">🤖 MALICIOUS USER AGENT ANALYSIS</h2>
                
                ${userAgentThreats.slice(0, 10).map((threat, index) => `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                            <strong style="color: #dc2626;">Threat #${index + 1}</strong>
                            <span style="background: ${this.getSeverityColor(threat.risk.toLowerCase())}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                ${threat.risk.toUpperCase()}
                            </span>
                        </div>
                        
                        <div style="font-family: monospace; background: #f9fafb; padding: 10px; border-radius: 4px; font-size: 12px; margin-bottom: 10px; word-break: break-all;">
                            ${this.escapeHtml(threat.userAgent)}
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; font-size: 12px;">
                            <div><strong>Type:</strong> ${threat.type}</div>
                            ${threat.count ? `<div><strong>Count:</strong> ${threat.count}</div>` : ''}
                            ${threat.ips ? `<div><strong>IPs:</strong> ${threat.ips}</div>` : ''}
                        </div>
                    </div>
                `).join('')}
                
                ${userAgentThreats.length > 10 ? `
                    <div style="background: #f3f4f6; padding: 10px; border-radius: 4px; text-align: center; color: #666; font-size: 12px;">
                        ... and ${userAgentThreats.length - 10} more malicious user agents
                    </div>
                ` : ''}
            </div>
        `;
    }

    // Generate Recommendations section
    generateRecommendationsSection(recommendations) {
        return `
            <div style="margin-bottom: 30px;">
                <h2 style="color: #059669; border-bottom: 2px solid #059669; padding-bottom: 10px;">💡 SECURITY RECOMMENDATIONS</h2>
                
                ${recommendations.map((rec, index) => `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 15px; border-left: 4px solid ${this.getPriorityColor(rec.priority)};">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: #374151;">${rec.category}</h3>
                            <span style="background: ${this.getPriorityColor(rec.priority)}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
                                ${rec.priority.toUpperCase()}
                            </span>
                        </div>
                        
                        <p style="color: #666; margin-bottom: 10px;"><strong>Issue:</strong> ${rec.description}</p>
                        <p style="color: #666; margin-bottom: 10px;"><strong>Action:</strong> ${rec.action}</p>
                        <p style="color: #666; margin-bottom: 0;"><strong>Impact:</strong> ${rec.impact}</p>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // Generate PDF using jsPDF
    async generatePDF(htmlContent) {
        const { jsPDF } = window.jspdf;
        
        if (!jsPDF) {
            throw new Error('jsPDF library not loaded');
        }

        // Create a temporary container for the content
        const tempContainer = document.createElement('div');
        tempContainer.innerHTML = htmlContent;
        tempContainer.style.width = '210mm'; // A4 width
        tempContainer.style.padding = '20px';
        tempContainer.style.boxSizing = 'border-box';
        tempContainer.style.fontFamily = 'Arial, sans-serif';
        tempContainer.style.fontSize = '12px';
        tempContainer.style.lineHeight = '1.4';
        tempContainer.style.position = 'absolute';
        tempContainer.style.top = '-10000px';
        tempContainer.style.left = '-10000px';
        
        document.body.appendChild(tempContainer);
        
        try {
            // Use html2canvas to convert HTML to canvas
            const canvas = await html2canvas(tempContainer, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                width: 794, // A4 width in pixels at 96 DPI
                height: tempContainer.scrollHeight
            });
            
            // Create PDF
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const imgData = canvas.toDataURL('image/png');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = pdfWidth;
            const imgHeight = (canvas.height * pdfWidth) / canvas.width;
            
            let heightLeft = imgHeight;
            let position = 0;
            
            // Add first page
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pdfHeight;
            
            // Add additional pages if needed
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pdfHeight;
            }
            
            // Generate filename with timestamp
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const filename = `IIS-Security-Analysis-${timestamp}.pdf`;
            
            // Save the PDF
            pdf.save(filename);
            
        } finally {
            // Clean up
            document.body.removeChild(tempContainer);
        }
    }

    // Helper functions
    getElementNumber(id) {
        const element = document.getElementById(id);
        if (!element) return 0;
        return parseInt(element.textContent.replace(/,/g, '')) || 0;
    }

    getAnalysisTimeRange(results) {
        if (results.stats && results.stats.timeRange) {
            return results.stats.timeRange;
        }
        return 'Analysis period not specified';
    }

    getThreatColor(threatLevel) {
        const colors = {
            'Critical': '#dc2626',
            'High': '#ea580c',
            'Medium': '#f59e0b',
            'Low': '#059669'
        };
        return colors[threatLevel] || '#6b7280';
    }

    getSeverityColor(severity) {
        const colors = {
            'critical': '#dc2626',
            'high': '#ea580c',
            'medium': '#f59e0b',
            'low': '#059669'
        };
        return colors[severity.toLowerCase()] || '#6b7280';
    }

    getPriorityColor(priority) {
        const colors = {
            'Critical': '#dc2626',
            'High': '#ea580c',
            'Medium': '#f59e0b',
            'Low': '#059669'
        };
        return colors[priority] || '#6b7280';
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    getTopUrls(urls) {
        return Object.entries(urls || {})
            .map(([url, count]) => ({ url, count }))
            .sort((a, b) => b.count - a.count)
            .slice(0, 10);
    }

    identifyAttackTypes(data) {
        const types = [];
        
        if (data.scanner) types.push('Port Scanning');
        if (data.malicious) types.push('Malicious Activity');
        if (data.bruteForce) types.push('Brute Force');
        if (data.attackChain) types.push('Attack Chain');
        
        // Check URL patterns for attack types
        const urls = Object.keys(data.urls || {});
        if (urls.some(url => url.includes('admin'))) types.push('Admin Panel Targeting');
        if (urls.some(url => url.includes('.php') || url.includes('.asp'))) types.push('File Enumeration');
        
        return types.length > 0 ? types : ['General Suspicious Activity'];
    }

    getGeoLocation(ip) {
        // Simple geo location based on IP
        // In production, use a real geolocation service
        const geoMap = {
            '192.168': 'Local Network',
            '10.': 'Private Network',
            '172.': 'Private Network'
        };
        
        for (const [prefix, location] of Object.entries(geoMap)) {
            if (ip.startsWith(prefix)) {
                return location;
            }
        }
        
        // Mock country assignment based on IP hash
        const countries = ['United States', 'China', 'Russia', 'Germany', 'Brazil', 'India', 'Unknown'];
        const hash = ip.split('.').reduce((sum, octet) => sum + parseInt(octet), 0);
        return countries[hash % countries.length];
    }

    getIPReputation(ip) {
        // Mock reputation scoring
        const hash = ip.split('.').reduce((sum, octet) => sum + parseInt(octet), 0);
        const score = hash % 100;
        
        return {
            score: score,
            category: score > 80 ? 'Malicious' : score > 50 ? 'Suspicious' : 'Clean'
        };
    }

    analyzeBehaviors(data) {
        const behaviors = [];
        
        const errorRate = data.requests > 0 ? (data.failedRequests || 0) / data.requests : 0;
        if (errorRate > 0.5) behaviors.push('High Error Rate');
        
        const urlCount = Object.keys(data.urls || {}).length;
        if (urlCount > 50) behaviors.push('High URL Diversity');
        
        const userAgentCount = Array.isArray(data.userAgents) ? data.userAgents.length : 0;
        if (userAgentCount > 5) behaviors.push('Multiple User Agents');
        
        return behaviors;
    }

    getTimeSpan(events) {
        if (events.length < 2) return 'N/A';
        
        const first = new Date(events[0].timestamp);
        const last = new Date(events[events.length - 1].timestamp);
        const diffMinutes = (last - first) / (1000 * 60);
        
        if (diffMinutes < 60) return `${diffMinutes.toFixed(1)} minutes`;
        if (diffMinutes < 1440) return `${(diffMinutes / 60).toFixed(1)} hours`;
        return `${(diffMinutes / 1440).toFixed(1)} days`;
    }

    calculateAttemptRate(events) {
        if (events.length < 2) return 0;
        
        const first = new Date(events[0].timestamp);
        const last = new Date(events[events.length - 1].timestamp);
        const diffMinutes = (last - first) / (1000 * 60);
        
        return diffMinutes > 0 ? (events.length / diffMinutes).toFixed(2) : 0;
    }

    showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm';
        
        // Set color based on type
        const colors = {
            success: 'bg-green-500 text-white',
            error: 'bg-red-500 text-white',
            warning: 'bg-yellow-500 text-black',
            info: 'bg-blue-500 text-white'
        };
        
        notification.className += ' ' + (colors[type] || colors.info);
        notification.textContent = message;
        
        // Add to DOM
        document.body.appendChild(notification);
        
        // Remove after 4 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 4000);
    }
}

// Initialize the security report generator when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    // Wait a bit to ensure other components are loaded
    setTimeout(() => {
        window.securityReportGenerator = new AdvancedSecurityReportGenerator();
    }, 1000);
});
</script>