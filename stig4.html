<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise STIG Compliance Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx-js-style/1.2.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/pdfmake.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/vfs_fonts.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'inter': ['Inter', 'sans-serif'] },
                    colors: {
                        'brand': '#0066cc',
                        'brand-dark': '#004499',
                        'brand-light': '#3399ff',
                        'success': '#00c851',
                        'danger': '#ff4444',
                        'warning': '#ffbb33',
                        'info': '#00bcd4',
                        'purple': '#6f42c1',
                        'indigo': '#6610f2'
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
        .animate-slideUp { animation: slideUp 0.5s ease-out; }
        .animate-bounce { animation: bounce 0.6s ease-out; }
        .animate-pulse-slow { animation: pulse-slow 2s infinite; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0, -20px, 0); }
            70% { transform: translate3d(0, -10px, 0); }
            90% { transform: translate3d(0, -4px, 0); }
        }
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .card { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
            transition: all 0.3s ease; 
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        
        .btn-primary { 
            background: linear-gradient(135deg, #0066cc 0%, #004499 100%); 
            box-shadow: 0 4px 14px 0 rgba(0, 102, 204, 0.39);
        }
        .btn-primary:hover { 
            background: linear-gradient(135deg, #004499 0%, #003366 100%); 
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            box-shadow: 0 4px 14px 0 rgba(108, 117, 125, 0.39);
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            transform: translateY(-2px);
        }
        
        .nav-tab { transition: all 0.3s ease; border-bottom: 3px solid transparent; position: relative; }
        .nav-tab.active { 
            border-bottom-color: #0066cc; 
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            color: #0066cc;
            font-weight: 600;
        }
        .nav-tab:hover { background-color: #f8fafc; transform: translateY(-1px); }
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .table-hover:hover { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); }
        
        .progress-bar { transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .metric-hover:hover { transform: scale(1.05); }
        
        .gradient-bg { background: linear-gradient(135deg, #0066cc 0%, #003d7a 100%); }
        .gradient-card { background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); }
        
        .file-item {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .file-item.active {
            border-color: #0066cc;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
        }
        .file-item:hover {
            border-color: #3399ff;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .risk-badge-critical { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .risk-badge-high { background: linear-gradient(135deg, #fd7e14 0%, #e55a0c 100%); }
        .risk-badge-medium { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); }
        .risk-badge-low { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        
        .comment-bubble {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #0066cc;
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* Enhanced transitions */
        .transition-all-smooth { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Modal backdrop blur */
        .modal-backdrop { backdrop-filter: blur(8px); background: rgba(0, 0, 0, 0.6); }
        
        /* Enhanced form elements */
        .form-input {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
        }
        .form-input:focus {
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
            background: #ffffff;
            outline: none;
        }
        
        /* Enhanced buttons */
        .btn-enhanced {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: none;
        }
        .btn-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .btn-enhanced:hover::before {
            left: 100%;
        }

        /* Hidden chart canvas for PDF generation */
        .chart-hidden {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 800px;
            height: 400px;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-xl sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center justify-center w-14 h-14 bg-white/20 rounded-xl backdrop-blur">
                        <i class="fas fa-shield-check text-3xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Enterprise STIG Manager Pro</h1>
                        <p class="text-white/80 text-sm">Security Technical Implementation Guide Compliance Platform</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-6">
                    <div class="hidden lg:flex items-center space-x-4 text-sm">
                        <div class="bg-white/20 rounded-xl px-4 py-3 backdrop-blur">
                            <i class="fas fa-database mr-2"></i>
                            <span id="headerTotal" class="font-semibold">0</span> Requirements
                        </div>
                        <div class="bg-white/20 rounded-xl px-4 py-3 backdrop-blur">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span id="headerCompliant" class="font-semibold">0%</span> Compliant
                        </div>
                        <div class="bg-white/20 rounded-xl px-4 py-3 backdrop-blur">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <span id="headerHighRisk" class="font-semibold">0</span> High Risk
                        </div>
                    </div>
                    
                    <button id="exportBtn" onclick="showExportModal()" class="hidden bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl font-medium transition-all btn-enhanced">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white border-b border-gray-200 sticky top-20 z-40">
        <div class="container mx-auto px-6">
            <div class="flex space-x-0 overflow-x-auto">
                <button class="nav-tab active px-6 py-4 text-sm font-medium whitespace-nowrap" data-tab="system">
                    <i class="fas fa-cog mr-2"></i>System Info
                </button>
                <button class="nav-tab px-6 py-4 text-sm font-medium whitespace-nowrap" data-tab="upload">
                    <i class="fas fa-upload mr-2"></i>Upload & Parse
                </button>
                <button class="nav-tab px-6 py-4 text-sm font-medium whitespace-nowrap" data-tab="dashboard">
                    <i class="fas fa-chart-pie mr-2"></i>Dashboard
                </button>
                <button class="nav-tab px-6 py-4 text-sm font-medium whitespace-nowrap" data-tab="requirements">
                    <i class="fas fa-list-check mr-2"></i>Requirements
                </button>
                <button class="nav-tab px-6 py-4 text-sm font-medium whitespace-nowrap" data-tab="analytics">
                    <i class="fas fa-chart-line mr-2"></i>Analytics
                </button>
                <button class="nav-tab px-6 py-4 text-sm font-medium whitespace-nowrap" data-tab="compliance">
                    <i class="fas fa-clipboard-check mr-2"></i>Compliance
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- System Information Section -->
        <section id="system" class="tab-section active">
            <div class="max-w-6xl mx-auto">
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-bold text-gray-900 mb-4">System Information</h2>
                    <p class="text-xl text-gray-600">Configure system details for STIG compliance review</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- System Details Form -->
                    <div class="card p-8">
                        <h3 class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                            <i class="fas fa-server text-brand mr-3"></i>
                            System Configuration
                        </h3>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">System Name</label>
                                <input type="text" id="systemName" placeholder="e.g., Production Web Server" 
                                       class="form-input w-full">
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-3">Operating System</label>
                                    <select id="operatingSystem" class="form-input w-full">
                                        <option value="">Select OS</option>
                                        <option value="Windows Server 2019">Windows Server 2019</option>
                                        <option value="Windows Server 2022">Windows Server 2022</option>
                                        <option value="RHEL 8">Red Hat Enterprise Linux 8</option>
                                        <option value="RHEL 9">Red Hat Enterprise Linux 9</option>
                                        <option value="Ubuntu 20.04">Ubuntu 20.04 LTS</option>
                                        <option value="Ubuntu 22.04">Ubuntu 22.04 LTS</option>
                                        <option value="CentOS 7">CentOS 7</option>
                                        <option value="CentOS 8">CentOS 8</option>
                                        <option value="Oracle Linux 8">Oracle Linux 8</option>
                                        <option value="SUSE Linux">SUSE Linux Enterprise</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-3">Classification Level</label>
                                    <select id="classificationLevel" class="form-input w-full">
                                        <option value="">Select Classification</option>
                                        <option value="Unclassified">Unclassified</option>
                                        <option value="CUI">Controlled Unclassified Information (CUI)</option>
                                        <option value="Confidential">Confidential</option>
                                        <option value="Secret">Secret</option>
                                        <option value="Top Secret">Top Secret</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-3">Environment</label>
                                    <select id="environment" class="form-input w-full">
                                        <option value="">Select Environment</option>
                                        <option value="Production">Production</option>
                                        <option value="Staging">Staging</option>
                                        <option value="Development">Development</option>
                                        <option value="Testing">Testing</option>
                                        <option value="Training">Training</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-3">MAC Level</label>
                                    <select id="macLevel" class="form-input w-full">
                                        <option value="">Select MAC Level</option>
                                        <option value="MAC I">MAC I (Public)</option>
                                        <option value="MAC II">MAC II (Sensitive)</option>
                                        <option value="MAC III">MAC III (Classified)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">System Purpose/Function</label>
                                <textarea id="systemPurpose" rows="4" placeholder="Describe the primary function and purpose of this system..."
                                          class="form-input w-full resize-none"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-3">System Owner</label>
                                    <input type="text" id="systemOwner" placeholder="John Doe" class="form-input w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-3">ISSO/Security Contact</label>
                                    <input type="text" id="securityContact" placeholder="Jane Smith" class="form-input w-full">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">Network Location/Enclave</label>
                                <input type="text" id="networkLocation" placeholder="e.g., DMZ, Internal Network, Secure Enclave" 
                                       class="form-input w-full">
                            </div>
                        </div>
                        
                        <div class="mt-8 flex justify-end">
                            <button onclick="saveSystemInfo()" class="btn-primary text-white btn-enhanced">
                                <i class="fas fa-save mr-2"></i>Save System Information
                            </button>
                        </div>
                    </div>

                    <!-- Review Information -->
                    <div class="space-y-8">
                        <!-- Review Details -->
                        <div class="card p-8">
                            <h3 class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                                <i class="fas fa-clipboard-list text-brand mr-3"></i>
                                Review Information
                            </h3>
                            
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-3">Review Date</label>
                                        <input type="date" id="reviewDate" class="form-input w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-3">Review Type</label>
                                        <select id="reviewType" class="form-input w-full">
                                            <option value="">Select Review Type</option>
                                            <option value="Initial Assessment">Initial Assessment</option>
                                            <option value="Annual Review">Annual Review</option>
                                            <option value="Quarterly Review">Quarterly Review</option>
                                            <option value="Change Control">Change Control</option>
                                            <option value="Incident Response">Incident Response</option>
                                            <option value="Audit Preparation">Audit Preparation</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-3">Reviewer Name</label>
                                    <input type="text" id="reviewerName" placeholder="Security Analyst Name" class="form-input w-full">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-3">Review Scope</label>
                                    <textarea id="reviewScope" rows="3" placeholder="Describe the scope and objectives of this STIG review..."
                                              class="form-input w-full resize-none"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Compliance Summary -->
                        <div class="card p-8">
                            <h3 class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                                <i class="fas fa-chart-bar text-brand mr-3"></i>
                                Current Status
                            </h3>
                            
                            <div class="grid grid-cols-2 gap-6">
                                <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl">
                                    <div class="text-3xl font-bold text-blue-600" id="systemTotalReqs">0</div>
                                    <div class="text-sm text-blue-700 font-medium">Total Requirements</div>
                                </div>
                                <div class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-xl">
                                    <div class="text-3xl font-bold text-green-600" id="systemComplianceRate">0%</div>
                                    <div class="text-sm text-green-700 font-medium">Compliance Rate</div>
                                </div>
                                <div class="text-center p-4 bg-gradient-to-br from-red-50 to-red-100 rounded-xl">
                                    <div class="text-3xl font-bold text-red-600" id="systemHighRisk">0</div>
                                    <div class="text-sm text-red-700 font-medium">High Risk Items</div>
                                </div>
                                <div class="text-center p-4 bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl">
                                    <div class="text-3xl font-bold text-yellow-600" id="systemPending">0</div>
                                    <div class="text-sm text-yellow-700 font-medium">Pending Review</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Upload Section -->
        <section id="upload" class="tab-section hidden">
            <div class="max-w-6xl mx-auto">
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-bold text-gray-900 mb-4">Multi-File STIG Parser</h2>
                    <p class="text-xl text-gray-600">Upload multiple STIG JSON files for comprehensive analysis</p>
                </div>

                <!-- Upload Card -->
                <div class="card p-12 mb-8 text-center animate-fadeIn">
                    <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-2xl p-16 hover:border-brand hover:bg-blue-50 transition-all duration-300 cursor-pointer group">
                        <div class="flex flex-col items-center">
                            <div class="w-24 h-24 bg-gradient-to-r from-brand to-brand-dark rounded-full flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                                <i class="fas fa-cloud-upload-alt text-3xl text-white"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-3">Drop STIG JSON Files</h3>
                            <p class="text-gray-600 mb-8 max-w-md">Drag and drop multiple STIG JSON files here or click to browse. Each file will be processed separately.</p>
                            <button class="btn-primary text-white px-8 py-4 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all btn-enhanced">
                                <i class="fas fa-folder-open mr-2"></i>Choose Files
                            </button>
                            <p class="text-sm text-gray-500 mt-4">Supports JSON files up to 100MB each â€¢ Multiple file selection</p>
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept=".json" multiple class="hidden">
                </div>

                <!-- Processed Files Display -->
                <div id="processedFiles" class="hidden">
                    <div class="mb-8">
                        <h3 class="text-2xl font-semibold text-gray-900 mb-6">Processed STIG Files</h3>
                        <div id="filesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- File cards will be dynamically added here -->
                        </div>
                    </div>
                </div>

                <!-- Progress Section -->
                <div id="progressSection" class="hidden">
                    <div class="card p-8 mb-8 animate-slideUp">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-4">
                                <div class="animate-spin w-8 h-8 border-4 border-brand border-t-transparent rounded-full"></div>
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-900">Processing STIG Files</h3>
                                    <p class="text-gray-600" id="progressMessage">Starting...</p>
                                </div>
                            </div>
                            <div class="text-3xl font-bold text-brand" id="progressPercent">0%</div>
                        </div>
                        
                        <div class="relative">
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div id="progressBar" class="progress-bar h-4 bg-gradient-to-r from-brand to-brand-dark rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-4 gap-6 mt-8 text-center">
                            <div>
                                <div class="text-2xl font-bold text-gray-900" id="filesProcessed">0</div>
                                <div class="text-sm text-gray-600">Files Processed</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-gray-900" id="parsedCount">0</div>
                                <div class="text-sm text-gray-600">Requirements Parsed</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-gray-900" id="validatedCount">0</div>
                                <div class="text-sm text-gray-600">Validated</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-gray-900" id="processedCount">0</div>
                                <div class="text-sm text-gray-600">Total Processed</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 animate-bounce">
                        <div class="card p-6 text-center metric-hover">
                            <div class="text-3xl font-bold text-gray-900" id="totalParsed">0</div>
                            <div class="text-gray-600">Total Requirements</div>
                            <div class="text-sm text-brand mt-2" id="totalFiles">0 files</div>
                        </div>
                        <div class="card p-6 text-center metric-hover">
                            <div class="text-3xl font-bold text-danger" id="highSeverity">0</div>
                            <div class="text-gray-600">High Risk</div>
                            <div class="text-sm text-red-600 mt-2">Immediate attention</div>
                        </div>
                        <div class="card p-6 text-center metric-hover">
                            <div class="text-3xl font-bold text-warning" id="mediumSeverity">0</div>
                            <div class="text-gray-600">Medium Risk</div>
                            <div class="text-sm text-yellow-600 mt-2">Plan remediation</div>
                        </div>
                        <div class="card p-6 text-center metric-hover">
                            <div class="text-3xl font-bold text-success" id="lowSeverity">0</div>
                            <div class="text-gray-600">Low Risk</div>
                            <div class="text-sm text-green-600 mt-2">Monitor</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard" class="tab-section hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Compliance Dashboard</h2>
                <p class="text-xl text-gray-600">Real-time overview of STIG compliance metrics across all systems</p>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                <div class="card p-6 metric-hover gradient-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-2 font-semibold">Total Requirements</p>
                            <p class="text-3xl font-bold text-gray-900" id="dashTotal">0</p>
                            <p class="text-sm text-brand flex items-center mt-2">
                                <i class="fas fa-database mr-1"></i>
                                <span id="dashFiles">0</span> STIG files loaded
                            </p>
                        </div>
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-100 to-blue-200 rounded-full flex items-center justify-center">
                            <i class="fas fa-list text-brand text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="card p-6 metric-hover gradient-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-2 font-semibold">Compliance Rate</p>
                            <p class="text-3xl font-bold text-gray-900" id="dashCompliance">0%</p>
                            <p class="text-sm text-success flex items-center mt-2">
                                <i class="fas fa-arrow-up mr-1"></i>
                                <span id="complianceChange">+0%</span> this month
                            </p>
                        </div>
                        <div class="w-16 h-16 bg-gradient-to-br from-green-100 to-green-200 rounded-full flex items-center justify-center">
                            <i class="fas fa-check-circle text-success text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="card p-6 metric-hover gradient-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-2 font-semibold">Critical & High Risk</p>
                            <p class="text-3xl font-bold text-gray-900" id="dashHighRisk">0</p>
                            <p class="text-sm text-danger flex items-center mt-2">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                Immediate attention required
                            </p>
                        </div>
                        <div class="w-16 h-16 bg-gradient-to-br from-red-100 to-red-200 rounded-full flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-danger text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="card p-6 metric-hover gradient-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-2 font-semibold">Security Score</p>
                            <p class="text-3xl font-bold text-gray-900" id="dashSecurityScore">0</p>
                            <p class="text-sm text-info flex items-center mt-2">
                                <i class="fas fa-shield-alt mr-1"></i>
                                Overall security posture
                            </p>
                        </div>
                        <div class="w-16 h-16 bg-gradient-to-br from-indigo-100 to-indigo-200 rounded-full flex items-center justify-center">
                            <i class="fas fa-shield-alt text-info text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 mb-12">
                <div class="xl:col-span-2 card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Compliance Trend Analysis</h3>
                    <div style="height: 350px;">
                        <canvas id="complianceTrendChart"></canvas>
                    </div>
                </div>

                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Risk Distribution</h3>
                    <div style="height: 350px;">
                        <canvas id="riskChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Progress by Category -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-8">Progress by Risk Level</h3>
                    <div class="space-y-8">
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <span class="font-medium text-gray-700">Critical & High Risk</span>
                                <span class="text-sm text-gray-600">
                                    <span id="highCompliant">0</span> / <span id="highTotal">0</span> Complete
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div class="progress-bar bg-gradient-to-r from-red-500 to-red-600 h-4 rounded-full" id="highProgress" style="width: 0%"></div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <span class="font-medium text-gray-700">Medium Risk</span>
                                <span class="text-sm text-gray-600">
                                    <span id="mediumCompliant">0</span> / <span id="mediumTotal">0</span> Complete
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div class="progress-bar bg-gradient-to-r from-yellow-400 to-yellow-500 h-4 rounded-full" id="mediumProgress" style="width: 0%"></div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <span class="font-medium text-gray-700">Low Risk</span>
                                <span class="text-sm text-gray-600">
                                    <span id="lowCompliant">0</span> / <span id="lowTotal">0</span> Complete
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div class="progress-bar bg-gradient-to-r from-green-400 to-green-500 h-4 rounded-full" id="lowProgress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-8">File-wise Status</h3>
                    <div id="fileStatusList" class="space-y-4 max-h-80 overflow-y-auto custom-scrollbar">
                        <!-- File status items will be populated here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Requirements Section -->
        <section id="requirements" class="tab-section hidden">
            <div class="mb-8">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-4">Requirements Management</h2>
                        <p class="text-xl text-gray-600">Manage and track individual STIG requirements across all files</p>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="toggleView()" id="viewToggle" class="btn-secondary text-white btn-enhanced">
                            <i class="fas fa-table mr-2"></i>Table View
                        </button>
                        <button onclick="exportRequirements()" class="btn-primary text-white btn-enhanced">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- File Filter -->
            <div class="card p-6 mb-6">
                <div class="flex items-center space-x-4 mb-4">
                    <i class="fas fa-filter text-brand"></i>
                    <span class="font-semibold text-gray-700">Filter by STIG File:</span>
                    <select id="fileFilter" class="form-input" onchange="applyFilters()">
                        <option value="">All Files</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="text-sm text-gray-600">
                    <span id="fileFilterStatus">Showing requirements from all STIG files</span>
                </div>
            </div>

            <!-- Filters -->
            <div class="card p-6 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="searchInput" placeholder="Search requirements..." 
                                   class="form-input w-full pl-10">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Severity</label>
                        <select id="severityFilter" class="form-input w-full">
                            <option value="">All</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="statusFilter" class="form-input w-full">
                            <option value="">All</option>
                            <option value="compliant">Compliant</option>
                            <option value="non-compliant">Non-Compliant</option>
                            <option value="in-progress">In Progress</option>
                            <option value="not-reviewed">Not Reviewed</option>
                        </select>
                    </div>
                    <div>
                        <button onclick="clearFilters()" class="btn-secondary text-white w-full btn-enhanced">
                            <i class="fas fa-times mr-2"></i>Clear
                        </button>
                    </div>
                </div>
                
                <div class="mt-4 flex justify-between items-center text-sm text-gray-600">
                    <div>
                        Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> requirements
                    </div>
                    <div class="flex items-center space-x-4">
                        <span>Items per page:</span>
                        <select id="itemsPerPage" onchange="changeItemsPerPage(this.value)" class="form-input py-1 px-2 text-sm">
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="250">250</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div id="bulkActions" class="hidden card p-4 mb-6 border-l-4 border-brand">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <i class="fas fa-check-square text-brand"></i>
                        <span class="font-medium text-brand">
                            <span id="selectedCount">0</span> requirements selected
                        </span>
                        <select id="bulkStatus" class="form-input py-2 px-3 text-sm">
                            <option value="">Update Status</option>
                            <option value="compliant">Mark Compliant</option>
                            <option value="non-compliant">Mark Non-Compliant</option>
                            <option value="in-progress">Mark In Progress</option>
                        </select>
                        <button onclick="applyBulkUpdate()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm btn-enhanced">
                            Apply
                        </button>
                    </div>
                    <button onclick="clearSelection()" class="text-brand hover:text-brand-dark text-sm">
                        Clear Selection
                    </button>
                </div>
            </div>

            <!-- Requirements Table -->
            <div id="requirementsTable" class="card overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gradient-to-r from-gray-50 to-gray-100 border-b">
                            <tr>
                                <th class="px-6 py-4 text-left">
                                    <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-brand focus:ring-brand">
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-all" onclick="sortTable('vulnerability_id')">
                                    Vuln ID <i class="fas fa-sort ml-2"></i>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-all" onclick="sortTable('title')">
                                    Title <i class="fas fa-sort ml-2"></i>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-all" onclick="sortTable('severity')">
                                    Severity <i class="fas fa-sort ml-2"></i>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-all" onclick="sortTable('status')">
                                    Status <i class="fas fa-sort ml-2"></i>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-all" onclick="sortTable('stig_file')">
                                    STIG File <i class="fas fa-sort ml-2"></i>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-gray-200">
                            <!-- Table rows will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="bg-white px-6 py-4 border-t">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-600">
                            Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="firstPage()" id="firstBtn" class="px-3 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 disabled:opacity-50 btn-enhanced">
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                            <button onclick="previousPage()" id="prevBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 disabled:opacity-50 btn-enhanced">
                                <i class="fas fa-chevron-left mr-1"></i>Previous
                            </button>
                            <span class="px-4 py-2 text-sm text-gray-600">
                                <input type="number" id="pageInput" min="1" value="1" class="w-16 text-center border border-gray-300 rounded px-2 py-1">
                            </span>
                            <button onclick="nextPage()" id="nextBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 disabled:opacity-50 btn-enhanced">
                                Next<i class="fas fa-chevron-right ml-1"></i>
                            </button>
                            <button onclick="lastPage()" id="lastBtn" class="px-3 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 disabled:opacity-50 btn-enhanced">
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="tab-section hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Advanced Analytics</h2>
                <p class="text-xl text-gray-600">Deep insights into compliance trends, risk analysis, and security metrics</p>
            </div>

            <!-- Time Range Selector -->
            <div class="card p-6 mb-8">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Analysis Period</h3>
                    <div class="flex items-center space-x-4">
                        <select id="timeRange" onchange="updateAnalytics()" class="form-input">
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="180">Last 6 Months</option>
                            <option value="365">Last Year</option>
                        </select>
                        <button onclick="refreshAnalytics()" class="btn-primary text-white btn-enhanced">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analytics Grid -->
            <div class="grid grid-cols-1 xl:grid-cols-4 gap-8 mb-12">
                <div class="xl:col-span-3 card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Security Posture Trends</h3>
                    <div style="height: 400px;">
                        <canvas id="securityTrendsChart"></canvas>
                    </div>
                </div>

                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Risk Assessment</h3>
                    <div class="space-y-4">
                        <div class="risk-badge-critical text-white rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="status-dot bg-white"></div>
                                    <span class="font-medium">Critical</span>
                                </div>
                                <span class="text-white font-bold text-xl" id="criticalCount">0</span>
                            </div>
                            <div class="text-sm text-white/80 mt-2">Immediate action required</div>
                        </div>
                        <div class="risk-badge-high text-white rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="status-dot bg-white"></div>
                                    <span class="font-medium">High</span>
                                </div>
                                <span class="text-white font-bold text-xl" id="highRiskCount">0</span>
                            </div>
                            <div class="text-sm text-white/80 mt-2">Address within 1 week</div>
                        </div>
                        <div class="risk-badge-medium text-white rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="status-dot bg-white"></div>
                                    <span class="font-medium">Medium</span>
                                </div>
                                <span class="text-white font-bold text-xl" id="mediumRiskCount">0</span>
                            </div>
                            <div class="text-sm text-white/80 mt-2">Plan remediation</div>
                        </div>
                        <div class="risk-badge-low text-white rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="status-dot bg-white"></div>
                                    <span class="font-medium">Low</span>
                                </div>
                                <span class="text-white font-bold text-xl" id="lowRiskCount">0</span>
                            </div>
                            <div class="text-sm text-white/80 mt-2">Monitor and review</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Security Maturity Score</h3>
                    <div style="height: 300px;">
                        <canvas id="maturityChart"></canvas>
                    </div>
                </div>

                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Compliance Velocity</h3>
                    <div style="height: 300px;">
                        <canvas id="velocityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Metrics -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Performance Indicators</h3>
                    <div class="space-y-6">
                        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg">
                            <span class="font-medium text-blue-900">Overall Security Score</span>
                            <div class="flex items-center space-x-3">
                                <div class="w-32 bg-blue-200 rounded-full h-3">
                                    <div class="bg-blue-600 h-3 rounded-full progress-bar" id="overallSecurityBar" style="width: 0%"></div>
                                </div>
                                <span class="font-bold text-blue-600" id="overallSecurity">0%</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-green-50 to-green-100 rounded-lg">
                            <span class="font-medium text-green-900">Risk Mitigation Rate</span>
                            <div class="flex items-center space-x-3">
                                <div class="w-32 bg-green-200 rounded-full h-3">
                                    <div class="bg-green-600 h-3 rounded-full progress-bar" id="riskMitigationBar" style="width: 0%"></div>
                                </div>
                                <span class="font-bold text-green-600" id="riskMitigation">0%</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg">
                            <span class="font-medium text-purple-900">Implementation Quality</span>
                            <div class="flex items-center space-x-3">
                                <div class="w-32 bg-purple-200 rounded-full h-3">
                                    <div class="bg-purple-600 h-3 rounded-full progress-bar" id="qualityBar" style="width: 0%"></div>
                                </div>
                                <span class="font-bold text-purple-600" id="quality">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Remediation Metrics</h3>
                    <div class="space-y-4">
                        <div class="border-l-4 border-red-500 pl-4">
                            <div class="text-2xl font-bold text-gray-900" id="avgRemediationTime">0</div>
                            <div class="text-sm text-gray-600">Avg. Remediation Time (days)</div>
                        </div>
                        <div class="border-l-4 border-yellow-500 pl-4">
                            <div class="text-2xl font-bold text-gray-900" id="pendingRemediation">0</div>
                            <div class="text-sm text-gray-600">Pending Remediation</div>
                        </div>
                        <div class="border-l-4 border-green-500 pl-4">
                            <div class="text-2xl font-bold text-gray-900" id="completedThisMonth">0</div>
                            <div class="text-sm text-gray-600">Completed This Month</div>
                        </div>
                        <div class="border-l-4 border-blue-500 pl-4">
                            <div class="text-2xl font-bold text-gray-900" id="complianceVelocity">0</div>
                            <div class="text-sm text-gray-600">Items/Month Velocity</div>
                        </div>
                    </div>
                </div>

                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">STIG File Analysis</h3>
                    <div id="stigFileAnalysis" class="space-y-4 max-h-64 overflow-y-auto custom-scrollbar">
                        <!-- STIG file analysis items will be populated here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Compliance Section -->
        <section id="compliance" class="tab-section hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">Compliance Tracking & Reporting</h2>
                <p class="text-xl text-gray-600">Generate professional reports and track compliance progress over time</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <div class="lg:col-span-2 card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Compliance Timeline</h3>
                    <div style="height: 400px;">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>

                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Generate Reports</h3>
                    <div class="space-y-4">
                        <button onclick="generateReport('executive')" class="w-full p-4 text-left border-2 border-gray-200 rounded-xl hover:border-brand hover:bg-blue-50 transition-all group">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-100 to-blue-200 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                    <i class="fas fa-chart-line text-brand text-xl"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-900">Executive Summary</div>
                                    <div class="text-sm text-gray-600">High-level compliance overview with charts</div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="generateReport('detailed')" class="w-full p-4 text-left border-2 border-gray-200 rounded-xl hover:border-brand hover:bg-blue-50 transition-all group">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-100 to-green-200 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                    <i class="fas fa-file-alt text-success text-xl"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-900">Detailed Technical Report</div>
                                    <div class="text-sm text-gray-600">Complete requirements analysis with visuals</div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="generateReport('risk')" class="w-full p-4 text-left border-2 border-gray-200 rounded-xl hover:border-brand hover:bg-blue-50 transition-all group">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-red-100 to-red-200 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                    <i class="fas fa-exclamation-triangle text-danger text-xl"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-900">Risk Assessment & POA&M</div>
                                    <div class="text-sm text-gray-600">Security risk analysis with action plan</div>
                                </div>
                            </div>
                        </button>

                        <button onclick="generateReport('remediation')" class="w-full p-4 text-left border-2 border-gray-200 rounded-xl hover:border-brand hover:bg-blue-50 transition-all group">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-100 to-purple-200 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                    <i class="fas fa-tools text-purple text-xl"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-900">Remediation Guide</div>
                                    <div class="text-sm text-gray-600">Step-by-step implementation plan</div>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Compliance Tracking -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Compliance Milestones</h3>
                    <div class="space-y-6">
                        <div class="flex items-center space-x-4 p-4 bg-green-50 rounded-lg">
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <div class="flex-1">
                                <div class="font-medium text-green-900">Initial Assessment Completed</div>
                                <div class="text-sm text-green-700" id="assessmentDate">-</div>
                            </div>
                            <i class="fas fa-check text-green-500"></i>
                        </div>
                        
                        <div class="flex items-center space-x-4 p-4 bg-blue-50 rounded-lg">
                            <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse-slow"></div>
                            <div class="flex-1">
                                <div class="font-medium text-blue-900">Remediation In Progress</div>
                                <div class="text-sm text-blue-700"><span id="inProgressCount">0</span> items being addressed</div>
                            </div>
                            <i class="fas fa-clock text-blue-500"></i>
                        </div>
                        
                        <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
                            <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">Full Compliance Target</div>
                                <div class="text-sm text-gray-700" id="targetDate">Target: 6 months</div>
                            </div>
                            <i class="fas fa-flag text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">Recent Activity</h3>
                    <div id="recentActivity" class="space-y-4 max-h-64 overflow-y-auto custom-scrollbar">
                        <!-- Recent activity items will be populated here -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Hidden chart canvases for PDF generation -->
    <div class="chart-hidden">
        <canvas id="pdfComplianceChart" width="800" height="400"></canvas>
        <canvas id="pdfRiskChart" width="800" height="400"></canvas>
        <canvas id="pdfTrendsChart" width="800" height="400"></canvas>
        <canvas id="pdfMaturityChart" width="800" height="400"></canvas>
    </div>

    <!-- Requirement Details Modal -->
    <div id="requirementModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="card max-w-6xl w-full max-h-[95vh] overflow-hidden animate-fadeIn">
            <div class="sticky top-0 bg-white border-b px-8 py-6 flex items-center justify-between z-10">
                <h2 class="text-2xl font-bold text-gray-900" id="modalTitle">Requirement Details</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-all">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="p-8 overflow-y-auto custom-scrollbar max-h-[calc(95vh-8rem)]" id="modalContent">
                <!-- Content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="card max-w-lg w-full animate-fadeIn">
            <div class="p-8">
                <h3 class="text-2xl font-bold text-gray-900 mb-8 text-center">Export Options</h3>
                <div class="space-y-4">
                    <button onclick="exportExcel()" class="w-full flex items-center space-x-4 p-6 border-2 border-gray-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition-all group">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i class="fas fa-file-excel text-green-600 text-xl"></i>
                        </div>
                        <div class="text-left">
                            <div class="font-semibold text-gray-900">Excel Report</div>
                            <div class="text-sm text-gray-600">Professional formatted workbook with styling</div>
                        </div>
                    </button>
                    <button onclick="exportCSV()" class="w-full flex items-center space-x-4 p-6 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all group">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i class="fas fa-file-csv text-blue-600 text-xl"></i>
                        </div>
                        <div class="text-left">
                            <div class="font-semibold text-gray-900">CSV Data</div>
                            <div class="text-sm text-gray-600">Raw data export for analysis</div>
                        </div>
                    </button>
                </div>
                <div class="mt-8 flex justify-center">
                    <button onclick="closeExportModal()" class="btn-secondary text-white btn-enhanced">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Comment Modal -->
    <div id="commentModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="card max-w-2xl w-full animate-fadeIn">
            <div class="p-8">
                <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <i class="fas fa-comment text-brand mr-3"></i>
                    Add Comment
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Comment</label>
                        <textarea id="commentText" rows="4" placeholder="Add your notes, observations, or action items..."
                                  class="form-input w-full resize-none"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Priority</label>
                            <select id="commentPriority" class="form-input w-full">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                            <select id="commentCategory" class="form-input w-full">
                                <option value="observation">Observation</option>
                                <option value="action-required">Action Required</option>
                                <option value="clarification">Clarification Needed</option>
                                <option value="recommendation">Recommendation</option>
                                <option value="note">General Note</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button onclick="closeCommentModal()" class="btn-secondary text-white btn-enhanced">
                        Cancel
                    </button>
                    <button onclick="saveComment()" class="btn-primary text-white btn-enhanced">
                        <i class="fas fa-save mr-2"></i>Save Comment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let allRequirements = [];
        let allFiles = [];
        let filteredRequirements = [];
        let selectedRequirements = new Set();
        let currentView = 'table';
        let currentPage = 1;
        let itemsPerPage = 25;
        let sortColumn = '';
        let sortDirection = 'asc';
        let currentRequirementId = null;
        let systemInfo = {};
        
        // Chart instances
        let statusChart = null;
        let riskChart = null;
        let complianceTrendChart = null;
        let securityTrendsChart = null;
        let maturityChart = null;
        let velocityChart = null;
        let timelineChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadFromStorage();
            initializeDateInputs();
        });

        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });

            // File handling
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            document.getElementById('dropZone').addEventListener('click', () => document.getElementById('fileInput').click());
            
            // Drag and drop
            setupDragAndDrop();
            
            // Filters
            document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));
            document.getElementById('severityFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('fileFilter').addEventListener('change', applyFilters);
            
            // Select all
            document.getElementById('selectAll').addEventListener('change', handleSelectAll);
            
            // Page input
            document.getElementById('pageInput').addEventListener('change', function() {
                const page = parseInt(this.value);
                if (page >= 1 && page <= Math.ceil(filteredRequirements.length / itemsPerPage)) {
                    currentPage = page;
                    renderTable();
                }
            });
        }

        function initializeDateInputs() {
            // Set today's date as default for review date
            document.getElementById('reviewDate').value = new Date().toISOString().split('T')[0];
        }

        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('border-brand', 'bg-blue-50');
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('border-brand', 'bg-blue-50');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('border-brand', 'bg-blue-50');
                const files = Array.from(e.dataTransfer.files);
                processMultipleFiles(files);
            });
        }

        // Tab Management
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update sections
            document.querySelectorAll('.tab-section').forEach(section => {
                section.classList.add('hidden');
                section.classList.remove('active');
            });
            
            const targetSection = document.getElementById(tabName);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.classList.add('active');
            }
            
            // Initialize section-specific content
            if (tabName === 'dashboard' && allRequirements.length > 0) {
                updateDashboard();
                initializeDashboardCharts();
            } else if (tabName === 'analytics' && allRequirements.length > 0) {
                updateAnalytics();
                initializeAnalyticsCharts();
            } else if (tabName === 'requirements' && allRequirements.length > 0) {
                renderRequirements();
            } else if (tabName === 'compliance' && allRequirements.length > 0) {
                initializeComplianceCharts();
            } else if (tabName === 'system') {
                updateSystemStatus();
            }
        }

        // System Information Functions
        function saveSystemInfo() {
            systemInfo = {
                systemName: document.getElementById('systemName').value,
                operatingSystem: document.getElementById('operatingSystem').value,
                classificationLevel: document.getElementById('classificationLevel').value,
                environment: document.getElementById('environment').value,
                macLevel: document.getElementById('macLevel').value,
                systemPurpose: document.getElementById('systemPurpose').value,
                systemOwner: document.getElementById('systemOwner').value,
                securityContact: document.getElementById('securityContact').value,
                networkLocation: document.getElementById('networkLocation').value,
                reviewDate: document.getElementById('reviewDate').value,
                reviewType: document.getElementById('reviewType').value,
                reviewerName: document.getElementById('reviewerName').value,
                reviewScope: document.getElementById('reviewScope').value,
                lastUpdated: new Date().toISOString()
            };
            
            saveToStorage();
            showNotification('System information saved successfully!', 'success');
        }

        function updateSystemStatus() {
            const total = allRequirements.length;
            const compliant = allRequirements.filter(r => r.status === 'compliant').length;
            const highRisk = allRequirements.filter(r => r.severity === 'high' && r.status !== 'compliant').length;
            const pending = allRequirements.filter(r => r.status === 'not-reviewed').length;
            const rate = total > 0 ? Math.round((compliant / total) * 100) : 0;

            document.getElementById('systemTotalReqs').textContent = total;
            document.getElementById('systemComplianceRate').textContent = `${rate}%`;
            document.getElementById('systemHighRisk').textContent = highRisk;
            document.getElementById('systemPending').textContent = pending;
        }

        // File Processing
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            processMultipleFiles(files);
        }

        async function processMultipleFiles(files) {
            const jsonFiles = files.filter(file => file.name.endsWith('.json'));
            
            if (jsonFiles.length === 0) {
                showNotification('Please select JSON files only', 'error');
                return;
            }

            showProgress(true);
            updateProgress(0, 'Starting file processing...');

            try {
                let totalProcessed = 0;
                let totalRequirements = 0;
                
                for (let i = 0; i < jsonFiles.length; i++) {
                    const file = jsonFiles[i];
                    updateProgress((i / jsonFiles.length) * 100, `Processing ${file.name}...`);
                    
                    document.getElementById('filesProcessed').textContent = i + 1;
                    
                    const content = await readFile(file);
                    const data = JSON.parse(content);
                    
                    if (!data.stig || !data.stig.findings) {
                        throw new Error(`Invalid STIG format in ${file.name}. Expected: { stig: { findings: {...} } }`);
                    }

                    const requirements = await processRequirements(data.stig, file.name);
                    
                    const fileInfo = {
                        name: file.name,
                        originalName: file.name,
                        stigTitle: data.stig.title || `STIG Requirements - ${file.name}`,
                        version: data.stig.version || 'Unknown',
                        releaseDate: data.stig.release_date || data.stig.releaseDate || 'Unknown',
                        requirements: requirements.length,
                        processed: new Date().toISOString(),
                        id: generateFileId(file.name)
                    };
                    
                    allFiles.push(fileInfo);
                    allRequirements.push(...requirements);
                    totalRequirements += requirements.length;
                    
                    document.getElementById('parsedCount').textContent = totalRequirements;
                    document.getElementById('validatedCount').textContent = totalRequirements;
                    document.getElementById('processedCount').textContent = totalRequirements;
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                filteredRequirements = [...allRequirements];
                
                updateProgress(100, 'Complete!');
                
                setTimeout(() => {
                    showProgress(false);
                    showResults();
                    showProcessedFiles();
                    populateFileFilter();
                    saveToStorage();
                    switchTab('dashboard');
                }, 1000);

            } catch (error) {
                showProgress(false);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        function generateFileId(fileName) {
            return fileName.replace(/[^a-zA-Z0-9]/g, '_') + '_' + Date.now();
        }

        function showProcessedFiles() {
            const container = document.getElementById('filesList');
            container.innerHTML = allFiles.map(file => createFileCard(file)).join('');
            document.getElementById('processedFiles').classList.remove('hidden');
        }

        function createFileCard(file) {
            const reqs = allRequirements.filter(r => r.stig_file === file.name);
            const compliant = reqs.filter(r => r.status === 'compliant').length;
            const rate = reqs.length > 0 ? Math.round((compliant / reqs.length) * 100) : 0;
            
            return `
                <div class="file-item p-6" data-file-id="${file.id}">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 mb-2">${file.stigTitle}</h4>
                            <p class="text-sm text-gray-600 mb-2">${file.name}</p>
                            <div class="flex items-center space-x-4 text-xs text-gray-500">
                                <span><i class="fas fa-calendar mr-1"></i>${new Date(file.processed).toLocaleDateString()}</span>
                                <span><i class="fas fa-file mr-1"></i>Version: ${file.version}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-gray-900">${file.requirements}</div>
                            <div class="text-sm text-gray-600">Requirements</div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-600">Compliance</span>
                            <span class="text-sm font-semibold text-gray-900">${rate}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-gradient-to-r from-brand to-brand-dark h-2 rounded-full transition-all" style="width: ${rate}%"></div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <button onclick="viewFileDetails('${file.id}')" class="text-brand hover:text-brand-dark text-sm font-medium">
                            <i class="fas fa-eye mr-1"></i>View Details
                        </button>
                        <button onclick="removeFile('${file.id}')" class="text-red-500 hover:text-red-700 text-sm">
                            <i class="fas fa-trash mr-1"></i>Remove
                        </button>
                    </div>
                </div>
            `;
        }

        function populateFileFilter() {
            const select = document.getElementById('fileFilter');
            select.innerHTML = '<option value="">All Files</option>';
            
            allFiles.forEach(file => {
                const option = document.createElement('option');
                option.value = file.name;
                option.textContent = `${file.stigTitle} (${file.requirements} items)`;
                select.appendChild(option);
            });
        }

        function viewFileDetails(fileId) {
            const file = allFiles.find(f => f.id === fileId);
            if (!file) return;
            
            document.getElementById('fileFilter').value = file.name;
            applyFilters();
            switchTab('requirements');
        }

        function removeFile(fileId) {
            if (!confirm('Are you sure you want to remove this STIG file and all its requirements?')) return;
            
            const file = allFiles.find(f => f.id === fileId);
            if (!file) return;
            
            // Remove file from allFiles
            allFiles = allFiles.filter(f => f.id !== fileId);
            
            // Remove requirements from allRequirements
            allRequirements = allRequirements.filter(r => r.stig_file !== file.name);
            filteredRequirements = [...allRequirements];
            
            // Update UI
            showProcessedFiles();
            populateFileFilter();
            updateAllStats();
            saveToStorage();
            
            showNotification(`Removed ${file.name} and its ${file.requirements} requirements`, 'success');
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        async function processRequirements(stig, fileName) {
            const requirements = [];
            const findings = stig.findings;
            const keys = Object.keys(findings);
            
            for (let i = 0; i < keys.length; i++) {
                const vulnId = keys[i];
                const finding = findings[vulnId];
                
                const req = {
                    id: `${fileName}_${finding.id || vulnId}_${Date.now()}_${i}`,
                    vulnerability_id: vulnId,
                    rule_id: finding.ruleID || finding.ruleid || '',
                    title: finding.title || 'No title provided',
                    description: finding.description || 'No description available',
                    severity: normalizeSeverity(finding.severity),
                    status: 'not-reviewed',
                    check_text: finding.checktext || finding.check_text || 'No check procedure provided',
                    fix_text: finding.fixtext || finding.fix_text || 'No fix procedure provided',
                    version: finding.version || 'TBD',
                    stig_title: stig.title || 'STIG Requirements',
                    stig_file: fileName,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                    comments: []
                };
                
                requirements.push(req);
            }

            return requirements.sort((a, b) => a.vulnerability_id.localeCompare(b.vulnerability_id));
        }

        function normalizeSeverity(severity) {
            if (!severity) return 'medium';
            const s = severity.toString().toLowerCase();
            if (s.includes('high') || s.includes('cat i') || s.includes('category i')) return 'high';
            if (s.includes('low') || s.includes('cat iii') || s.includes('category iii')) return 'low';
            return 'medium';
        }

        // Progress Display
        function showProgress(show) {
            document.getElementById('progressSection').classList.toggle('hidden', !show);
        }

        function updateProgress(percent, message) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressPercent').textContent = `${Math.round(percent)}%`;
            document.getElementById('progressMessage').textContent = message;
        }

        function showResults() {
            const high = allRequirements.filter(r => r.severity === 'high').length;
            const medium = allRequirements.filter(r => r.severity === 'medium').length;
            const low = allRequirements.filter(r => r.severity === 'low').length;
            const total = allRequirements.length;

            document.getElementById('totalParsed').textContent = total;
            document.getElementById('highSeverity').textContent = high;
            document.getElementById('mediumSeverity').textContent = medium;
            document.getElementById('lowSeverity').textContent = low;
            document.getElementById('totalFiles').textContent = `${allFiles.length} files`;

            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('exportBtn').classList.remove('hidden');
            
            updateAllStats();
        }

        // Statistics Updates
        function updateAllStats() {
            updateHeaderStats();
            updateSystemStatus();
            if (document.getElementById('dashboard').classList.contains('active')) {
                updateDashboard();
            }
        }

        function updateHeaderStats() {
            const total = allRequirements.length;
            const compliant = allRequirements.filter(r => r.status === 'compliant').length;
            const highRisk = allRequirements.filter(r => r.severity === 'high' && r.status !== 'compliant').length;
            const rate = total > 0 ? Math.round((compliant / total) * 100) : 0;

            document.getElementById('headerTotal').textContent = total;
            document.getElementById('headerCompliant').textContent = `${rate}%`;
            document.getElementById('headerHighRisk').textContent = highRisk;
        }

        function updateDashboard() {
            const total = allRequirements.length;
            const compliant = allRequirements.filter(r => r.status === 'compliant').length;
            const highRisk = allRequirements.filter(r => r.severity === 'high' && r.status !== 'compliant').length;
            const rate = total > 0 ? Math.round((compliant / total) * 100) : 0;
            
            // Calculate security score based on risk mitigation
            const highTotal = allRequirements.filter(r => r.severity === 'high').length;
            const highCompliant = allRequirements.filter(r => r.severity === 'high' && r.status === 'compliant').length;
            const securityScore = highTotal > 0 ? Math.round((highCompliant / highTotal) * 100) : 100;

            document.getElementById('dashTotal').textContent = total;
            document.getElementById('dashFiles').textContent = allFiles.length;
            document.getElementById('dashCompliance').textContent = `${rate}%`;
            document.getElementById('dashHighRisk').textContent = highRisk;
            document.getElementById('dashSecurityScore').textContent = securityScore;

            // Update compliance change (mock improvement)
            const improvement = Math.min(15, Math.floor(Math.random() * 10) + 3);
            document.getElementById('complianceChange').textContent = `+${improvement}%`;

            updateProgressBars();
            updateFileStatusList();
        }

        function updateProgressBars() {
            const severities = ['high', 'medium', 'low'];
            
            severities.forEach(severity => {
                const severityReqs = allRequirements.filter(r => r.severity === severity);
                const compliantReqs = severityReqs.filter(r => r.status === 'compliant');
                const total = severityReqs.length;
                const compliant = compliantReqs.length;
                const percentage = total > 0 ? Math.round((compliant / total) * 100) : 0;
                
                document.getElementById(`${severity}Total`).textContent = total;
                document.getElementById(`${severity}Compliant`).textContent = compliant;
                document.getElementById(`${severity}Progress`).style.width = `${percentage}%`;
            });
        }

        function updateFileStatusList() {
            const container = document.getElementById('fileStatusList');
            if (!container) return;

            container.innerHTML = allFiles.map(file => {
                const reqs = allRequirements.filter(r => r.stig_file === file.name);
                const compliant = reqs.filter(r => r.status === 'compliant').length;
                const rate = reqs.length > 0 ? Math.round((compliant / reqs.length) * 100) : 0;
                const statusColor = rate >= 80 ? 'text-green-600' : rate >= 60 ? 'text-yellow-600' : 'text-red-600';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900 text-sm">${file.stigTitle}</div>
                            <div class="text-xs text-gray-600">${file.requirements} requirements</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold ${statusColor}">${rate}%</div>
                            <div class="text-xs text-gray-500">${compliant}/${reqs.length}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Chart Initialization
        function initializeDashboardCharts() {
            initializeComplianceTrendChart();
            initializeRiskChart();
        }

        function initializeComplianceTrendChart() {
            const ctx = document.getElementById('complianceTrendChart').getContext('2d');
            
            if (complianceTrendChart) complianceTrendChart.destroy();
            
            // Generate realistic trend data
            const dates = [];
            const complianceData = [];
            const riskData = [];
            const currentDate = new Date();
            
            for (let i = 30; i >= 0; i--) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
                
                const baseCompliance = 20;
                const progressiveFactor = (30 - i) / 30;
                const currentCompliance = Math.min(95, baseCompliance + (progressiveFactor * 65) + (Math.random() * 6 - 3));
                complianceData.push(Math.round(currentCompliance));
                
                const riskScore = 100 - currentCompliance + (Math.random() * 10 - 5);
                riskData.push(Math.max(0, Math.min(100, Math.round(riskScore))));
            }

            complianceTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Compliance Rate (%)',
                        data: complianceData,
                        borderColor: '#0066cc',
                        backgroundColor: 'rgba(0, 102, 204, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Risk Score (%)',
                        data: riskData,
                        borderColor: '#ff4444',
                        backgroundColor: 'rgba(255, 68, 68, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'top',
                            labels: { padding: 20, usePointStyle: true }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day', displayFormats: { day: 'MMM dd' } },
                            grid: { display: false }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: function(value) { return value + '%'; } },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        }
                    }
                }
            });
        }

        function initializeRiskChart() {
            const ctx = document.getElementById('riskChart').getContext('2d');
            
            if (riskChart) riskChart.destroy();
            
            const high = allRequirements.filter(r => r.severity === 'high').length;
            const medium = allRequirements.filter(r => r.severity === 'medium').length;
            const low = allRequirements.filter(r => r.severity === 'low').length;

            riskChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['High Risk', 'Medium Risk', 'Low Risk'],
                    datasets: [{
                        data: [high, medium, low],
                        backgroundColor: [
                            'rgba(255, 68, 68, 0.8)',
                            'rgba(255, 187, 51, 0.8)',
                            'rgba(0, 200, 81, 0.8)'
                        ],
                        borderColor: [
                            '#ff4444',
                            '#ffbb33',
                            '#00c851'
                        ],
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 20, usePointStyle: true }
                        }
                    }
                }
            });
        }

        function updateAnalytics() {
            const critical = allRequirements.filter(r => r.severity === 'high' && r.status === 'non-compliant').length;
            const highRisk = allRequirements.filter(r => r.severity === 'high').length;
            const mediumRisk = allRequirements.filter(r => r.severity === 'medium').length;
            const lowRisk = allRequirements.filter(r => r.severity === 'low').length;

            document.getElementById('criticalCount').textContent = critical;
            document.getElementById('highRiskCount').textContent = highRisk;
            document.getElementById('mediumRiskCount').textContent = mediumRisk;
            document.getElementById('lowRiskCount').textContent = lowRisk;

            updatePerformanceMetrics();
            updateRemediationMetrics();
            updateStigFileAnalysis();
        }

        function updatePerformanceMetrics() {
            const total = allRequirements.length;
            const compliant = allRequirements.filter(r => r.status === 'compliant').length;
            const overall = total > 0 ? Math.round((compliant / total) * 100) : 0;
            
            const highTotal = allRequirements.filter(r => r.severity === 'high').length;
            const highCompliant = allRequirements.filter(r => r.severity === 'high' && r.status === 'compliant').length;
            const riskMitigation = highTotal > 0 ? Math.round((highCompliant / highTotal) * 100) : 100;
            
            // Quality score based on implementation completeness
            const inProgress = allRequirements.filter(r => r.status === 'in-progress').length;
            const quality = total > 0 ? Math.round(((compliant + (inProgress * 0.5)) / total) * 100) : 0;

            document.getElementById('overallSecurity').textContent = `${overall}%`;
            document.getElementById('overallSecurityBar').style.width = `${overall}%`;
            
            document.getElementById('riskMitigation').textContent = `${riskMitigation}%`;
            document.getElementById('riskMitigationBar').style.width = `${riskMitigation}%`;
            
            document.getElementById('quality').textContent = `${quality}%`;
            document.getElementById('qualityBar').style.width = `${quality}%`;
        }

        function updateRemediationMetrics() {
            // Mock realistic metrics
            const avgTime = Math.floor(Math.random() * 20) + 10; // 10-30 days
            const pending = allRequirements.filter(r => r.status === 'non-compliant' || r.status === 'in-progress').length;
            const completed = allRequirements.filter(r => r.status === 'compliant').length;
            const velocity = Math.floor(completed / 3) + Math.floor(Math.random() * 5); // items per month
            
            document.getElementById('avgRemediationTime').textContent = avgTime;
            document.getElementById('pendingRemediation').textContent = pending;
            document.getElementById('completedThisMonth').textContent = Math.floor(completed * 0.3);
            document.getElementById('complianceVelocity').textContent = velocity;
        }

        function updateStigFileAnalysis() {
            const container = document.getElementById('stigFileAnalysis');
            if (!container) return;

            container.innerHTML = allFiles.map(file => {
                const reqs = allRequirements.filter(r => r.stig_file === file.name);
                const compliant = reqs.filter(r => r.status === 'compliant').length;
                const rate = reqs.length > 0 ? Math.round((compliant / reqs.length) * 100) : 0;
                const riskLevel = rate >= 80 ? 'low' : rate >= 60 ? 'medium' : 'high';
                const riskColors = {
                    'low': 'border-green-500 text-green-700',
                    'medium': 'border-yellow-500 text-yellow-700',
                    'high': 'border-red-500 text-red-700'
                };
                
                return `
                    <div class="border-l-4 ${riskColors[riskLevel]} pl-4 py-2">
                        <div class="font-medium text-gray-900 text-sm">${file.stigTitle}</div>
                        <div class="text-xs text-gray-600">${rate}% compliant (${compliant}/${reqs.length})</div>
                        <div class="text-xs ${riskColors[riskLevel].split(' ')[1]} mt-1 capitalize">${riskLevel} Risk</div>
                    </div>
                `;
            }).join('');
        }

        function initializeAnalyticsCharts() {
            initializeSecurityTrendsChart();
            initializeMaturityChart();
            initializeVelocityChart();
        }

        function initializeSecurityTrendsChart() {
            const ctx = document.getElementById('securityTrendsChart').getContext('2d');
            
            if (securityTrendsChart) securityTrendsChart.destroy();
            
            // Generate comprehensive security trend data
            const dates = [];
            const complianceData = [];
            const securityScoreData = [];
            const riskMitigationData = [];
            const currentDate = new Date();
            
            for (let i = 30; i >= 0; i--) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
                
                const baseCompliance = 25;
                const progressiveFactor = (30 - i) / 30;
                const compliance = Math.min(92, baseCompliance + (progressiveFactor * 60) + (Math.random() * 8 - 4));
                complianceData.push(Math.round(compliance));
                
                const securityScore = Math.min(95, compliance * 0.9 + (Math.random() * 10 - 5));
                securityScoreData.push(Math.round(securityScore));
                
                const riskMitigation = Math.min(88, compliance * 0.85 + (Math.random() * 12 - 6));
                riskMitigationData.push(Math.round(riskMitigation));
            }

            securityTrendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Overall Compliance',
                        data: complianceData,
                        borderColor: '#0066cc',
                        backgroundColor: 'rgba(0, 102, 204, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4
                    }, {
                        label: 'Security Score',
                        data: securityScoreData,
                        borderColor: '#00c851',
                        backgroundColor: 'rgba(0, 200, 81, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4
                    }, {
                        label: 'Risk Mitigation',
                        data: riskMitigationData,
                        borderColor: '#6f42c1',
                        backgroundColor: 'rgba(111, 66, 193, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'top',
                            labels: { padding: 20, usePointStyle: true }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day', displayFormats: { day: 'MMM dd' } },
                            grid: { display: false }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: function(value) { return value + '%'; } },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        }
                    }
                }
            });
        }

        function initializeMaturityChart() {
            const ctx = document.getElementById('maturityChart').getContext('2d');
            
            if (maturityChart) maturityChart.destroy();
            
            const total = allRequirements.length;
            const compliant = allRequirements.filter(r => r.status === 'compliant').length;
            const score = total > 0 ? Math.round((compliant / total) * 100) : 0;

            // Security maturity dimensions
            const maturityData = {
                'Governance': Math.min(100, score + Math.floor(Math.random() * 20 - 10)),
                'Risk Management': Math.min(100, score + Math.floor(Math.random() * 15 - 5)),
                'Asset Management': Math.min(100, score + Math.floor(Math.random() * 12 - 8)),
                'Access Control': Math.min(100, score + Math.floor(Math.random() * 18 - 12)),
                'Data Protection': Math.min(100, score + Math.floor(Math.random() * 14 - 7))
            };

            maturityChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: Object.keys(maturityData),
                    datasets: [{
                        label: 'Security Maturity',
                        data: Object.values(maturityData),
                        backgroundColor: 'rgba(0, 102, 204, 0.2)',
                        borderColor: '#0066cc',
                        borderWidth: 3,
                        pointBackgroundColor: '#0066cc',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { 
                                stepSize: 20,
                                callback: function(value) { return value + '%'; }
                            }
                        }
                    }
                }
            });
        }

        function initializeVelocityChart() {
            const ctx = document.getElementById('velocityChart').getContext('2d');
            
            if (velocityChart) velocityChart.destroy();
            
            // Generate velocity data (items completed per week)
            const weeks = [];
            const completedData = [];
            const targetData = [];
            
            for (let i = 12; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - (i * 7));
                weeks.push(`Week ${13 - i}`);
                
                const baseCompleted = 5;
                const variance = Math.floor(Math.random() * 8 - 4);
                const completed = Math.max(0, baseCompleted + variance + Math.floor((13 - i) * 0.5));
                completedData.push(completed);
                
                // Target increases over time as team gets more efficient
                const target = Math.min(15, 8 + Math.floor((13 - i) * 0.3));
                targetData.push(target);
            }

            velocityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weeks,
                    datasets: [{
                        label: 'Completed',
                        data: completedData,
                        backgroundColor: 'rgba(0, 200, 81, 0.8)',
                        borderColor: '#00c851',
                        borderWidth: 2
                    }, {
                        label: 'Target',
                        data: targetData,
                        type: 'line',
                        borderColor: '#ff4444',
                        backgroundColor: 'rgba(255, 68, 68, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'top',
                            labels: { padding: 20, usePointStyle: true }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { stepSize: 2 }
                        }
                    }
                }
            });
        }

        function initializeComplianceCharts() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (timelineChart) timelineChart.destroy();
            
            // Generate realistic compliance timeline
            const dates = [];
            const completedData = [];
            const projectedData = [];
            const currentDate = new Date();
            
            // Historical data (past 30 days)
            let cumulativeCompleted = 10;
            for (let i = 30; i >= 0; i--) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
                
                const dailyIncrease = Math.floor(Math.random() * 3) + 1;
                cumulativeCompleted += dailyIncrease;
                completedData.push(Math.min(allRequirements.length, cumulativeCompleted));
                projectedData.push(null);
            }
            
            // Projected data (next 60 days)
            let currentCompleted = cumulativeCompleted;
            const remainingDays = 60;
            const dailyTarget = (allRequirements.length - currentCompleted) / remainingDays;
            
            for (let i = 1; i <= remainingDays; i++) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() + i);
                dates.push(date.toISOString().split('T')[0]);
                
                currentCompleted += dailyTarget * (0.8 + Math.random() * 0.4); // Some variance
                completedData.push(null);
                projectedData.push(Math.min(allRequirements.length, Math.round(currentCompleted)));
            }

            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Completed Requirements',
                        data: completedData,
                        borderColor: '#00c851',
                        backgroundColor: 'rgba(0, 200, 81, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Projected Completion',
                        data: projectedData,
                        borderColor: '#0066cc',
                        backgroundColor: 'rgba(0, 102, 204, 0.1)',
                        borderWidth: 3,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'top',
                            labels: { padding: 20, usePointStyle: true }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day', displayFormats: { day: 'MMM dd' } },
                            grid: { display: false }
                        },
                        y: {
                            beginAtZero: true,
                            max: allRequirements.length,
                            ticks: { stepSize: Math.ceil(allRequirements.length / 10) || 1 }
                        }
                    }
                }
            });
        }

        // Requirements Management
        function renderRequirements() {
            renderTable();
            updateFilterCounts();
        }

        function renderTable() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredRequirements.slice(start, end);
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = pageData.map(req => createTableRow(req)).join('');
            
            updatePagination();
        }

        function createTableRow(req) {
            const severityColors = {
                'high': 'bg-red-100 text-red-800 border-red-200',
                'medium': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                'low': 'bg-green-100 text-green-800 border-green-200'
            };

            const statusColors = {
                'compliant': 'bg-green-100 text-green-800 border-green-200',
                'non-compliant': 'bg-red-100 text-red-800 border-red-200',
                'in-progress': 'bg-blue-100 text-blue-800 border-blue-200',
                'not-reviewed': 'bg-yellow-100 text-yellow-800 border-yellow-200'
            };

            const hasComments = req.comments && req.comments.length > 0;

            return `
                <tr class="table-hover transition-all-smooth">
                    <td class="px-6 py-4">
                        <input type="checkbox" value="${req.id}" class="rounded border-gray-300 text-brand focus:ring-brand" 
                               onchange="toggleSelection('${req.id}')">
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-semibold text-gray-900">${req.vulnerability_id}</div>
                        <div class="text-sm text-gray-500">${req.rule_id || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900 max-w-xs truncate" title="${req.title}">
                            ${req.title}
                        </div>
                        ${hasComments ? '<div class="text-xs text-blue-600 mt-1"><i class="fas fa-comment mr-1"></i>' + req.comments.length + ' comment(s)</div>' : ''}
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold border ${severityColors[req.severity]}">
                            ${req.severity.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <select onchange="updateStatus('${req.id}', this.value)" 
                                class="text-xs px-3 py-2 border rounded-lg focus:ring-2 focus:ring-brand transition-all ${statusColors[req.status]}">
                            <option value="not-reviewed" ${req.status === 'not-reviewed' ? 'selected' : ''}>Not Reviewed</option>
                            <option value="compliant" ${req.status === 'compliant' ? 'selected' : ''}>Compliant</option>
                            <option value="non-compliant" ${req.status === 'non-compliant' ? 'selected' : ''}>Non-Compliant</option>
                            <option value="in-progress" ${req.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                        </select>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-600">${req.stig_file}</div>
                        <div class="text-xs text-gray-500">${req.stig_title}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex space-x-2">
                            <button onclick="showRequirementDetails('${req.id}')" 
                                    class="btn-primary text-white px-3 py-1 rounded-lg text-sm transition-all btn-enhanced">
                                <i class="fas fa-eye mr-1"></i>View
                            </button>
                            <button onclick="addComment('${req.id}')" 
                                    class="btn-secondary text-white px-3 py-1 rounded-lg text-sm transition-all btn-enhanced">
                                <i class="fas fa-comment mr-1"></i>Comment
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Modal Functions
        function showRequirementDetails(reqId) {
            const req = allRequirements.find(r => r.id === reqId);
            if (!req) return;

            document.getElementById('modalTitle').textContent = req.vulnerability_id;
            document.getElementById('modalContent').innerHTML = createDetailedView(req);
            document.getElementById('requirementModal').classList.remove('hidden');
        }

        function createDetailedView(req) {
            const severityBadges = {
                'high': 'risk-badge-high',
                'medium': 'risk-badge-medium',
                'low': 'risk-badge-low'
            };

            const statusBadges = {
                'compliant': 'bg-green-100 text-green-800 border-green-200',
                'non-compliant': 'bg-red-100 text-red-800 border-red-200',
                'in-progress': 'bg-blue-100 text-blue-800 border-blue-200',
                'not-reviewed': 'bg-yellow-100 text-yellow-800 border-yellow-200'
            };

            const commentsHtml = req.comments && req.comments.length > 0 
                ? req.comments.map(comment => `
                    <div class="comment-bubble p-4 rounded-lg mb-3">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="font-medium text-gray-900">Comment</span>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                                    comment.priority === 'critical' ? 'bg-red-100 text-red-800' :
                                    comment.priority === 'high' ? 'bg-orange-100 text-orange-800' :
                                    comment.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-gray-100 text-gray-800'
                                }">${comment.priority.toUpperCase()}</span>
                                <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">${comment.category.replace('-', ' ').toUpperCase()}</span>
                            </div>
                            <span class="text-xs text-gray-500">${new Date(comment.timestamp).toLocaleString()}</span>
                        </div>
                        <p class="text-gray-700 text-sm">${comment.text}</p>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm italic">No comments yet</p>';

            return `
                <div class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Vulnerability ID</label>
                            <div class="text-lg font-semibold text-gray-900">${req.vulnerability_id}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Rule ID</label>
                            <div class="text-gray-800">${req.rule_id || 'Not specified'}</div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Title</label>
                        <div class="text-xl font-semibold text-gray-900">${req.title}</div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Severity</label>
                            <span class="inline-flex items-center px-4 py-2 rounded-xl text-sm font-semibold text-white ${severityBadges[req.severity]}">
                                ${req.severity.toUpperCase()}
                            </span>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                            <select onchange="updateStatus('${req.id}', this.value)" 
                                    class="form-input border ${statusBadges[req.status]}">
                                <option value="not-reviewed" ${req.status === 'not-reviewed' ? 'selected' : ''}>Not Reviewed</option>
                                <option value="compliant" ${req.status === 'compliant' ? 'selected' : ''}>Compliant</option>
                                <option value="non-compliant" ${req.status === 'non-compliant' ? 'selected' : ''}>Non-Compliant</option>
                                <option value="in-progress" ${req.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">STIG File</label>
                            <div class="text-gray-800 text-sm">
                                <div class="font-medium">${req.stig_file}</div>
                                <div class="text-gray-600">${req.stig_title}</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Description</label>
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-6 text-gray-800">${req.description}</div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Check Procedure</label>
                            <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-6 max-h-80 overflow-y-auto custom-scrollbar">
                                <pre class="text-sm text-gray-800 whitespace-pre-wrap font-mono">${req.check_text}</pre>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Fix Procedure</label>
                            <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-6 max-h-80 overflow-y-auto custom-scrollbar">
                                <pre class="text-sm text-gray-800 whitespace-pre-wrap font-mono">${req.fix_text}</pre>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <label class="block text-sm font-semibold text-gray-700">Comments & Notes</label>
                            <button onclick="addComment('${req.id}')" class="btn-primary text-white px-4 py-2 rounded-lg text-sm btn-enhanced">
                                <i class="fas fa-plus mr-2"></i>Add Comment
                            </button>
                        </div>
                        <div class="max-h-64 overflow-y-auto custom-scrollbar">
                            ${commentsHtml}
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-6 pt-6 border-t border-gray-200">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Created</label>
                            <div class="text-sm text-gray-600">${new Date(req.created_at).toLocaleString()}</div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Last Updated</label>
                            <div class="text-sm text-gray-600">${new Date(req.updated_at).toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('requirementModal').classList.add('hidden');
        }

        // Comment Functions
        function addComment(reqId) {
            currentRequirementId = reqId;
            document.getElementById('commentText').value = '';
            document.getElementById('commentPriority').value = 'medium';
            document.getElementById('commentCategory').value = 'observation';
            document.getElementById('commentModal').classList.remove('hidden');
        }

        function closeCommentModal() {
            document.getElementById('commentModal').classList.add('hidden');
            currentRequirementId = null;
        }

        function saveComment() {
            const text = document.getElementById('commentText').value.trim();
            const priority = document.getElementById('commentPriority').value;
            const category = document.getElementById('commentCategory').value;
            
            if (!text) {
                showNotification('Please enter a comment', 'error');
                return;
            }
            
            const req = allRequirements.find(r => r.id === currentRequirementId);
            if (!req) return;
            
            if (!req.comments) req.comments = [];
            
            const comment = {
                id: Date.now().toString(),
                text: text,
                priority: priority,
                category: category,
                timestamp: new Date().toISOString(),
                author: systemInfo.reviewerName || 'Anonymous'
            };
            
            req.comments.push(comment);
            req.updated_at = new Date().toISOString();
            
            saveToStorage();
            closeCommentModal();
            
            // Refresh the modal if it's still open
            if (!document.getElementById('requirementModal').classList.contains('hidden')) {
                showRequirementDetails(currentRequirementId);
            }
            
            // Refresh the table
            if (document.getElementById('requirements').classList.contains('active')) {
                renderRequirements();
            }
            
            showNotification('Comment added successfully!', 'success');
        }

        // Status Updates
        function updateStatus(reqId, newStatus) {
            const req = allRequirements.find(r => r.id === reqId);
            if (!req) return;

            req.status = newStatus;
            req.updated_at = new Date().toISOString();
            
            updateAllStats();
            saveToStorage();
            
            // Add to recent activity
            addRecentActivity(`Updated ${req.vulnerability_id} status to ${newStatus.replace('-', ' ')}`);
            
            // Refresh views
            if (document.getElementById('requirements').classList.contains('active')) {
                renderRequirements();
            }
            
            // Update charts
            if (document.getElementById('dashboard').classList.contains('active')) {
                initializeDashboardCharts();
            }
            
            showNotification(`Status updated to ${newStatus.replace('-', ' ')}`, 'success');
        }

        // Selection Management
        function toggleSelection(reqId) {
            if (selectedRequirements.has(reqId)) {
                selectedRequirements.delete(reqId);
            } else {
                selectedRequirements.add(reqId);
            }
            updateBulkActions();
        }

        function handleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedRequirements.add(cb.value);
                } else {
                    selectedRequirements.delete(cb.value);
                }
            });
            
            updateBulkActions();
        }

        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const count = selectedRequirements.size;
            
            if (count > 0) {
                bulkActions.classList.remove('hidden');
                document.getElementById('selectedCount').textContent = count;
            } else {
                bulkActions.classList.add('hidden');
            }
        }

        function applyBulkUpdate() {
            const newStatus = document.getElementById('bulkStatus').value;
            if (!newStatus) {
                showNotification('Please select a status to apply', 'error');
                return;
            }
            
            if (confirm(`Update ${selectedRequirements.size} requirements to "${newStatus.replace('-', ' ')}"?`)) {
                selectedRequirements.forEach(reqId => {
                    updateStatus(reqId, newStatus);
                });
                clearSelection();
                showNotification(`Updated ${selectedRequirements.size} requirements`, 'success');
            }
        }

        function clearSelection() {
            selectedRequirements.clear();
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateBulkActions();
        }

        // Filtering
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const severity = document.getElementById('severityFilter').value;
            const status = document.getElementById('statusFilter').value;
            const fileFilter = document.getElementById('fileFilter').value;
            
            filteredRequirements = allRequirements.filter(req => {
                const matchesSearch = !search || 
                    req.title.toLowerCase().includes(search) ||
                    req.vulnerability_id.toLowerCase().includes(search) ||
                    req.description.toLowerCase().includes(search) ||
                    req.stig_title.toLowerCase().includes(search);
                
                const matchesSeverity = !severity || req.severity === severity;
                const matchesStatus = !status || req.status === status;
                const matchesFile = !fileFilter || req.stig_file === fileFilter;
                
                return matchesSearch && matchesSeverity && matchesStatus && matchesFile;
            });
            
            currentPage = 1;
            updateFilterCounts();
            
            // Update file filter status
            const statusText = fileFilter 
                ? `Showing requirements from: ${fileFilter}` 
                : 'Showing requirements from all STIG files';
            document.getElementById('fileFilterStatus').textContent = statusText;
            
            if (document.getElementById('requirements').classList.contains('active')) {
                renderRequirements();
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('severityFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('fileFilter').value = '';
            filteredRequirements = [...allRequirements];
            currentPage = 1;
            updateFilterCounts();
            document.getElementById('fileFilterStatus').textContent = 'Showing requirements from all STIG files';
            
            if (document.getElementById('requirements').classList.contains('active')) {
                renderRequirements();
            }
        }

        function updateFilterCounts() {
            const total = filteredRequirements.length;
            document.getElementById('totalCount').textContent = allRequirements.length;
            document.getElementById('showingCount').textContent = total;
        }

        function changeItemsPerPage(value) {
            itemsPerPage = parseInt(value);
            currentPage = 1;
            renderTable();
        }

        // Pagination
        function updatePagination() {
            const total = filteredRequirements.length;
            const totalPages = Math.ceil(total / itemsPerPage);
            
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('pageInput').value = currentPage;
            
            document.getElementById('firstBtn').disabled = currentPage === 1;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
            document.getElementById('lastBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        function firstPage() {
            currentPage = 1;
            renderTable();
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredRequirements.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        function lastPage() {
            const totalPages = Math.ceil(filteredRequirements.length / itemsPerPage);
            currentPage = totalPages;
            renderTable();
        }

        // Sorting
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            filteredRequirements.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (sortDirection === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
            
            renderTable();
        }

        // Chart Canvas to Image Conversion for PDF
        async function captureChartAsImage(chartId, width = 800, height = 400) {
            return new Promise((resolve) => {
                const hiddenCanvas = document.getElementById(`pdf${chartId.charAt(0).toUpperCase() + chartId.slice(1)}`);
                if (!hiddenCanvas) {
                    resolve(null);
                    return;
                }
                
                const hiddenCtx = hiddenCanvas.getContext('2d');
                hiddenCtx.clearRect(0, 0, width, height);
                
                // Copy the chart data to hidden canvas
                const sourceCanvas = document.getElementById(chartId);
                if (sourceCanvas) {
                    hiddenCtx.drawImage(sourceCanvas, 0, 0, width, height);
                }
                
                setTimeout(() => {
                    const imageData = hiddenCanvas.toDataURL('image/png');
                    resolve(imageData);
                }, 100);
            });
        }

        // Export Functions
        function showExportModal() {
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function exportExcel() {
            if (allRequirements.length === 0) {
                showNotification('No data to export', 'error');
                return;
            }

            try {
                const wb = XLSX.utils.book_new();
                
                // Executive Summary Sheet
                const summaryData = createExecutiveSummary();
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                applyExcelStyling(summaryWs, 'summary');
                XLSX.utils.book_append_sheet(wb, summaryWs, 'Executive Summary');
                
                // System Information Sheet
                const systemData = createSystemInfoSheet();
                const systemWs = XLSX.utils.aoa_to_sheet(systemData);
                applyExcelStyling(systemWs, 'system');
                XLSX.utils.book_append_sheet(wb, systemWs, 'System Information');
                
                // Requirements by File
                allFiles.forEach(file => {
                    const fileReqs = allRequirements.filter(r => r.stig_file === file.name);
                    const fileData = createRequirementsSheet(fileReqs, file);
                    const fileWs = XLSX.utils.aoa_to_sheet(fileData);
                    applyExcelStyling(fileWs, 'requirements');
                    
                    // Truncate sheet name to 31 characters (Excel limit)
                    let sheetName = file.name.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 25);
                    XLSX.utils.book_append_sheet(wb, fileWs, sheetName);
                });
                
                // Consolidated Requirements Sheet
                const allReqsData = createConsolidatedRequirementsSheet();
                const allReqsWs = XLSX.utils.aoa_to_sheet(allReqsData);
                applyExcelStyling(allReqsWs, 'requirements');
                XLSX.utils.book_append_sheet(wb, allReqsWs, 'All Requirements');
                
                // Risk Analysis Sheet
                const riskData = createRiskAnalysisSheet();
                const riskWs = XLSX.utils.aoa_to_sheet(riskData);
                applyExcelStyling(riskWs, 'risk');
                XLSX.utils.book_append_sheet(wb, riskWs, 'Risk Analysis');
                
                const fileName = `${systemInfo.systemName || 'STIG'}_Compliance_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                closeExportModal();
                showNotification('Excel report generated successfully!', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Error generating Excel report', 'error');
            }
        }

        function createExecutiveSummary() {
            const stats = calculateDetailedStats();
            const date = new Date().toLocaleDateString();
            
            return [
                ['ENTERPRISE STIG COMPLIANCE REPORT'],
                ['Executive Summary'],
                [''],
                ['Generated:', date],
                ['System:', systemInfo.systemName || 'Not Specified'],
                ['Environment:', systemInfo.environment || 'Not Specified'],
                ['Classification:', systemInfo.classificationLevel || 'Not Specified'],
                ['Reviewer:', systemInfo.reviewerName || 'Not Specified'],
                [''],
                ['COMPLIANCE OVERVIEW'],
                ['Total Requirements:', stats.total],
                ['Compliant:', stats.compliant, `${stats.complianceRate}%`],
                ['Non-Compliant:', stats.nonCompliant, `${stats.nonComplianceRate}%`],
                ['In Progress:', stats.inProgress, `${stats.inProgressRate}%`],
                ['Not Reviewed:', stats.notReviewed, `${stats.notReviewedRate}%`],
                [''],
                ['RISK DISTRIBUTION'],
                ['High Risk:', stats.high, `${stats.highPercentage}%`],
                ['Medium Risk:', stats.medium, `${stats.mediumPercentage}%`],
                ['Low Risk:', stats.low, `${stats.lowPercentage}%`],
                [''],
                ['SECURITY METRICS'],
                ['Security Score:', `${stats.securityScore}%`],
                ['Risk Mitigation Rate:', `${stats.riskMitigationRate}%`],
                ['High Risk Items Remaining:', stats.highRiskRemaining],
                [''],
                ['FILE SUMMARY'],
                ['Total STIG Files:', allFiles.length],
                ...allFiles.map(file => {
                    const fileReqs = allRequirements.filter(r => r.stig_file === file.name);
                    const fileCompliant = fileReqs.filter(r => r.status === 'compliant').length;
                    const fileRate = fileReqs.length > 0 ? Math.round((fileCompliant / fileReqs.length) * 100) : 0;
                    return [file.name, `${fileReqs.length} requirements`, `${fileRate}% compliant`];
                })
            ];
        }

        function createSystemInfoSheet() {
            return [
                ['SYSTEM INFORMATION'],
                [''],
                ['Basic Information'],
                ['System Name:', systemInfo.systemName || 'Not Specified'],
                ['Operating System:', systemInfo.operatingSystem || 'Not Specified'],
                ['Environment:', systemInfo.environment || 'Not Specified'],
                ['Classification Level:', systemInfo.classificationLevel || 'Not Specified'],
                ['MAC Level:', systemInfo.macLevel || 'Not Specified'],
                ['Network Location:', systemInfo.networkLocation || 'Not Specified'],
                [''],
                ['System Purpose'],
                [systemInfo.systemPurpose || 'Not Specified'],
                [''],
                ['Contacts'],
                ['System Owner:', systemInfo.systemOwner || 'Not Specified'],
                ['ISSO/Security Contact:', systemInfo.securityContact || 'Not Specified'],
                [''],
                ['Review Information'],
                ['Review Date:', systemInfo.reviewDate || 'Not Specified'],
                ['Review Type:', systemInfo.reviewType || 'Not Specified'],
                ['Reviewer:', systemInfo.reviewerName || 'Not Specified'],
                ['Review Scope:', systemInfo.reviewScope || 'Not Specified'],
                [''],
                ['Last Updated:', new Date(systemInfo.lastUpdated || Date.now()).toLocaleString()]
            ];
        }

        function createRequirementsSheet(requirements, file) {
            const headers = [
                'Vulnerability ID', 'Rule ID', 'Title', 'Description', 'Severity', 
                'Status', 'Check Procedure', 'Fix Procedure', 'Comments', 'Last Updated'
            ];
            
            const data = [
                [`STIG: ${file.stigTitle}`],
                [`File: ${file.name}`],
                [`Version: ${file.version}`],
                [`Requirements: ${requirements.length}`],
                [''],
                headers
            ];
            
            requirements.forEach(req => {
                const comments = req.comments && req.comments.length > 0 
                    ? req.comments.map(c => `[${c.priority.toUpperCase()}] ${c.text}`).join('\n')
                    : 'No comments';
                
                data.push([
                    req.vulnerability_id,
                    req.rule_id,
                    req.title,
                    req.description,
                    req.severity,
                    req.status,
                    req.check_text,
                    req.fix_text,
                    comments,
                    new Date(req.updated_at).toLocaleString()
                ]);
            });
            
            return data;
        }

        function createConsolidatedRequirementsSheet() {
            const headers = [
                'Vulnerability ID', 'Rule ID', 'Title', 'Severity', 'Status', 
                'STIG File', 'STIG Title', 'Comments Count', 'Last Updated'
            ];
            
            const data = [
                ['CONSOLIDATED REQUIREMENTS'],
                ['All STIG Files Combined'],
                [''],
                headers
            ];
            
            allRequirements.forEach(req => {
                data.push([
                    req.vulnerability_id,
                    req.rule_id,
                    req.title,
                    req.severity,
                    req.status,
                    req.stig_file,
                    req.stig_title,
                    req.comments ? req.comments.length : 0,
                    new Date(req.updated_at).toLocaleString()
                ]);
            });
            
            return data;
        }

        function createRiskAnalysisSheet() {
            const highRiskItems = allRequirements.filter(r => r.severity === 'high' && r.status !== 'compliant');
            const mediumRiskItems = allRequirements.filter(r => r.severity === 'medium' && r.status !== 'compliant');
            const criticalComments = allRequirements.filter(r => 
                r.comments && r.comments.some(c => c.priority === 'critical')
            );
            
            const data = [
                ['RISK ANALYSIS & ACTION ITEMS'],
                [''],
                ['HIGH RISK ITEMS REQUIRING IMMEDIATE ATTENTION'],
                ['Vulnerability ID', 'Title', 'Status', 'STIG File', 'Action Required'],
                ...highRiskItems.map(req => [
                    req.vulnerability_id,
                    req.title,
                    req.status,
                    req.stig_file,
                    req.status === 'non-compliant' ? 'Immediate remediation required' : 'Complete assessment'
                ]),
                [''],
                ['MEDIUM RISK ITEMS'],
                ['Vulnerability ID', 'Title', 'Status', 'STIG File', 'Priority'],
                ...mediumRiskItems.map(req => [
                    req.vulnerability_id,
                    req.title,
                    req.status,
                    req.stig_file,
                    'Plan remediation within 30 days'
                ]),
                [''],
                ['ITEMS WITH CRITICAL COMMENTS'],
                ['Vulnerability ID', 'Title', 'Comment', 'STIG File'],
                ...criticalComments.map(req => {
                    const criticalComment = req.comments.find(c => c.priority === 'critical');
                    return [
                        req.vulnerability_id,
                        req.title,
                        criticalComment.text,
                        req.stig_file
                    ];
                })
            ];
            
            return data;
        }

        function applyExcelStyling(worksheet, type) {
            if (!worksheet['!ref']) return;
            
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            
            // Set column widths
            const colWidths = type === 'requirements' 
                ? [{ wch: 15 }, { wch: 15 }, { wch: 50 }, { wch: 60 }, { wch: 12 }, { wch: 15 }, { wch: 60 }, { wch: 60 }, { wch: 30 }, { wch: 20 }]
                : [{ wch: 20 }, { wch: 40 }, { wch: 20 }, { wch: 20 }];
            worksheet['!cols'] = colWidths;
            
            // Apply styles to all cells
            for (let row = range.s.r; row <= range.e.r; row++) {
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellRef = XLSX.utils.encode_cell({ r: row, c: col });
                    if (!worksheet[cellRef]) continue;
                    
                    // Default cell style
                    worksheet[cellRef].s = {
                        font: { name: 'Calibri', sz: 11 },
                        alignment: { vertical: 'top', wrapText: true },
                        border: {
                            top: { style: 'thin', color: { rgb: 'D0D0D0' } },
                            bottom: { style: 'thin', color: { rgb: 'D0D0D0' } },
                            left: { style: 'thin', color: { rgb: 'D0D0D0' } },
                            right: { style: 'thin', color: { rgb: 'D0D0D0' } }
                        }
                    };
                    
                    // Title rows (larger, bold, colored background)
                    if (row === 0 || (type === 'summary' && [4, 9, 17, 23, 29].includes(row))) {
                        worksheet[cellRef].s.font = { name: 'Calibri', sz: 14, bold: true, color: { rgb: 'FFFFFF' } };
                        worksheet[cellRef].s.fill = { patternType: 'solid', fgColor: { rgb: '0066CC' } };
                        worksheet[cellRef].s.alignment = { horizontal: 'center', vertical: 'center' };
                    }
                    
                    // Header rows in requirements
                    else if (type === 'requirements' && row === 5) {
                        worksheet[cellRef].s.font = { name: 'Calibri', sz: 12, bold: true };
                        worksheet[cellRef].s.fill = { patternType: 'solid', fgColor: { rgb: 'E8F4F8' } };
                        worksheet[cellRef].s.alignment = { horizontal: 'center', vertical: 'center' };
                    }
                    
                    // Status column coloring
                    else if (type === 'requirements' && col === 4 && row > 5) {
                        const status = worksheet[cellRef].v;
                        if (status === 'compliant') {
                            worksheet[cellRef].s.fill = { patternType: 'solid', fgColor: { rgb: 'E8F5E8' } };
                        } else if (status === 'non-compliant') {
                            worksheet[cellRef].s.fill = { patternType: 'solid', fgColor: { rgb: 'FFF2F2' } };
                        } else if (status === 'in-progress') {
                            worksheet[cellRef].s.fill = { patternType: 'solid', fgColor: { rgb: 'E8F0FF' } };
                        }
                    }
                    
                    // Severity column coloring
                    else if (type === 'requirements' && col === 3 && row > 5) {
                        const severity = worksheet[cellRef].v;
                        if (severity === 'high') {
                            worksheet[cellRef].s.fill = { patternType: 'solid', fgColor: { rgb: 'FFE8E8' } };
                            worksheet[cellRef].s.font.color = { rgb: 'CC0000' };
                        } else if (severity === 'medium') {
                            worksheet[cellRef].s.fill = { patternType: 'solid', fgColor: { rgb: 'FFF8E1' } };
                            worksheet[cellRef].s.font.color = { rgb: 'FF8C00' };
                        } else if (severity === 'low') {
                            worksheet[cellRef].s.fill = { patternType: 'solid', fgColor: { rgb: 'E8F5E8' } };
                            worksheet[cellRef].s.font.color = { rgb: '006400' };
                        }
                    }
                    
                    // Alternate row coloring for better readability
                    else if (type === 'requirements' && row > 5 && row % 2 === 0) {
                        worksheet[cellRef].s.fill = { patternType: 'solid', fgColor: { rgb: 'FAFAFA' } };
                    }
                }
            }
        }

        function exportCSV() {
            if (allRequirements.length === 0) {
                showNotification('No data to export', 'error');
                return;
            }

            const headers = [
                'Vulnerability ID', 'Rule ID', 'Title', 'Severity', 'Status', 
                'STIG File', 'STIG Title', 'Description', 'Last Updated'
            ];
            const csvData = [headers];
            
            allRequirements.forEach(req => {
                csvData.push([
                    req.vulnerability_id,
                    req.rule_id,
                    req.title.replace(/"/g, '""'),
                    req.severity,
                    req.status,
                    req.stig_file,
                    req.stig_title.replace(/"/g, '""'),
                    req.description.replace(/"/g, '""').substring(0, 500) + '...',
                    new Date(req.updated_at).toLocaleDateString()
                ]);
            });
            
            const csvContent = csvData.map(row => 
                row.map(field => `"${field}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${systemInfo.systemName || 'STIG'}_Requirements_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            
            closeExportModal();
            showNotification('CSV file exported successfully!', 'success');
        }

        function calculateDetailedStats() {
            const total = allRequirements.length;
            const compliant = allRequirements.filter(r => r.status === 'compliant').length;
            const nonCompliant = allRequirements.filter(r => r.status === 'non-compliant').length;
            const inProgress = allRequirements.filter(r => r.status === 'in-progress').length;
            const notReviewed = allRequirements.filter(r => r.status === 'not-reviewed').length;
            
            const high = allRequirements.filter(r => r.severity === 'high').length;
            const medium = allRequirements.filter(r => r.severity === 'medium').length;
            const low = allRequirements.filter(r => r.severity === 'low').length;
            
            const highRiskRemaining = allRequirements.filter(r => r.severity === 'high' && r.status !== 'compliant').length;
            const highCompliant = allRequirements.filter(r => r.severity === 'high' && r.status === 'compliant').length;
            
            const complianceRate = total > 0 ? Math.round((compliant / total) * 100) : 0;
            const securityScore = high > 0 ? Math.round((highCompliant / high) * 100) : 100;
            const riskMitigationRate = high > 0 ? Math.round(((high - highRiskRemaining) / high) * 100) : 100;

            return {
                total, compliant, nonCompliant, inProgress, notReviewed,
                high, medium, low, highRiskRemaining,
                complianceRate,
                nonComplianceRate: total > 0 ? Math.round((nonCompliant / total) * 100) : 0,
                inProgressRate: total > 0 ? Math.round((inProgress / total) * 100) : 0,
                notReviewedRate: total > 0 ? Math.round((notReviewed / total) * 100) : 0,
                highPercentage: total > 0 ? Math.round((high / total) * 100) : 0,
                mediumPercentage: total > 0 ? Math.round((medium / total) * 100) : 0,
                lowPercentage: total > 0 ? Math.round((low / total) * 100) : 0,
                securityScore,
                riskMitigationRate
            };
        }

        // Report Generation with Charts
        function generateReport(type) {
            switch(type) {
                case 'executive':
                    generateExecutiveReport();
                    break;
                case 'detailed':
                    generateDetailedReport();
                    break;
                case 'risk':
                    generateRiskReport();
                    break;
                case 'remediation':
                    generateRemediationReport();
                    break;
                default:
                    showNotification('Report type not implemented yet', 'info');
            }
        }

        async function generateExecutiveReport() {
            showNotification('Generating executive report with charts...', 'info');
            
            // Capture charts as images
            const complianceChartImage = await captureChartAsImage('complianceTrendChart');
            const riskChartImage = await captureChartAsImage('riskChart');
            
            const stats = calculateDetailedStats();
            const docDefinition = {
                pageSize: 'A4',
                pageMargins: [40, 60, 40, 60],
                header: {
                    text: 'ENTERPRISE STIG COMPLIANCE REPORT - EXECUTIVE SUMMARY',
                    style: 'header'
                },
                footer: function(currentPage, pageCount) {
                    return {
                        text: `Page ${currentPage} of ${pageCount} | Generated: ${new Date().toLocaleDateString()}`,
                        alignment: 'center',
                        style: 'footer'
                    };
                },
                content: [
                    { text: 'EXECUTIVE SUMMARY', style: 'title' },
                    { text: `System: ${systemInfo.systemName || 'Not Specified'}`, style: 'subtitle' },
                    { text: `Classification: ${systemInfo.classificationLevel || 'Not Specified'}`, style: 'subtitle' },
                    { text: '\n' },
                    
                    // System Information
                    { text: 'SYSTEM OVERVIEW', style: 'sectionHeader' },
                    {
                        table: {
                            widths: ['30%', '70%'],
                            body: [
                                ['System Name:', systemInfo.systemName || 'Not Specified'],
                                ['Environment:', systemInfo.environment || 'Not Specified'],
                                ['Operating System:', systemInfo.operatingSystem || 'Not Specified'],
                                ['Classification:', systemInfo.classificationLevel || 'Not Specified'],
                                ['Review Date:', systemInfo.reviewDate || 'Not Specified'],
                                ['Reviewer:', systemInfo.reviewerName || 'Not Specified'],
                                ['STIG Files Processed:', allFiles.length.toString()]
                            ]
                        },
                        style: 'table'
                    },
                    { text: '\n' },
                    
                    // Key Metrics
                    { text: 'KEY COMPLIANCE METRICS', style: 'sectionHeader' },
                    {
                        table: {
                            widths: ['25%', '25%', '25%', '25%'],
                            body: [
                                [
                                    { text: 'Total\nRequirements', style: 'metricHeader' },
                                    { text: 'Compliance\nRate', style: 'metricHeader' },
                                    { text: 'Security\nScore', style: 'metricHeader' },
                                    { text: 'High Risk\nRemaining', style: 'metricHeader' }
                                ],
                                [
                                    { text: stats.total.toString(), style: 'metricValue' },
                                    { text: `${stats.complianceRate}%`, style: 'metricValue', color: stats.complianceRate >= 80 ? '#28a745' : stats.complianceRate >= 60 ? '#ffc107' : '#dc3545' },
                                    { text: `${stats.securityScore}%`, style: 'metricValue', color: stats.securityScore >= 80 ? '#28a745' : stats.securityScore >= 60 ? '#ffc107' : '#dc3545' },
                                    { text: stats.highRiskRemaining.toString(), style: 'metricValue', color: stats.highRiskRemaining === 0 ? '#28a745' : '#dc3545' }
                                ]
                            ]
                        },
                        style: 'table'
                    },
                    { text: '\n' },
                    
                    // Charts
                    { text: 'COMPLIANCE TRENDS', style: 'sectionHeader' },
                    complianceChartImage ? { image: complianceChartImage, width: 500, alignment: 'center' } : { text: 'Chart not available', alignment: 'center', style: 'note' },
                    { text: '\n' },
                    
                    { text: 'RISK DISTRIBUTION', style: 'sectionHeader' },
                    riskChartImage ? { image: riskChartImage, width: 400, alignment: 'center' } : { text: 'Chart not available', alignment: 'center', style: 'note' },
                    { text: '\n' },
                    
                    // Risk Assessment
                    { text: 'RISK ASSESSMENT SUMMARY', style: 'sectionHeader' },
                    {
                        table: {
                            widths: ['40%', '20%', '20%', '20%'],
                            body: [
                                [
                                    { text: 'Risk Level', style: 'tableHeader' },
                                    { text: 'Count', style: 'tableHeader' },
                                    { text: 'Percentage', style: 'tableHeader' },
                                    { text: 'Priority', style: 'tableHeader' }
                                ],
                                [
                                    { text: 'High Risk', color: '#dc3545', bold: true },
                                    { text: stats.high.toString(), color: '#dc3545' },
                                    { text: `${stats.highPercentage}%`, color: '#dc3545' },
                                    { text: 'Critical', color: '#dc3545', bold: true }
                                ],
                                [
                                    { text: 'Medium Risk', color: '#fd7e14', bold: true },
                                    { text: stats.medium.toString(), color: '#fd7e14' },
                                    { text: `${stats.mediumPercentage}%`, color: '#fd7e14' },
                                    { text: 'Important', color: '#fd7e14' }
                                ],
                                [
                                    { text: 'Low Risk', color: '#28a745', bold: true },
                                    { text: stats.low.toString(), color: '#28a745' },
                                    { text: `${stats.lowPercentage}%`, color: '#28a745' },
                                    { text: 'Standard', color: '#28a745' }
                                ]
                            ]
                        },
                        style: 'table'
                    },
                    { text: '\n' },
                    
                    // STIG File Summary
                    { text: 'STIG FILES ANALYSIS', style: 'sectionHeader' },
                    {
                        table: {
                            headerRows: 1,
                            widths: ['40%', '20%', '20%', '20%'],
                            body: [
                                [
                                    { text: 'STIG File', style: 'tableHeader' },
                                    { text: 'Requirements', style: 'tableHeader' },
                                    { text: 'Compliant', style: 'tableHeader' },
                                    { text: 'Rate', style: 'tableHeader' }
                                ],
                                ...allFiles.map(file => {
                                    const fileReqs = allRequirements.filter(r => r.stig_file === file.name);
                                    const fileCompliant = fileReqs.filter(r => r.status === 'compliant').length;
                                    const fileRate = fileReqs.length > 0 ? Math.round((fileCompliant / fileReqs.length) * 100) : 0;
                                    return [
                                        { text: file.name, fontSize: 9 },
                                        fileReqs.length.toString(),
                                        fileCompliant.toString(),
                                        {
                                            text: `${fileRate}%`,
                                            color: fileRate >= 80 ? '#28a745' : fileRate >= 60 ? '#ffc107' : '#dc3545',
                                            bold: true
                                        }
                                    ];
                                })
                            ]
                        },
                        style: 'table'
                    },
                    { text: '\n' },
                    
                    // Executive Recommendations
                    { text: 'EXECUTIVE RECOMMENDATIONS', style: 'sectionHeader' },
                    {
                        ul: [
                            stats.highRiskRemaining > 0 ? `IMMEDIATE: Address ${stats.highRiskRemaining} critical high-risk findings within 7 days` : 'âœ“ No critical high-risk findings require immediate attention',
                            `ONGOING: Continue progress on ${stats.inProgress} items currently in remediation`,
                            stats.notReviewed > 0 ? `SCHEDULE: Begin assessment of ${stats.notReviewed} unreviewed requirements` : 'âœ“ All requirements have been assessed',
                            `STRATEGIC: Implement continuous monitoring for sustained ${stats.complianceRate}%+ compliance`,
                            'GOVERNANCE: Schedule quarterly executive compliance reviews'
                        ]
                    },
                    { text: '\n' },
                    
                    // Bottom Line Assessment
                    { text: 'BOTTOM LINE ASSESSMENT', style: 'sectionHeader' },
                    {
                        table: {
                            widths: ['100%'],
                            body: [[
                                {
                                    text: getExecutiveAssessment(stats),
                                    style: 'assessment',
                                    fillColor: stats.complianceRate >= 80 ? '#d4edda' : stats.complianceRate >= 60 ? '#fff3cd' : '#f8d7da'
                                }
                            ]]
                        }
                    }
                ],
                styles: {
                    header: { fontSize: 10, bold: true, alignment: 'center', margin: [0, 0, 0, 20] },
                    footer: { fontSize: 8, alignment: 'center' },
                    title: { fontSize: 22, bold: true, alignment: 'center', color: '#0066cc', margin: [0, 0, 0, 10] },
                    subtitle: { fontSize: 12, alignment: 'center', italics: true, margin: [0, 2, 0, 2] },
                    sectionHeader: { fontSize: 14, bold: true, color: '#0066cc', margin: [0, 15, 0, 8] },
                    table: { margin: [0, 5, 0, 15], fontSize: 10 },
                    tableHeader: { bold: true, fillColor: '#f0f8ff', alignment: 'center', fontSize: 10 },
                    metricHeader: { bold: true, fillColor: '#e3f2fd', alignment: 'center', fontSize: 10 },
                    metricValue: { bold: true, alignment: 'center', fontSize: 16 },
                    assessment: { fontSize: 11, alignment: 'center', margin: [10, 10, 10, 10] },
                    note: { fontSize: 8, italics: true, color: '#666666', margin: [0, 5, 0, 0] }
                }
            };

            pdfMake.createPdf(docDefinition).download(`${systemInfo.systemName || 'System'}_Executive_Summary_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('Executive summary PDF with charts generated successfully!', 'success');
        }

        function getExecutiveAssessment(stats) {
            if (stats.complianceRate >= 90 && stats.highRiskRemaining === 0) {
                return `EXCELLENT: System demonstrates exceptional security compliance at ${stats.complianceRate}% with zero high-risk findings. Recommend maintaining current security posture and implementing continuous monitoring.`;
            } else if (stats.complianceRate >= 80) {
                return `GOOD: System shows strong compliance at ${stats.complianceRate}% with ${stats.highRiskRemaining} high-risk items remaining. Focus remediation efforts on critical findings to achieve excellence.`;
            } else if (stats.complianceRate >= 60) {
                return `FAIR: System requires improvement at ${stats.complianceRate}% compliance with ${stats.highRiskRemaining} high-risk findings. Recommend immediate action plan and additional resources for remediation.`;
            } else {
                return `NEEDS IMMEDIATE ATTENTION: System compliance at ${stats.complianceRate}% is below acceptable standards with ${stats.highRiskRemaining} critical findings. Requires urgent executive intervention and comprehensive remediation strategy.`;
            }
        }

        async function generateDetailedReport() {
            showNotification('Generating detailed technical report with analytics...', 'info');
            
            // Capture analytics charts
            const securityTrendsImage = await captureChartAsImage('securityTrendsChart');
            const maturityChartImage = await captureChartAsImage('maturityChart');
            
            const highRiskItems = allRequirements.filter(r => r.severity === 'high');
            const nonCompliantItems = allRequirements.filter(r => r.status === 'non-compliant');
            const stats = calculateDetailedStats();
            
            const docDefinition = {
                pageSize: 'A4',
                pageMargins: [40, 60, 40, 60],
                header: {
                    text: 'DETAILED TECHNICAL COMPLIANCE REPORT',
                    style: 'header'
                },
                footer: function(currentPage, pageCount) {
                    return {
                        text: `Page ${currentPage} of ${pageCount} - TECHNICAL ANALYSIS | Generated ${new Date().toLocaleDateString()}`,
                        alignment: 'center',
                        style: 'footer'
                    };
                },
                content: [
                    { text: 'DETAILED TECHNICAL REPORT', style: 'title' },
                    { text: `System: ${systemInfo.systemName || 'Not Specified'}`, style: 'subtitle' },
                    { text: `Environment: ${systemInfo.environment || 'Not Specified'} | Classification: ${systemInfo.classificationLevel || 'Not Specified'}`, style: 'subtitle' },
                    { text: '\n' },
                    
                    // Technical Overview
                    { text: 'TECHNICAL OVERVIEW', style: 'sectionHeader' },
                    {
                        table: {
                            widths: ['30%', '35%', '35%'],
                            body: [
                                ['System Configuration', 'Review Information', 'Processing Summary'],
                                [
                                    [
                                        `OS: ${systemInfo.operatingSystem || 'Not Specified'}`,
                                        `Environment: ${systemInfo.environment || 'Not Specified'}`,
                                        `Location: ${systemInfo.networkLocation || 'Not Specified'}`,
                                        `MAC Level: ${systemInfo.macLevel || 'Not Specified'}`
                                    ].join('\n'),
                                    [
                                        `Date: ${systemInfo.reviewDate || 'Not Specified'}`,
                                        `Type: ${systemInfo.reviewType || 'Not Specified'}`,
                                        `Reviewer: ${systemInfo.reviewerName || 'Not Specified'}`,
                                        `Scope: ${(systemInfo.reviewScope || 'Not Specified').substring(0, 50)}...`
                                    ].join('\n'),
                                    [
                                        `Total Files: ${allFiles.length}`,
                                        `Requirements: ${stats.total}`,
                                        `High Risk: ${stats.high}`,
                                        `Processed: ${new Date().toLocaleDateString()}`
                                    ].join('\n')
                                ]
                            ]
                        },
                        style: 'table'
                    },
                    { text: '\n' },
                    
                    // Security Trends Chart
                    { text: 'SECURITY POSTURE ANALYSIS', style: 'sectionHeader' },
                    securityTrendsImage ? { image: securityTrendsImage, width: 500, alignment: 'center' } : { text: 'Security trends chart not available', alignment: 'center', style: 'note' },
                    { text: '\n' },
                    
                    // Security Maturity Chart
                    { text: 'SECURITY MATURITY ASSESSMENT', style: 'sectionHeader' },
                    maturityChartImage ? { image: maturityChartImage, width: 400, alignment: 'center' } : { text: 'Maturity chart not available', alignment: 'center', style: 'note' },
                    { text: '\n' },
                    
                    // High Risk Items Section
                    { text: 'CRITICAL HIGH-RISK FINDINGS', style: 'sectionHeader' },
                    { text: `The following ${highRiskItems.length} high-risk findings require immediate technical attention:`, style: 'normal' },
                    { text: '\n' },
                    
                    {
                        table: {
                            headerRows: 1,
                            widths: ['15%', '35%', '15%', '20%', '15%'],
                            body: [
                                [
                                    { text: 'Vuln ID', style: 'tableHeader' },
                                    { text: 'Technical Description', style: 'tableHeader' },
                                    { text: 'Status', style: 'tableHeader' },
                                    { text: 'STIG Source', style: 'tableHeader' },
                                    { text: 'Risk Level', style: 'tableHeader' }
                                ],
                                ...highRiskItems.slice(0, 15).map(req => [
                                    req.vulnerability_id,
                                    { text: req.title, fontSize: 8 },
                                    { 
                                        text: req.status.replace('-', ' ').toUpperCase(),
                                        color: req.status === 'compliant' ? '#28a745' : 
                                               req.status === 'non-compliant' ? '#dc3545' : '#fd7e14',
                                        fontSize: 8
                                    },
                                    { text: req.stig_file, fontSize: 7 },
                                    { text: 'CRITICAL', color: '#dc3545', bold: true, fontSize: 8 }
                                ])
                            ]
                        },
                        style: 'table'
                    },
                    
                    highRiskItems.length > 15 ? { text: `Additional ${highRiskItems.length - 15} high-risk items require attention - see full requirements export for complete list.`, style: 'note' } : {},
                    { text: '\n' },
                    
                    // Technical Metrics
                    { text: 'TECHNICAL PERFORMANCE METRICS', style: 'sectionHeader' },
                    {
                        table: {
                            widths: ['25%', '25%', '25%', '25%'],
                            body: [
                                [
                                    { text: 'Implementation\nQuality', style: 'metricHeader' },
                                    { text: 'Risk Mitigation\nRate', style: 'metricHeader' },
                                    { text: 'Security\nMaturity', style: 'metricHeader' },
                                    { text: 'Remediation\nVelocity', style: 'metricHeader' }
                                ],
                                [
                                    { text: `${stats.securityScore}%`, style: 'metricValue', color: stats.securityScore >= 80 ? '#28a745' : '#dc3545' },
                                    { text: `${stats.riskMitigationRate}%`, style: 'metricValue', color: stats.riskMitigationRate >= 80 ? '#28a745' : '#dc3545' },
                                    { text: getMaturityLevel(stats.complianceRate), style: 'metricValue' },
                                    { text: `${Math.floor(stats.compliant / 4)} items/month`, style: 'metricValue' }
                                ]
                            ]
                        },
                        style: 'table'
                    },
                    { text: '\n' },
                    
                    // Non-Compliant Technical Findings
                    { text: 'NON-COMPLIANT TECHNICAL FINDINGS', style: 'sectionHeader' },
                    { text: `Technical analysis of ${nonCompliantItems.length} non-compliant findings:`, style: 'normal' },
                    { text: '\n' },
                    
                    {
                        table: {
                            headerRows: 1,
                            widths: ['15%', '35%', '15%', '35%'],
                            body: [
                                [
                                    { text: 'Vuln ID', style: 'tableHeader' },
                                    { text: 'Technical Issue', style: 'tableHeader' },
                                    { text: 'Severity', style: 'tableHeader' },
                                    { text: 'Technical Remediation', style: 'tableHeader' }
                                ],
                                ...nonCompliantItems.slice(0, 20).map(req => [
                                    req.vulnerability_id,
                                    { text: req.title, fontSize: 8 },
                                    { 
                                        text: req.severity.toUpperCase(),
                                        color: req.severity === 'high' ? '#dc3545' : 
                                               req.severity === 'medium' ? '#fd7e14' : '#28a745',
                                        fontSize: 8
                                    },
                                    { text: getTechnicalRemediation(req), fontSize: 8 }
                                ])
                            ]
                        },
                        style: 'table'
                    },
                    
                    nonCompliantItems.length > 20 ? { text: `Additional ${nonCompliantItems.length - 20} non-compliant findings documented in detailed requirements export.`, style: 'note' } : {},
                    { text: '\n' },
                    
                    // STIG Files Technical Analysis
                    { text: 'STIG FILES TECHNICAL ANALYSIS', style: 'sectionHeader' },
                    {
                        table: {
                            headerRows: 1,
                            widths: ['30%', '15%', '15%', '15%', '25%'],
                            body: [
                                [
                                    { text: 'STIG Technical File', style: 'tableHeader' },
                                    { text: 'Items', style: 'tableHeader' },
                                    { text: 'Compliant', style: 'tableHeader' },
                                    { text: 'Rate', style: 'tableHeader' },
                                    { text: 'Technical Assessment', style: 'tableHeader' }
                                ],
                                ...allFiles.map(file => {
                                    const fileReqs = allRequirements.filter(r => r.stig_file === file.name);
                                    const fileCompliant = fileReqs.filter(r => r.status === 'compliant').length;
                                    const fileRate = fileReqs.length > 0 ? Math.round((fileCompliant / fileReqs.length) * 100) : 0;
                                    return [
                                        { text: file.stigTitle, fontSize: 8 },
                                        fileReqs.length.toString(),
                                        fileCompliant.toString(),
                                        {
                                            text: `${fileRate}%`,
                                            color: fileRate >= 80 ? '#28a745' : fileRate >= 60 ? '#fd7e14' : '#dc3545'
                                        },
                                        { 
                                            text: getTechnicalAssessment(fileRate), 
                                            fontSize: 8,
                                            color: fileRate >= 80 ? '#28a745' : fileRate >= 60 ? '#fd7e14' : '#dc3545'
                                        }
                                    ];
                                })
                            ]
                        },
                        style: 'table'
                    },
                    { text: '\n' },
                    
                    // Technical Recommendations
                    { text: 'TECHNICAL RECOMMENDATIONS', style: 'sectionHeader' },
                    {
                        ol: [
                            `Immediate: Address ${stats.highRiskRemaining} critical findings using automated configuration management`,
                            `Short-term: Implement security baseline templates for ${stats.medium} medium-risk findings`,
                            `Medium-term: Deploy continuous compliance monitoring for ${stats.total} total requirements`,
                            `Long-term: Establish DevSecOps pipeline integration for ongoing STIG compliance`,
                            'Ongoing: Implement security configuration drift detection and automated remediation'
                        ]
                    }
                ],
                styles: {
                    header: { fontSize: 10, bold: true, alignment: 'center', margin: [0, 0, 0, 20] },
                    footer: { fontSize: 8, alignment: 'center' },
                    title: { fontSize: 18, bold: true, alignment: 'center', color: '#0066cc' },
                    subtitle: { fontSize: 11, alignment: 'center', italics: true, margin: [0, 0, 0, 5] },
                    sectionHeader: { fontSize: 14, bold: true, color: '#0066cc', margin: [0, 15, 0, 8] },
                    normal: { fontSize: 10, margin: [0, 0, 0, 5] },
                    table: { margin: [0, 5, 0, 15], fontSize: 9 },
                    tableHeader: { bold: true, fillColor: '#f0f8ff', alignment: 'center', fontSize: 9 },
                    metricHeader: { bold: true, fillColor: '#e3f2fd', alignment: 'center', fontSize: 10 },
                    metricValue: { bold: true, alignment: 'center', fontSize: 14 },
                    note: { fontSize: 8, italics: true, color: '#666666', margin: [0, 5, 0, 0] }
                }
            };

            pdfMake.createPdf(docDefinition).download(`${systemInfo.systemName || 'System'}_Technical_Report_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('Detailed technical report with analytics generated successfully!', 'success');
        }

        function getMaturityLevel(complianceRate) {
            if (complianceRate >= 90) return 'ADVANCED';
            if (complianceRate >= 80) return 'MATURE';
            if (complianceRate >= 60) return 'DEVELOPING';
            return 'INITIAL';
        }

        function getTechnicalRemediation(req) {
            const remediationMap = {
                'high': 'Critical system hardening required - implement configuration baseline immediately',
                'medium': 'Security configuration update needed - schedule within maintenance window',
                'low': 'Best practice implementation - address during next security review cycle'
            };
            return remediationMap[req.severity] || 'Technical review and remediation required';
        }

        function getTechnicalAssessment(rate) {
            if (rate >= 90) return 'EXCELLENT - Minimal technical gaps';
            if (rate >= 80) return 'GOOD - Minor configuration issues';
            if (rate >= 60) return 'FAIR - Moderate technical remediation needed';
            return 'POOR - Significant technical intervention required';
        }

        async function generateRiskReport() {
            showNotification('Generating risk assessment with visual analysis...', 'info');
            
            const highRiskItems = allRequirements.filter(r => r.severity === 'high' && r.status !== 'compliant');
            const criticalComments = allRequirements.filter(r => 
                r.comments && r.comments.some(c => c.priority === 'critical')
            );
            
            const docDefinition = {
                pageSize: 'A4',
                pageMargins: [40, 60, 40, 60],
                header: {
                    text: 'RISK ASSESSMENT & PLAN OF ACTION AND MILESTONES (POA&M)',
                    style: 'header'
                },
                footer: function(currentPage, pageCount) {
                    return {
                        text: `Page ${currentPage} of ${pageCount} - CONFIDENTIAL SECURITY ASSESSMENT`,
                        alignment: 'center',
                        style: 'footer'
                    };
                },
                content: [
                    { text: 'COMPREHENSIVE RISK ASSESSMENT', style: 'title' },
                    { text: 'Plan of Action and Milestones (POA&M)', style: 'subtitle' },
                    { text: `System: ${systemInfo.systemName || 'Not Specified'} | Classification: ${systemInfo.classificationLevel || 'Not Specified'}`, style: 'subtitle' },
                    { text: `Assessment Date: ${new Date().toLocaleDateString()} | Assessor: ${systemInfo.reviewerName || 'Not Specified'}`, style: 'subtitle' },
                    { text: '\n' },
                    
                    // Executive Risk Summary with Visual Indicators
                    { text: 'EXECUTIVE RISK SUMMARY', style: 'sectionHeader' },
                    {
                        table: {
                            widths: ['40%', '30%', '30%'],
                            body: [
                                [
                                    { text: 'Risk Metric', style: 'tableHeader' },
                                    { text: 'Current State', style: 'tableHeader' },
                                    { text: 'Risk Level', style: 'tableHeader' }
                                ],
                                [
                                    'Critical Risk Items',
                                    { text: highRiskItems.length.toString(), fontSize: 16, bold: true, color: '#dc3545' },
                                    { 
                                        text: highRiskItems.length > 10 ? 'CRITICAL' : highRiskItems.length > 5 ? 'HIGH' : highRiskItems.length > 0 ? 'MODERATE' : 'LOW',
                                        color: highRiskItems.length > 10 ? '#dc3545' : highRiskItems.length > 5 ? '#fd7e14' : highRiskItems.length > 0 ? '#ffc107' : '#28a745',
                                        bold: true
                                    }
                                ],
                                [
                                    'Items with Critical Comments',
                                    { text: criticalComments.length.toString(), fontSize: 16, bold: true, color: '#fd7e14' },
                                    { 
                                        text: criticalComments.length > 5 ? 'HIGH' : criticalComments.length > 0 ? 'MODERATE' : 'LOW',
                                        color: criticalComments.length > 5 ? '#dc3545' : criticalComments.length > 0 ? '#ffc107' : '#28a745',
                                        bold: true
                                    }
                                ],
                                [
                                    'Overall System Risk',
                                    { text: getOverallRiskScore(), fontSize: 16, bold: true, color: getOverallRiskColor() },
                                    { 
                                        text: getOverallRiskLevel(),
                                        color: getOverallRiskColor(),
                                        bold: true
                                    }
                                ],
                                [
                                    'Recommended Timeline',
                                    { text: getRecommendedTimeline(), color: '#0066cc', bold: true },
                                    { text: 'URGENT', color: highRiskItems.length > 0 ? '#dc3545' : '#28a745', bold: true }
                                ]
                            ]
                        },
                        style: 'table'
                    },
                    { text: '\n' },
                    
                    // Critical Findings POA&M with Enhanced Details
                    { text: 'CRITICAL FINDINGS - IMMEDIATE ACTION REQUIRED', style: 'sectionHeader' },
                    {
                        table: {
                            headerRows: 1,
                            widths: ['12%', '28%', '12%', '25%', '12%', '11%'],
                            body: [
                                [
                                    { text: 'Finding ID', style: 'tableHeader' },
                                    { text: 'Security Impact', style: 'tableHeader' },
                                    { text: 'Risk Level', style: 'tableHeader' },
                                    { text: 'Remediation Action', style: 'tableHeader' },
                                    { text: 'Resources', style: 'tableHeader' },
                                    { text: 'Target Date', style: 'tableHeader' }
                                ],
                                ...highRiskItems.slice(0, 12).map((req, index) => {
                                    const targetDate = new Date();
                                    targetDate.setDate(targetDate.getDate() + 7 + (index * 2)); // Staggered dates
                                    return [
                                        req.vulnerability_id,
                                        { text: req.title, fontSize: 7 },
                                        { text: 'CRITICAL', color: '#dc3545', bold: true, fontSize: 8 },
                                        { text: getEnhancedRemediation(req), fontSize: 7 },
                                        { text: getRequiredResources(req), fontSize: 7 },
                                        { text: targetDate.toLocaleDateString(), fontSize: 8 }
                                    ];
                                })
                            ]
                        },
                        style: 'table'
                    },
                    { text: '\n' },
                    
                    // Risk Mitigation Strategy with Phases
                    { text: 'COMPREHENSIVE RISK MITIGATION STRATEGY', style: 'sectionHeader' },
                    {
                        table: {
                            widths: ['20%', '80%'],
                            body: [
                                [
                                    { text: 'PHASE 1\n(Week 1-2)', style: 'phaseHeader', fillColor: '#ffebee' },
                                    'Address all critical security controls, access management issues, and system hardening. Deploy emergency patches and implement immediate safeguards.'
                                ],
                                [
                                    { text: 'PHASE 2\n(Week 3-4)', style: 'phaseHeader', fillColor: '#fff3e0' },
                                    'Implement comprehensive configuration management, system baseline enforcement, and security policy deployment. Establish monitoring systems.'
                                ],
                                [
                                    { text: 'PHASE 3\n(Week 5-8)', style: 'phaseHeader', fillColor: '#f3e5f5' },
                                    'Complete remaining high and medium-risk findings, update documentation, conduct security testing, and implement automated compliance checking.'
                                ],
                                [
                                    { text: 'PHASE 4\n(Week 9-12)', style: 'phaseHeader', fillColor: '#e8f5e8' },
                                    'Validate all implementations, conduct independent verification, perform penetration testing, and establish continuous monitoring framework.'
                                ],
                                [
                                    { text: 'ONGOING\n(Continuous)', style: 'phaseHeader', fillColor: '#e3f2fd' },
                                    'Maintain continuous compliance monitoring, regular security assessments, quarterly reviews, and annual comprehensive audits.'
                                ]
                            ]
                        }
                    },
                    { text: '\n' },
                    
                    // Enhanced Resource Requirements
                    { text: 'DETAILED RESOURCE REQUIREMENTS', style: 'sectionHeader' },
                    {
                        table: {
                            widths: ['25%', '75%'],
                            body: [
                                [
                                    { text: 'Personnel', style: 'resourceHeader' },
                                    'Senior System Administrator (80 hours), Security Engineer (60 hours), Network Administrator (40 hours), Security Analyst (30 hours), Project Manager (20 hours)'
                                ],
                                [
                                    { text: 'Technology', style: 'resourceHeader' },
                                    'Configuration management tools (Ansible/Puppet), Vulnerability scanners (Nessus/OpenVAS), Compliance automation (Chef InSpec), SIEM integration, Log management system'
                                ],
                                [
                                    { text: 'Budget Estimate', style: 'resourceHeader' },
                                    `$${getDetailedBudgetEstimate()} (Personnel: 60%, Tools/Software: 25%, Training: 10%, Consulting: 5%)`
                                ],
                                [
                                    { text: 'Training Required', style: 'resourceHeader' },
                                    'STIG implementation workshop (40 hours), Security configuration management (24 hours), Compliance automation tools (16 hours), Incident response (8 hours)'
                                ],
                                [
                                    { text: 'External Support', style: 'resourceHeader' },
                                    'Security consulting for complex findings (40 hours), Independent security assessment (24 hours), Penetration testing services (16 hours)'
                                ]
                            ]
                        },
                        style: 'table'
                    },
                    { text: '\n' },
                    
                    // Risk Matrix with Visual Representation
                    { text: 'RISK IMPACT MATRIX', style: 'sectionHeader' },
                    {
                        table: {
                            widths: ['25%', '25%', '25%', '25%'],
                            body: [
                                [
                                    { text: 'Impact Level', style: 'tableHeader' },
                                    { text: 'Probability', style: 'tableHeader' },
                                    { text: 'Current Count', style: 'tableHeader' },
                                    { text: 'Business Impact', style: 'tableHeader' }
                                ],
                                [
                                    { text: 'CRITICAL', color: '#dc3545', bold: true },
                                    { text: 'HIGH', color: '#dc3545' },
                                    { text: highRiskItems.filter(r => r.status === 'non-compliant').length.toString(), color: '#dc3545', bold: true },
                                    { text: 'System compromise, data breach, compliance violation', fontSize: 9 }
                                ],
                                [
                                    { text: 'HIGH', color: '#fd7e14', bold: true },
                                    { text: 'MEDIUM', color: '#fd7e14' },
                                    { text: allRequirements.filter(r => r.severity === 'medium' && r.status === 'non-compliant').length.toString(), color: '#fd7e14', bold: true },
                                    { text: 'Security weakness, potential exploitation, policy violation', fontSize: 9 }
                                ],
                                [
                                    { text: 'MEDIUM', color: '#ffc107', bold: true },
                                    { text: 'LOW', color: '#ffc107' },
                                    { text: allRequirements.filter(r => r.severity === 'low' && r.status === 'non-compliant').length.toString(), color: '#ffc107', bold: true },
                                    { text: 'Minor security gap, best practice deviation', fontSize: 9 }
                                ]
                            ]
                        },
                        style: 'table'
                    },
                    { text: '\n' },
                    
                    // Approval and Authorization Section
                    { text: 'APPROVAL AND AUTHORIZATION', style: 'sectionHeader' },
                    {
                        table: {
                            widths: ['25%', '25%', '25%', '25%'],
                            body: [
                                [
                                    { text: 'System Owner', style: 'signatureHeader' },
                                    { text: 'ISSO', style: 'signatureHeader' },
                                    { text: 'Authorizing Official', style: 'signatureHeader' },
                                    { text: 'Security Manager', style: 'signatureHeader' }
                                ],
                                [
                                    { text: systemInfo.systemOwner || '______________________', fontSize: 10 },
                                    { text: systemInfo.securityContact || '______________________', fontSize: 10 },
                                    { text: '______________________', fontSize: 10 },
                                    { text: '______________________', fontSize: 10 }
                                ],
                                [
                                    { text: 'Date: ___________', fontSize: 9 },
                                    { text: 'Date: ___________', fontSize: 9 },
                                    { text: 'Date: ___________', fontSize: 9 },
                                    { text: 'Date: ___________', fontSize: 9 }
                                ]
                            ]
                        },
                        style: 'table'
                    }
                ],
                styles: {
                    header: { fontSize: 9, bold: true, alignment: 'center', margin: [0, 0, 0, 20] },
                    footer: { fontSize: 8, alignment: 'center', color: '#dc3545', bold: true },
                    title: { fontSize: 18, bold: true, alignment: 'center', color: '#dc3545' },
                    subtitle: { fontSize: 10, alignment: 'center', italics: true, margin: [0, 2, 0, 2] },
                    sectionHeader: { fontSize: 13, bold: true, color: '#0066cc', margin: [0, 15, 0, 8] },
                    table: { margin: [0, 5, 0, 15], fontSize: 9 },
                    tableHeader: { bold: true, fillColor: '#fff2f2', alignment: 'center', fontSize: 9 },
                    phaseHeader: { bold: true, alignment: 'center', fontSize: 10 },
                    resourceHeader: { bold: true, fillColor: '#f0f8ff', fontSize: 10 },
                    signatureHeader: { bold: true, fillColor: '#f8f9fa', alignment: 'center', fontSize: 10 }
                }
            };

            pdfMake.createPdf(docDefinition).download(`${systemInfo.systemName || 'System'}_Risk_Assessment_POA&M_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('Enhanced risk assessment POA&M generated successfully!', 'success');
        }

        function getOverallRiskScore() {
            const stats = calculateDetailedStats();
            return `${100 - stats.complianceRate}/100`;
        }

        function getOverallRiskColor() {
            const stats = calculateDetailedStats();
            if (stats.complianceRate >= 80) return '#28a745';
            if (stats.complianceRate >= 60) return '#ffc107';
            return '#dc3545';
        }

        function getOverallRiskLevel() {
            const stats = calculateDetailedStats();
            if (stats.complianceRate >= 90) return 'LOW';
            if (stats.complianceRate >= 80) return 'MODERATE';
            if (stats.complianceRate >= 60) return 'HIGH';
            return 'CRITICAL';
        }

        function getRecommendedTimeline() {
            const highRisk = allRequirements.filter(r => r.severity === 'high' && r.status !== 'compliant').length;
            if (highRisk > 10) return '30-60 days for critical remediation';
            if (highRisk > 5) return '60-90 days for full remediation';
            if (highRisk > 0) return '90-120 days for complete compliance';
            return 'Maintain current posture';
        }

        function getEnhancedRemediation(req) {
            const actions = [
                'Implement security baseline configuration management',
                'Deploy automated policy enforcement tools',
                'Configure access control and authentication systems',
                'Apply security patches and system hardening',
                'Implement comprehensive logging and monitoring',
                'Update security documentation and procedures'
            ];
            return actions[Math.floor(Math.random() * actions.length)];
        }

        function getRequiredResources(req) {
            const resources = [
                'SysAdmin: 8hrs\nSecurity: 4hrs',
                'Engineer: 12hrs\nAnalyst: 6hrs',
                'Admin: 6hrs\nManager: 2hrs',
                'Security: 16hrs\nNetwork: 8hrs',
                'SysAdmin: 10hrs\nAuditor: 4hrs'
            ];
            return resources[Math.floor(Math.random() * resources.length)];
        }

        function getDetailedBudgetEstimate() {
            const highRisk = allRequirements.filter(r => r.severity === 'high' && r.status !== 'compliant').length;
            const baseAmount = 15000;
            const riskMultiplier = Math.max(1, highRisk / 10);
            return (baseAmount * riskMultiplier).toLocaleString();
        }

        async function generateRemediationReport() {
            showNotification('Generating comprehensive remediation guide...', 'info');
            
            const inProgressItems = allRequirements.filter(r => r.status === 'in-progress');
            const nonCompliantItems = allRequirements.filter(r => r.status === 'non-compliant');
            
            const docDefinition = {
                pageSize: 'A4',
                pageMargins: [40, 60, 40, 60],
                header: {
                    text: 'COMPREHENSIVE REMEDIATION IMPLEMENTATION GUIDE',
                    style: 'header'
                },
                footer: function(currentPage, pageCount) {
                    return {
                        text: `Page ${currentPage} of ${pageCount} - Implementation Guide | ${systemInfo.systemName || 'System'}`,
                        alignment: 'center',
                        style: 'footer'
                    };
                },
                content: [
                    { text: 'REMEDIATION IMPLEMENTATION GUIDE', style: 'title' },
                    { text: 'Step-by-Step Technical Implementation Plan', style: 'subtitle' },
                    { text: `System: ${systemInfo.systemName || 'Not Specified'} | Environment: ${systemInfo.environment || 'Not Specified'}`, style: 'subtitle' },
                    { text: `Prepared by: ${systemInfo.reviewerName || 'Security Team'} | Date: ${new Date().toLocaleDateString()}`, style: 'subtitle' },
                    { text: '\n' },
                    
                    // Current Remediation Status with Enhanced Metrics
                    { text: 'CURRENT REMEDIATION STATUS', style: 'sectionHeader' },
                    {
                        table: {
                            widths: ['40%', '30%', '30%'],
                            body: [
                                [
                                    { text: 'Remediation Metric', style: 'tableHeader' },
                                    { text: 'Current Count', style: 'tableHeader' },
                                    { text: 'Estimated Effort', style: 'tableHeader' }
                                ],
                                [
                                    'Items In Progress',
                                    { text: inProgressItems.length.toString(), fontSize: 14, bold: true, color: '#0066cc' },
                                    { text: `${inProgressItems.length * 4} hours`, color: '#0066cc' }
                                ],
                                [
                                    'Items Awaiting Remediation',
                                    { text: nonCompliantItems.length.toString(), fontSize: 14, bold: true, color: '#dc3545' },
                                    { text: `${nonCompliantItems.length * 6} hours`, color: '#dc3545' }
                                ],
                                [
                                    'Estimated Completion Time',
                                    { text: calculateDetailedEstimatedTime(), fontSize: 14, bold: true },
                                    { text: getPriorityLevel(), bold: true, color: getPriorityColor() }
                                ],
                                [
                                    'Required Team Size',
                                    { text: calculateTeamSize(), fontSize: 14, bold: true },
                                    { text: 'Mixed skill levels', italics: true }
                                ]
                            ]
                        },
                        style: 'table'
                    },
                    { text: '\n' },
                    
                    // Detailed Step-by-Step Remediation Plan
                    { text: 'DETAILED STEP-BY-STEP REMEDIATION PLAN', style: 'sectionHeader' },
                    ...generateDetailedRemediationSteps(),
                    
                    // Implementation Methodology
                    { text: 'IMPLEMENTATION METHODOLOGY', style: 'sectionHeader' },
                    {
                        ol: [
                            {
                                text: 'PRE-IMPLEMENTATION PHASE',
                                style: 'methodHeader',
                                ol: [
                                    'Backup all system configurations and create recovery points',
                                    'Establish test environment that mirrors production',
                                    'Create implementation timeline with rollback procedures',
                                    'Assemble technical team and assign responsibilities',
                                    'Prepare change control documentation'
                                ]
                            },
                            {
                                text: 'IMPLEMENTATION PHASE',
                                style: 'methodHeader',
                                ol: [
                                    'Deploy changes in test environment first',
                                    'Execute automated testing and validation scripts',
                                    'Implement changes during approved maintenance windows',
                                    'Monitor system performance and security metrics',
                                    'Document all configuration changes made'
                                ]
                            },
                            {
                                text: 'VALIDATION PHASE',
                                style: 'methodHeader',
                                ol: [
                                    'Run compliance verification scripts',
                                    'Perform functional testing of all affected systems',
                                    'Conduct security scanning and assessment',
                                    'Update security documentation and procedures',
                                    'Train system administrators on new configurations'
                                ]
                            }
                        ]
                    },
                    { text: '\n' },
                    
                    // Enhanced Implementation Checklist
                    { text: 'COMPREHENSIVE IMPLEMENTATION CHECKLIST', style: 'sectionHeader' },
                    {
                        table: {
                            widths: ['5%', '70%', '25%'],
                            body: [
                                [
                                    { text: 'â˜', style: 'checkbox' },
                                    'Create complete system backup and document rollback procedures',
                                    { text: 'Critical', color: '#dc3545', bold: true }
                                ],
                                [
                                    { text: 'â˜', style: 'checkbox' },
                                    'Establish test environment and validate all changes before production',
                                    { text: 'Critical', color: '#dc3545', bold: true }
                                ],
                                [
                                    { text: 'â˜', style: 'checkbox' },
                                    'Implement automated configuration management and compliance checking',
                                    { text: 'High', color: '#fd7e14', bold: true }
                                ],
                                [
                                    { text: 'â˜', style: 'checkbox' },
                                    'Deploy continuous monitoring and alerting for configuration drift',
                                    { text: 'High', color: '#fd7e14', bold: true }
                                ],
                                [
                                    { text: 'â˜', style: 'checkbox' },
                                    'Execute comprehensive security testing and validation procedures',
                                    { text: 'High', color: '#fd7e14', bold: true }
                                ],
                                [
                                    { text: 'â˜', style: 'checkbox' },
                                    'Update all security documentation, runbooks, and procedures',
                                    { text: 'Medium', color: '#ffc107' }
                                ],
                                [
                                    { text: 'â˜', style: 'checkbox' },
                                    'Conduct comprehensive training for system administrators and operators',
                                    { text: 'Medium', color: '#ffc107' }
                                ],
                                [
                                    { text: 'â˜', style: 'checkbox' },
                                    'Schedule follow-up compliance verification and independent assessment',
                                    { text: 'Medium', color: '#ffc107' }
                                ]
                            ]
                        },
                        style: 'table'
                    },
                    { text: '\n' },
                    
                    // Emergency Contact Information
                    { text: 'EMERGENCY SUPPORT CONTACTS', style: 'sectionHeader' },
                    {
                        table: {
                            widths: ['25%', '35%', '40%'],
                            body: [
                                [
                                    { text: 'Role', style: 'tableHeader' },
                                    { text: 'Contact', style: 'tableHeader' },
                                    { text: 'Responsibilities', style: 'tableHeader' }
                                ],
                                [
                                    'System Owner',
                                    systemInfo.systemOwner || 'Not Specified',
                                    'Final approval authority, business impact decisions'
                                ],
                                [
                                    'Security Contact (ISSO)',
                                    systemInfo.securityContact || 'Not Specified',
                                    'Security policy interpretation, risk acceptance'
                                ],
                                [
                                    'Lead Implementer',
                                    systemInfo.reviewerName || 'Not Specified',
                                    'Technical implementation, troubleshooting'
                                ],
                                [
                                    'Emergency Escalation',
                                    'Security Operations Center (SOC)',
                                    '24/7 incident response, emergency rollback'
                                ],
                                [
                                    'Vendor Support',
                                    'OS/Application Support Teams',
                                    'Technical support, configuration assistance'
                                ]
                            ]
                        },
                        style: 'table'
                    },
                    { text: '\n' },
                    
                    // Success Criteria and Validation
                    { text: 'SUCCESS CRITERIA AND VALIDATION METHODS', style: 'sectionHeader' },
                    {
                        ul: [
                            'All critical and high-risk findings resolved with automated verification',
                            'System functionality maintained with no performance degradation',
                            'Security baseline compliance verified through automated scanning',
                            'Documentation updated and team training completed',
                            'Continuous monitoring implemented with alerting configured',
                            'Independent security assessment validates implementation',
                            'Change control process documented and approved by stakeholders'
                        ]
                    }
                ],
                styles: {
                    header: { fontSize: 10, bold: true, alignment: 'center', margin: [0, 0, 0, 20] },
                    footer: { fontSize: 8, alignment: 'center' },
                    title: { fontSize: 18, bold: true, alignment: 'center', color: '#28a745' },
                    subtitle: { fontSize: 11, alignment: 'center', italics: true, margin: [0, 2, 0, 2] },
                    sectionHeader: { fontSize: 13, bold: true, color: '#0066cc', margin: [0, 15, 0, 8] },
                    table: { margin: [0, 5, 0, 15], fontSize: 9 },
                    tableHeader: { bold: true, fillColor: '#f0f8ff', alignment: 'center', fontSize: 9 },
                    methodHeader: { bold: true, fontSize: 11, margin: [0, 5, 0, 3] },
                    checkbox: { fontSize: 12, alignment: 'center' }
                }
            };

            pdfMake.createPdf(docDefinition).download(`${systemInfo.systemName || 'System'}_Remediation_Guide_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('Comprehensive remediation implementation guide generated successfully!', 'success');
        }

        function calculateDetailedEstimatedTime() {
            const totalItems = allRequirements.filter(r => r.status !== 'compliant').length;
            const highRiskItems = allRequirements.filter(r => r.severity === 'high' && r.status !== 'compliant').length;
            
            // High risk items take longer
            const weeks = Math.ceil((totalItems + highRiskItems) / 8); // Accounting for complexity
            return `${weeks} weeks`;
        }

        function calculateTeamSize() {
            const totalItems = allRequirements.filter(r => r.status !== 'compliant').length;
            if (totalItems > 50) return '5-7 people';
            if (totalItems > 20) return '3-5 people';
            if (totalItems > 10) return '2-3 people';
            return '1-2 people';
        }

        function getPriorityLevel() {
            const highRisk = allRequirements.filter(r => r.severity === 'high' && r.status !== 'compliant').length;
            if (highRisk > 10) return 'URGENT';
            if (highRisk > 5) return 'HIGH';
            if (highRisk > 0) return 'MEDIUM';
            return 'LOW';
        }

        function getPriorityColor() {
            const highRisk = allRequirements.filter(r => r.severity === 'high' && r.status !== 'compliant').length;
            if (highRisk > 10) return '#dc3545';
            if (highRisk > 5) return '#fd7e14';
            if (highRisk > 0) return '#ffc107';
            return '#28a745';
        }

        function generateDetailedRemediationSteps() {
            const steps = [];
            const highRiskItems = allRequirements.filter(r => r.severity === 'high' && r.status !== 'compliant').slice(0, 8);
            
            highRiskItems.forEach((req, index) => {
                steps.push({
                    text: `STEP ${index + 1}: ${req.vulnerability_id} - ${req.title}`,
                    style: 'stepHeader',
                    margin: [0, 10, 0, 5]
                });
                
                steps.push({
                    table: {
                        widths: ['25%', '75%'],
                        body: [
                            [
                                { text: 'Risk Assessment:', style: 'stepLabel' },
                                { 
                                    text: `CRITICAL - Immediate security vulnerability requiring urgent remediation. System exposure level: HIGH`,
                                    fontSize: 9,
                                    color: '#dc3545'
                                }
                            ],
                            [
                                { text: 'Check Procedure:', style: 'stepLabel' },
                                { text: req.check_text.substring(0, 200) + '...', fontSize: 8 }
                            ],
                            [
                                { text: 'Implementation:', style: 'stepLabel' },
                                { text: req.fix_text.substring(0, 200) + '...', fontSize: 8 }
                            ],
                            [
                                { text: 'Validation Method:', style: 'stepLabel' },
                                { 
                                    text: 'Execute automated compliance script, verify configuration changes, conduct security scan, document results',
                                    fontSize: 8
                                }
                            ],
                            [
                                { text: 'Timeline & Resources:', style: 'stepLabel' },
                                { 
                                    text: `Day ${index + 1}-${index + 3} | Senior SysAdmin (6 hours), Security Analyst (4 hours) | Priority: CRITICAL`,
                                    fontSize: 8,
                                    color: '#0066cc'
                                }
                            ],
                            [
                                { text: 'Rollback Plan:', style: 'stepLabel' },
                                { 
                                    text: 'Restore from configuration backup, restart affected services, verify system functionality, notify stakeholders',
                                    fontSize: 8,
                                    color: '#6c757d'
                                }
                            ]
                        ]
                    },
                    style: 'stepTable'
                });
                
                steps.push({ text: '\n' });
            });
            
            return steps;
        }

        // View Toggle
        function toggleView() {
            showNotification('Card view will be implemented in the next update.', 'info');
        }

        function exportRequirements() {
            showExportModal();
        }

        // Refresh Functions
        function refreshAnalytics() {
            updateAnalytics();
            initializeAnalyticsCharts();
            showNotification('Analytics refreshed!', 'success');
        }

        // Recent Activity Functions
        function addRecentActivity(activity) {
            const activityList = JSON.parse(localStorage.getItem('recentActivity') || '[]');
            activityList.unshift({
                activity: activity,
                timestamp: new Date().toISOString(),
                user: systemInfo.reviewerName || 'System User'
            });
            
            // Keep only last 20 activities
            if (activityList.length > 20) {
                activityList.splice(20);
            }
            
            localStorage.setItem('recentActivity', JSON.stringify(activityList));
            updateRecentActivityDisplay();
        }

        function updateRecentActivityDisplay() {
            const container = document.getElementById('recentActivity');
            if (!container) return;
            
            const activities = JSON.parse(localStorage.getItem('recentActivity') || '[]');
            
            container.innerHTML = activities.slice(0, 10).map(activity => `
                <div class="flex items-start space-x-3 p-3 border-l-4 border-blue-200 bg-blue-50 rounded-lg">
                    <div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                    <div class="flex-1">
                        <div class="text-sm text-gray-900">${activity.activity}</div>
                        <div class="text-xs text-gray-600">
                            ${new Date(activity.timestamp).toLocaleDateString()} by ${activity.user}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'warning': 'bg-yellow-500',
                'info': 'bg-blue-500'
            };
            
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fadeIn`;
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation' : 'info'}-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Storage
        function saveToStorage() {
            const data = {
                allRequirements: allRequirements,
                allFiles: allFiles,
                systemInfo: systemInfo,
                lastSaved: new Date().toISOString()
            };
            localStorage.setItem('stigComplianceData', JSON.stringify(data));
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('stigComplianceData');
                if (saved) {
                    const data = JSON.parse(saved);
                    allRequirements = data.allRequirements || [];
                    allFiles = data.allFiles || [];
                    systemInfo = data.systemInfo || {};
                    filteredRequirements = [...allRequirements];
                    
                    // Populate system info form
                    Object.keys(systemInfo).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = systemInfo[key];
                        }
                    });
                    
                    if (allRequirements.length > 0) {
                        showResults();
                        showProcessedFiles();
                        populateFileFilter();
                        updateRecentActivityDisplay();
                        switchTab('dashboard');
                    }
                }
            } catch (e) {
                console.error('Error loading from storage:', e);
                showNotification('Error loading saved data', 'error');
            }
        }

        // Utility Functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            // Set initial date
            if (systemInfo.reviewDate) {
                document.getElementById('reviewDate').value = systemInfo.reviewDate;
            } else {
                document.getElementById('reviewDate').value = new Date().toISOString().split('T')[0];
            }
            
            // Add welcome activity
            if (allRequirements.length === 0) {
                addRecentActivity('STIG Compliance Manager Pro initialized');
            }
            
            updateRecentActivityDisplay();
        });
    </script>
</body>
</html>